---
title: "Claude-Code-Routerï¼šAI æ—¶ä»£çš„æ™ºèƒ½è·¯ç”±ä¸­æ¢"
date: "2025-08-12T22:10:00+08:00"
draft: false
tags: ["Claude-Code-Router", "LLM", "AI"]
categories: ["code_assistant"]
wordCount: 13929
readingTime: 56
---

ç›®å½•

- [1. å¼•è¨€ï¼šAI æœåŠ¡æ™ºèƒ½è·¯ç”±çš„æ–°èŒƒå¼](#1-å¼•è¨€ai-æœåŠ¡æ™ºèƒ½è·¯ç”±çš„æ–°èŒƒå¼)
- [2. Claude-Code-Router æ ¸å¿ƒæœºåˆ¶æ€»è§ˆ](#2-claude-code-router-æ ¸å¿ƒæœºåˆ¶æ€»è§ˆ)
- [3. æ™ºèƒ½è·¯ç”±å†³ç­–æœºåˆ¶è¯¦è§£](#3-æ™ºèƒ½è·¯ç”±å†³ç­–æœºåˆ¶è¯¦è§£)
- [4. è¯·æ±‚è½¬æ¢ä¸è½¬å‘æœºåˆ¶](#4-è¯·æ±‚è½¬æ¢ä¸è½¬å‘æœºåˆ¶)
- [5. é”™è¯¯å¤„ç†ä¸é™çº§ç­–ç•¥](#5-é”™è¯¯å¤„ç†ä¸é™çº§ç­–ç•¥)
- [6. æ’ä»¶ç³»ç»Ÿä¸æ‰©å±•æ€§](#6-æ’ä»¶ç³»ç»Ÿä¸æ‰©å±•æ€§)
- [7. æ€§èƒ½ä¼˜åŒ–ä¸ç›‘æ§](#7-æ€§èƒ½ä¼˜åŒ–ä¸ç›‘æ§)
- [8. æœªæ¥å±•æœ›ä¸æŠ€æœ¯æŒ‘æˆ˜](#8-æœªæ¥å±•æœ›ä¸æŠ€æœ¯æŒ‘æˆ˜)
  
Claude-Code-Router (CCR) æ˜¯ä¸€æ¬¾åˆ›æ–°çš„AIæ¨¡å‹æ™ºèƒ½è·¯ç”±å·¥å…·ï¼Œå®ƒé€šè¿‡æ‹¦æˆªClaude Code åº”ç”¨å¯¹Anthropic Claudeæ¨¡å‹çš„è¯·æ±‚ï¼Œè¿›è¡Œå¤šç»´åº¦åˆ†æï¼ˆå¦‚Tokenæ•°é‡ã€ç”¨æˆ·æŒ‡ä»¤ã€ä»»åŠ¡ç±»å‹ï¼‰ï¼Œç„¶åä¾æ®åŠ¨æ€è·¯ç”±è§„åˆ™å’Œé…ç½®ï¼Œå°†è¯·æ±‚æ™ºèƒ½åœ°å¯¼å‘æœ€åˆé€‚çš„AIæ¨¡å‹ï¼ˆæ¥è‡ªå¦‚Geminiã€DeepSeekã€æœ¬åœ°Ollamaæ¨¡å‹ç­‰ä¸åŒçš„æ¨¡å‹æœåŠ¡æä¾›å•†ï¼‰ã€‚CCRçš„æ ¸å¿ƒæœºåˆ¶åŒ…æ‹¬APIæ ¼å¼çš„è‡ªåŠ¨è½¬æ¢ä¸é€‚é…ã€åŸºäºExpress.jsçš„ä¸­é—´ä»¶æ¶æ„ã€å¼‚æ­¥è¯·æ±‚å¤„ç†ï¼Œä»¥åŠå®Œå–„çš„é”™è¯¯æ£€æµ‹ã€è‡ªåŠ¨é™çº§åˆ°å…œåº•æ¨¡å‹å’Œæ½œåœ¨çš„é‡è¯•ç­–ç•¥ï¼Œæ—¨åœ¨æå‡AIæœåŠ¡è°ƒç”¨çš„æ•ˆç‡ã€çµæ´»æ€§å’Œæˆæœ¬æ•ˆç›Šã€‚

# æ·±å…¥è§£æ Claude-Code-Routerï¼šAI æ—¶ä»£çš„æ™ºèƒ½è·¯ç”±ä¸­æ¢

## 1. å¼•è¨€ï¼šAI æœåŠ¡æ™ºèƒ½è·¯ç”±çš„æ–°èŒƒå¼

åœ¨äººå·¥æ™ºèƒ½ï¼ˆAIï¼‰æŠ€æœ¯é£é€Ÿå‘å±•çš„ä»Šå¤©ï¼Œå¤§è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰å·²æˆä¸ºæ¨åŠ¨å„è¡Œå„ä¸šå˜é©çš„æ ¸å¿ƒå¼•æ“ã€‚ç„¶è€Œï¼Œéšç€æ¨¡å‹æ•°é‡çš„æ¿€å¢ä»¥åŠå®ƒä»¬åœ¨èƒ½åŠ›ã€æ€§èƒ½å’Œæˆæœ¬ä¸Šçš„æ˜¾è‘—å·®å¼‚ï¼Œå¦‚ä½•é«˜æ•ˆã€æ™ºèƒ½åœ°ç®¡ç†å’Œè°ƒåº¦è¿™äº›æ¨¡å‹ï¼Œä»¥æœ€å¤§åŒ–å…¶ä»·å€¼å¹¶æ»¡è¶³å¤šæ ·åŒ–çš„åº”ç”¨éœ€æ±‚ï¼Œæˆä¸ºäº†ä¸€ä¸ªäºŸå¾…è§£å†³çš„å…³é”®é—®é¢˜ã€‚ä¼ ç»Ÿçš„å•ä¸€æ¨¡å‹æœåŠ¡æ¨¡å¼å·²éš¾ä»¥é€‚åº”æ—¥ç›Šå¤æ‚çš„åº”ç”¨åœºæ™¯ï¼Œå¼€å‘è€…å¸¸å¸¸éœ€è¦åœ¨ä¸åŒæ¨¡å‹çš„ API ä¹‹é—´è¿›è¡Œç¹ççš„åˆ‡æ¢å’Œé€‚é…ï¼Œè¿™ä¸ä»…å¢åŠ äº†å¼€å‘æˆæœ¬ï¼Œä¹Ÿé™åˆ¶äº†åº”ç”¨çš„æ•´ä½“æ€§èƒ½å’Œçµæ´»æ€§ã€‚æ­£æ˜¯åœ¨è¿™æ ·çš„èƒŒæ™¯ä¸‹ï¼Œ**Claude-Code-Router (CCR)** åº”è¿è€Œç”Ÿï¼Œå®ƒä»£è¡¨äº†ä¸€ç§å…¨æ–°çš„ AI æœåŠ¡æ™ºèƒ½è·¯ç”±èŒƒå¼ã€‚CCR é€šè¿‡å…¶ç²¾å¿ƒè®¾è®¡çš„æ ¸å¿ƒç®—æ³•ä¸æ¶æ„ï¼Œç‰¹åˆ«æ˜¯å…¶æ™ºèƒ½è·¯ç”±å†³ç­–æœºåˆ¶ã€è¯·æ±‚è½¬æ¢ä¸è½¬å‘ç­–ç•¥ä»¥åŠé”™è¯¯å¤„ç†ä¸é™çº§ç­–ç•¥ï¼Œä¸ºå¤šæ¨¡å‹çš„é«˜æ•ˆåä½œä¸æŒ‰éœ€è°ƒåº¦æä¾›äº†å¼ºå¤§çš„æŠ€æœ¯æ”¯æ’‘ã€‚æœ¬æ–‡å°†æ·±å…¥æ¢è®¨ CCR çš„è¿™äº›æ ¸å¿ƒæŠ€æœ¯ï¼Œæ—¨åœ¨ä¸ºèµ„æ·±æŠ€æœ¯ä¸“å®¶å’Œæ¶æ„å¸ˆæä¾›ä¸€ä¸ªå…¨é¢è€Œæ·±å…¥çš„ç†è§£ï¼Œä»¥ä¾¿æ›´å¥½åœ°è¯„ä¼°å’Œåº”ç”¨æ­¤ç±»æ™ºèƒ½è·¯ç”±è§£å†³æ–¹æ¡ˆï¼Œä»è€Œåœ¨ AI æ—¶ä»£æ„å»ºæ›´å¼ºå¤§ã€æ›´çµæ´»ã€æ›´ç»æµçš„åº”ç”¨ç³»ç»Ÿã€‚

## 2. Claude-Code-Router æ ¸å¿ƒæœºåˆ¶æ€»è§ˆ

Claude-Code-Router (CCR) çš„æ ¸å¿ƒæœºåˆ¶å›´ç»•ç€å¦‚ä½•æ™ºèƒ½åœ°æ‹¦æˆªã€åˆ†æã€è·¯ç”±ã€è½¬æ¢å’Œè½¬å‘ç”¨æˆ·è¯·æ±‚åˆ°æœ€åˆé€‚çš„ AI æ¨¡å‹ï¼Œå¹¶å°†æ¨¡å‹çš„å“åº”æœ‰æ•ˆåœ°è¿”å›ç»™ç”¨æˆ·ã€‚è¿™ä¸€è¿‡ç¨‹å¯ä»¥æ¦‚æ‹¬ä¸ºä¸€ä¸ªç²¾ç»†åŒ–çš„å¤„ç†æµæ°´çº¿ï¼Œç¡®ä¿äº†è¯·æ±‚åœ¨æ•´ä¸ªç”Ÿå‘½å‘¨æœŸä¸­å¾—åˆ°é«˜æ•ˆå’Œå‡†ç¡®çš„å¤„ç†ã€‚CCR çš„è®¾è®¡ç†å¿µåœ¨äºè§£è€¦ç”¨æˆ·è¯·æ±‚ä¸å…·ä½“æ¨¡å‹æœåŠ¡ï¼Œé€šè¿‡ä¸€ä¸ªä¸­é—´å±‚æ¥åŠ¨æ€ç®¡ç†è¯·æ±‚çš„æµå‘ï¼Œä»è€Œå®ç°æ¨¡å‹é€‰æ‹©çš„çµæ´»æ€§ã€æˆæœ¬çš„å¯æ§æ€§ä»¥åŠæœåŠ¡çš„é²æ£’æ€§ã€‚è¿™ä¸ªä¸­é—´å±‚ï¼Œå³ CCR æœ¬èº«ï¼Œæ‰®æ¼”ç€ AI æœåŠ¡æ™ºèƒ½äº¤é€šæ¢çº½çš„è§’è‰²ï¼Œæ ¹æ®å®æ—¶çš„è¯·æ±‚ç‰¹æ€§å’Œé¢„è®¾çš„ç­–ç•¥ï¼Œå°†ä»»åŠ¡åˆ†é…ç»™æœ€åŒ¹é…çš„æ¨¡å‹å®ä¾‹ã€‚

### 2.1. è¯·æ±‚æ‹¦æˆªä¸é¢„å¤„ç†

CCR çš„é¦–è¦æ­¥éª¤æ˜¯æœ‰æ•ˆåœ°æ‹¦æˆªæ¥è‡ªå®¢æˆ·ç«¯ï¼ˆä¾‹å¦‚ Claude Code å·¥å…·ï¼‰çš„ API è¯·æ±‚ã€‚è¿™æ˜¯é€šè¿‡ä¸€ç§å·§å¦™çš„ç¯å¢ƒå˜é‡åŠ«æŒæœºåˆ¶å®ç°çš„ã€‚å…·ä½“è€Œè¨€ï¼ŒCCR åˆ©ç”¨äº† Claude Code å·¥å…·æœ¬èº«æ”¯æŒé€šè¿‡ç¯å¢ƒå˜é‡ `ANTHROPIC_BASE_URL` æ¥è¦†ç›–å…¶é»˜è®¤ API ç«¯ç‚¹åœ°å€çš„ç‰¹æ€§ ã€‚é€šè¿‡è®¾ç½®æ­¤ç¯å¢ƒå˜é‡ï¼Œå¯ä»¥å°†åŸæœ¬ç›´æ¥å‘é€ç»™ Anthropic å®˜æ–¹ API çš„è¯·æ±‚ï¼Œé‡å®šå‘åˆ° CCR æœ¬åœ°è¿è¡Œçš„æœåŠ¡å™¨åœ°å€ï¼ˆä¾‹å¦‚ `http://localhost:3456` ï¼‰ã€‚è¿™ç§æ‹¦æˆªæ–¹å¼æ— éœ€ä¿®æ”¹ Claude Code å·¥å…·çš„æºä»£ç ï¼Œå®ç°äº†å¯¹è¯·æ±‚æµçš„æ— ä¾µå…¥å¼æ¥ç®¡ï¼Œæå¤§åœ°ç®€åŒ–äº†éƒ¨ç½²å’Œé›†æˆè¿‡ç¨‹ã€‚ä¸€æ—¦è¯·æ±‚è¢«æˆåŠŸæ‹¦æˆªåˆ° CCR çš„æœ¬åœ°æœåŠ¡ï¼Œé¢„å¤„ç†é˜¶æ®µéšå³å¼€å§‹ã€‚è¿™ä¸ªé˜¶æ®µä¸»è¦åŒ…æ‹¬å¯¹ä¼ å…¥è¯·æ±‚çš„åˆæ­¥æ ¡éªŒã€æ—¥å¿—è®°å½•ä»¥åŠä¸ºåç»­çš„æ™ºèƒ½è·¯ç”±å†³ç­–å‡†å¤‡å¿…è¦çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚ä¾‹å¦‚ï¼ŒCCR å¯èƒ½ä¼šæå–è¯·æ±‚å¤´ä¸­çš„å…³é”®ä¿¡æ¯ï¼Œæˆ–è€…å¯¹è¯·æ±‚ä½“è¿›è¡Œåˆæ­¥è§£æï¼Œä»¥ç¡®ä¿è¯·æ±‚çš„å®Œæ•´æ€§å’Œæœ‰æ•ˆæ€§ï¼Œå¹¶ä¸ºåç»­çš„åˆ†ææ­¥éª¤æä¾›åŸºç¡€æ•°æ®ã€‚

### 2.2. æ ¸å¿ƒå¤„ç†æµç¨‹ï¼šåˆ†æã€è·¯ç”±ã€è½¬æ¢ã€è½¬å‘ã€å“åº”

åœ¨æˆåŠŸæ‹¦æˆªå¹¶å®Œæˆé¢„å¤„ç†åï¼ŒCCR çš„æ ¸å¿ƒå¤„ç†æµç¨‹æ­£å¼å¯åŠ¨ã€‚è¿™ä¸ªæµç¨‹å¯ä»¥ç»†åŒ–ä¸ºä»¥ä¸‹å‡ ä¸ªå…³é”®é˜¶æ®µï¼Œç¡®ä¿ç”¨æˆ·è¯·æ±‚èƒ½å¤Ÿè¢«æ™ºèƒ½åœ°è·¯ç”±åˆ°æœ€åˆé€‚çš„ AI æ¨¡å‹ï¼Œå¹¶å°†æ¨¡å‹çš„å“åº”æœ‰æ•ˆåœ°è¿”å›ç»™ç”¨æˆ· ï¼š

1. **è¯·æ±‚åˆ†æ (Analysis)**ï¼šåœ¨æ­¤é˜¶æ®µï¼ŒCCR å¯¹æ‹¦æˆªåˆ°çš„è¯·æ±‚è¿›è¡Œæ·±åº¦è§£æã€‚è¿™åŒ…æ‹¬æå–ç”¨æˆ·æŒ‡ä»¤ã€åˆ†æè¯·æ±‚çš„ Token æ•°é‡ã€è¯†åˆ«è¯·æ±‚ä¸­å¯èƒ½åŒ…å«çš„ç‰¹å®šæ ‡è®°æˆ–æ¨¡å‹åç§°ç­‰ ã€‚ä¾‹å¦‚ï¼ŒCCR ä¼šæ£€æŸ¥è¯·æ±‚æ˜¯å¦æ˜ç¡®æŒ‡å®šäº†ç›®æ ‡æ¨¡å‹ï¼Œæˆ–è€…è¯·æ±‚çš„ä¸Šä¸‹æ–‡é•¿åº¦æ˜¯å¦è¶…å‡ºäº†æŸäº›æ¨¡å‹çš„å¤„ç†èƒ½åŠ›ã€‚æ­¤å¤–ï¼ŒCCR è¿˜ä¼šå…³æ³¨è¯·æ±‚ä¸­æ˜¯å¦åŒ…å«å¦‚ `thinking` è¿™æ ·çš„ç‰¹æ®Šæ ‡è®°ï¼Œè¿™å¯èƒ½æŒ‡ç¤ºè¯¥è¯·æ±‚éœ€è¦è¾ƒå¼ºçš„æ¨ç†èƒ½åŠ› ã€‚è¿™ä¸€é˜¶æ®µçš„ç›®æ ‡æ˜¯å…¨é¢ç†è§£è¯·æ±‚çš„ç‰¹æ€§å’Œéœ€æ±‚ï¼Œä¸ºåç»­çš„è·¯ç”±å†³ç­–æä¾›å……åˆ†çš„ä¾æ®ã€‚

2. **æ™ºèƒ½è·¯ç”± (Routing)**ï¼šåŸºäºè¯·æ±‚åˆ†æé˜¶æ®µæ”¶é›†åˆ°çš„ä¿¡æ¯ï¼ŒCCR çš„æ™ºèƒ½è·¯ç”±å†³ç­–æœºåˆ¶å¼€å§‹å·¥ä½œã€‚å®ƒä¼šæ ¹æ®é¢„è®¾çš„è·¯ç”±è§„åˆ™å’Œç­–ç•¥ï¼Œä»å¯ç”¨çš„æ¨¡å‹æ± ä¸­é€‰æ‹©ä¸€ä¸ªæˆ–å¤šä¸ªæœ€åˆé€‚çš„ AI æ¨¡å‹æ¥å¤„ç†å½“å‰è¯·æ±‚ã€‚è¿™äº›è§„åˆ™å¯èƒ½åŸºäºæ¨¡å‹çš„æ€§èƒ½ç‰¹ç‚¹ï¼ˆå¦‚å¤„ç†é€Ÿåº¦ã€ä¸Šä¸‹æ–‡çª—å£å¤§å°ã€ç‰¹å®šä»»åŠ¡æ“…é•¿é¢†åŸŸï¼‰ã€æˆæœ¬è€ƒé‡ï¼ˆå¦‚ä¸åŒæ¨¡å‹çš„ API è°ƒç”¨è´¹ç”¨ï¼‰ã€ä»¥åŠå½“å‰çš„ç³»ç»Ÿè´Ÿè½½æƒ…å†µã€‚ä¾‹å¦‚ï¼Œå¦‚æœä¸€ä¸ªè¯·æ±‚è¢«è¯†åˆ«ä¸ºéœ€è¦å¤„ç†è¶…é•¿ä¸Šä¸‹æ–‡ï¼ŒCCR å¯èƒ½ä¼šå°†å…¶è·¯ç”±åˆ°å¦‚ Gemini è¿™æ ·æ”¯æŒç™¾ä¸‡ Token çº§åˆ«çš„æ¨¡å‹ ã€‚å¦‚æœè¯·æ±‚åŒ…å« `haiku` æ¨¡å‹åï¼Œåˆ™å¯èƒ½è¢«å¯¼å‘å¤„ç†åå°ä»»åŠ¡çš„è½»é‡çº§æ¨¡å‹ ã€‚

3. **è¯·æ±‚è½¬æ¢ (Transformation)**ï¼šä¸€æ—¦ç›®æ ‡æ¨¡å‹è¢«é€‰å®šï¼ŒCCR éœ€è¦ç¡®ä¿è¯·æ±‚çš„æ ¼å¼ä¸ç›®æ ‡æ¨¡å‹ API æ‰€æœŸæœ›çš„æ ¼å¼å…¼å®¹ã€‚ç”±äºä¸åŒçš„ AI æ¨¡å‹æä¾›å•†ï¼ˆå¦‚ Anthropic, OpenAI, DeepSeek ç­‰ï¼‰å¯èƒ½é‡‡ç”¨ä¸åŒçš„ API æ¥å£è§„èŒƒå’Œè¯·æ±‚/å“åº”æ•°æ®ç»“æ„ï¼Œå› æ­¤è¯·æ±‚è½¬æ¢æˆä¸ºä¸€ä¸ªå¿…ä¸å¯å°‘çš„ç¯èŠ‚ã€‚CCR çš„æ ¸å¿ƒåŠŸèƒ½ä¹‹ä¸€å°±æ˜¯å®ç°ä¸€ä¸ª Express.js æœåŠ¡ï¼Œè¯¥æœåŠ¡æä¾›ä¸€ä¸ª `/v1/messages` ç«¯ç‚¹ï¼Œä¸“é—¨è´Ÿè´£å°†æ¥æ”¶åˆ°çš„ OpenAI å…¼å®¹æ ¼å¼çš„ API è¯·æ±‚ï¼Œè½¬æ¢ä¸ºç›®æ ‡æ¨¡å‹ï¼ˆä¾‹å¦‚ Anthropic æ¨¡å‹ï¼‰æ‰€è¦æ±‚çš„æ ¼å¼ ã€‚è¿™ä¸ªè¿‡ç¨‹å¯èƒ½æ¶‰åŠåˆ°è¯·æ±‚ä½“ä¸­å­—æ®µçš„æ˜ å°„ã€é‡ç»„ï¼Œä»¥åŠå¿…è¦çš„å‚æ•°è°ƒæ•´ã€‚

4. **è¯·æ±‚è½¬å‘ (Forwarding)**ï¼šåœ¨å®Œæˆè¯·æ±‚æ ¼å¼è½¬æ¢åï¼ŒCCR ä¼šå°†ä¿®æ”¹åçš„è¯·æ±‚è½¬å‘ç»™é€‰å®šçš„ç›®æ ‡æ¨¡å‹ API ç«¯ç‚¹ã€‚è¿™ä¸ªè½¬å‘è¿‡ç¨‹é€šå¸¸æ˜¯å¼‚æ­¥çš„ï¼Œä»¥ç¡®ä¿ CCR æœ¬èº«ä¸ä¼šè¢«é˜»å¡ï¼Œèƒ½å¤Ÿç»§ç»­å¤„ç†å…¶ä»–ä¼ å…¥çš„è¯·æ±‚ã€‚CCR ä¼šç»´æŠ¤ä¸å„ä¸ªæ¨¡å‹ API çš„è¿æ¥ï¼Œå¹¶è´Ÿè´£ç®¡ç†è¿™äº›è¿æ¥çš„ç”Ÿå‘½å‘¨æœŸï¼ŒåŒ…æ‹¬è¶…æ—¶è®¾ç½®ã€é‡è¯•é€»è¾‘ç­‰ã€‚

5. **å“åº”å¤„ç†ä¸è¿”å› (Response Handling and Returning)**ï¼šå½“ç›®æ ‡æ¨¡å‹å¤„ç†å®Œè¯·æ±‚å¹¶è¿”å›ç»“æœåï¼ŒCCR ä¼šæ¥æ”¶åˆ°æ¨¡å‹çš„åŸå§‹å“åº”ã€‚ä¸è¯·æ±‚è½¬æ¢ç±»ä¼¼ï¼ŒCCR å¯èƒ½è¿˜éœ€è¦å¯¹æ¨¡å‹çš„å“åº”è¿›è¡Œæ ¼å¼è½¬æ¢ï¼Œä½¿å…¶ä¸å®¢æˆ·ç«¯æœ€åˆæœŸæœ›çš„å“åº”æ ¼å¼ï¼ˆä¾‹å¦‚ OpenAI æ ¼å¼ï¼‰ä¿æŒä¸€è‡´ã€‚æ­¤å¤–ï¼ŒCCR è¿˜ä¼šåœ¨æ­¤é˜¶æ®µè¿›è¡Œé”™è¯¯å¤„ç†ï¼Œä¾‹å¦‚æ£€æŸ¥æ¨¡å‹ API è¿”å›çš„é”™è¯¯ç ï¼Œå¹¶æ ¹æ®é¢„è®¾çš„é”™è¯¯å¤„ç†ç­–ç•¥é‡‡å–ç›¸åº”æªæ–½ã€‚æœ€ç»ˆï¼Œç»è¿‡å¤„ç†çš„å“åº”ä¼šè¢«è¿”å›ç»™åŸå§‹çš„å®¢æˆ·ç«¯ï¼Œå®Œæˆæ•´ä¸ªè¯·æ±‚-å“åº”å¾ªç¯ã€‚

æ­¤å¤–ï¼ŒCCR è¿˜è®¾è®¡äº†ä¸€ä¸ªâ€œæ’ä»¶ç³»ç»Ÿâ€ï¼Œå…è®¸å¼€å‘è€…åœ¨è¯·æ±‚è½¬å‘å‰æˆ–å“åº”è¿”å›åä»‹å…¥å¤„ç†æµç¨‹ï¼Œå¯¹è¯·æ±‚æˆ–å“åº”å†…å®¹è¿›è¡Œè‡ªå®šä¹‰çš„ä¿®æ”¹æˆ–å¢å¼ºï¼Œè¿™ä¸º CCR æä¾›äº†é«˜åº¦çš„çµæ´»æ€§å’Œå¯æ‰©å±•æ€§ ã€‚æ•´ä¸ªæµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

```mermaid
graph TD
    A[ä½ çš„è¯·æ±‚] --> B{CCRæ‹¦æˆªåˆ†æ};
    B --> C[Tokenè®¡æ•°/å†…å®¹è¯†åˆ«];
    C --> D{æ™ºèƒ½è·¯ç”±å†³ç­–};
    D --> E[è¯·æ±‚ä½“è‡ªåŠ¨è½¬æ¢];
    E --> F[ç›®æ ‡æ¨¡å‹API];
    F --> G[å“åº”æ ¼å¼å½’ä¸€];
    G --> H[è¿”å›Claudeå…¼å®¹ç»“æœ];
    subgraph æ’ä»¶ç³»ç»Ÿ
        direction LR
        P1[è¯·æ±‚å‰æ’ä»¶] -->|é­”æ”¹è¯·æ±‚| P2[å“åº”åæ’ä»¶];
    end
    B -.-> æ’ä»¶ç³»ç»Ÿ;
    G -.-> æ’ä»¶ç³»ç»Ÿ;
```

*CCR æ ¸å¿ƒå¤„ç†æµç¨‹åŠæ’ä»¶ç³»ç»Ÿç¤ºæ„å›¾*

é€šè¿‡è¿™ä¸€ç³»åˆ—ç²¾å¿ƒè®¾è®¡çš„å¤„ç†é˜¶æ®µï¼ŒCCR å®ç°äº†å¯¹ AI æ¨¡å‹è¯·æ±‚çš„æ™ºèƒ½è°ƒåº¦å’Œç®¡ç†ï¼Œä¸ºç”¨æˆ·æä¾›äº†ä¸€ä¸ªç»Ÿä¸€ã€çµæ´»ä¸”é«˜æ•ˆçš„ AI æœåŠ¡æ¥å…¥ç‚¹ã€‚

## 3. æ™ºèƒ½è·¯ç”±å†³ç­–æœºåˆ¶è¯¦è§£

Claude-Code-Router (CCR) çš„æ™ºèƒ½è·¯ç”±å†³ç­–æœºåˆ¶æ˜¯å…¶æ ¸å¿ƒä»·å€¼æ‰€åœ¨ï¼Œå®ƒä½¿å¾—ç³»ç»Ÿèƒ½å¤Ÿæ ¹æ®å¤šç§å› ç´ åŠ¨æ€é€‰æ‹©æœ€åˆé€‚çš„ AI æ¨¡å‹æ¥å¤„ç†ç”¨æˆ·è¯·æ±‚ã€‚è¿™ä¸€æœºåˆ¶ä¸ä»…ä»…æ˜¯ä¸€ä¸ªç®€å•çš„è´Ÿè½½å‡è¡¡å™¨ï¼Œæ›´æ˜¯ä¸€ä¸ªå…·å¤‡ä¸€å®šâ€œæ™ºæ…§â€çš„è°ƒåº¦ç³»ç»Ÿã€‚å®ƒç»¼åˆè€ƒè™‘äº†ç”¨æˆ·æ„å›¾ã€è¯·æ±‚ç‰¹æ€§ã€æ¨¡å‹èƒ½åŠ›ä»¥åŠé¢„è®¾çš„ä¼˜åŒ–ç›®æ ‡ï¼ˆå¦‚æˆæœ¬ã€é€Ÿåº¦ã€æ•ˆæœï¼‰ã€‚é€šè¿‡ç²¾ç»†åŒ–çš„è·¯ç”±ç­–ç•¥ï¼ŒCCR æ—¨åœ¨æ‰“ç ´å•ä¸€æ¨¡å‹åœ¨å¤„ç†æ‰€æœ‰ç±»å‹ä»»åŠ¡æ—¶çš„å±€é™æ€§ï¼Œå……åˆ†å‘æŒ¥ä¸åŒæ¨¡å‹çš„ä¼˜åŠ¿ï¼Œä»è€Œä¸ºç”¨æˆ·æä¾›æ›´ä¼˜çš„ AI æœåŠ¡ä½“éªŒã€‚ä¾‹å¦‚ï¼Œå¯¹äºéœ€è¦æ·±åº¦æ¨ç†çš„å¤æ‚ä»»åŠ¡ï¼ŒCCR å¯èƒ½ä¼šå°†å…¶å¯¼å‘èƒ½åŠ›æ›´å¼ºä½†æˆæœ¬ä¹Ÿå¯èƒ½æ›´é«˜çš„æ¨¡å‹ï¼›è€Œå¯¹äºç®€å•çš„èƒŒæ™¯ä»»åŠ¡æˆ–å¯¹æˆæœ¬æ•æ„Ÿçš„åœºæ™¯ï¼Œåˆ™å¯ä»¥é€‰æ‹©æ€§ä»·æ¯”æ›´é«˜çš„æ¨¡å‹ã€‚è¿™ç§ç²¾ç»†åŒ–çš„è°ƒåº¦èƒ½åŠ›ï¼Œä½¿å¾— AI èµ„æºçš„åˆ©ç”¨æ›´åŠ é«˜æ•ˆå’Œåˆç†ã€‚

### 3.1. å¤šç»´åº¦è¯·æ±‚åˆ†æ

Claude-Code-Router (CCR) çš„æ™ºèƒ½è·¯ç”±å†³ç­–å§‹äºå¯¹ç”¨æˆ·è¯·æ±‚çš„å¤šç»´åº¦åˆ†æã€‚è¿™ä¸ªåˆ†æé˜¶æ®µçš„ç›®æ ‡æ˜¯å…¨é¢ç†è§£è¯·æ±‚çš„å±æ€§å’Œéœ€æ±‚ï¼Œä¸ºåç»­çš„è·¯ç”±é€‰æ‹©æä¾›ç²¾ç¡®çš„è¾“å…¥ã€‚CCR ä¸»è¦ä»ä»¥ä¸‹å‡ ä¸ªæ–¹é¢å¯¹è¯·æ±‚è¿›è¡Œå‰–æï¼š

1. **Token æ•°é‡åˆ†æ**ï¼šè¿™æ˜¯ CCR è¿›è¡Œè¯·æ±‚åˆ†ç±»å’Œè·¯ç”±å†³ç­–çš„å…³é”®ä¾æ®ä¹‹ä¸€ã€‚CCR ä¼šä½¿ç”¨å¦‚ `tiktoken` è¿™æ ·çš„å·¥å…·æ¥ç²¾ç¡®è®¡ç®—æ¯æ¬¡è¯·æ±‚æ¶ˆè€—çš„ Token æ€»æ•° ã€‚è¿™ä¸ªæ€»æ•°ä¸ä»…åŒ…æ‹¬ç”¨æˆ·ç›´æ¥è¾“å…¥çš„æ¶ˆæ¯å†…å®¹ï¼Œè¿˜æ¶µç›–äº†ç³»ç»Ÿæç¤ºï¼ˆSystem Promptï¼‰ã€å·¥å…·å®šä¹‰ï¼ˆTool Definitionsï¼‰ã€å‡½æ•°è°ƒç”¨ï¼ˆFunction Callsï¼‰ç­‰æ‰€æœ‰åœ¨ API äº¤äº’ä¸­ä¼šè®¡å…¥ Token æ¶ˆè€—çš„éƒ¨åˆ† ã€‚é€šè¿‡ç²¾ç¡®çš„ Token è®¡æ•°ï¼ŒCCR èƒ½å¤Ÿåˆ¤æ–­è¯·æ±‚çš„è§„æ¨¡ï¼Œä¾‹å¦‚æ˜¯å±äºçŸ­å¯¹è¯ã€ä¸­ç­‰é•¿åº¦çš„æ–‡æ¡£å¤„ç†ï¼Œè¿˜æ˜¯è¶…é•¿ä¸Šä¸‹æ–‡çš„å¤æ‚ä»»åŠ¡ã€‚ä¾‹å¦‚ï¼Œå¦‚æœ Token æ•°é‡è¶…è¿‡ 60,000ï¼ŒCCR ä¼šå°†å…¶è¯†åˆ«ä¸ºè¶…é•¿ä¸Šä¸‹æ–‡ä»»åŠ¡ï¼Œä»è€Œå¯èƒ½å°†å…¶è·¯ç”±åˆ°ä¸“é—¨ä¸ºæ­¤ä¼˜åŒ–çš„æ¨¡å‹ï¼Œå¦‚ Gemini ã€‚

2. **è¯·æ±‚å†…å®¹è¯†åˆ«**ï¼šé™¤äº† Token æ•°é‡ï¼ŒCCR è¿˜ä¼šåˆ†æè¯·æ±‚çš„å…·ä½“å†…å®¹ï¼Œä»¥è¯†åˆ«å…¶æ½œåœ¨çš„ä»»åŠ¡ç±»å‹æˆ–ç‰¹æ®Šéœ€æ±‚ã€‚è¿™å¯èƒ½åŒ…æ‹¬å¯¹è¯·æ±‚æ–‡æœ¬è¿›è¡Œå…³é”®è¯æå–ã€æ„å›¾è¯†åˆ«æˆ–æ¨¡å¼åŒ¹é…ã€‚ä¾‹å¦‚ï¼Œå¦‚æœè¯·æ±‚ä¸­åŒ…å«ç‰¹å®šçš„æŒ‡ä»¤æˆ–æ ‡è®°ï¼Œå¦‚ `thinking` æ ‡è®°ï¼ŒCCR ä¼šå°†å…¶è¯†åˆ«ä¸ºéœ€è¦æ·±åº¦æ¨ç†çš„ä»»åŠ¡ ã€‚åŒæ ·ï¼Œå¦‚æœæ¨¡å‹åç§°ä¸­åŒ…å«äº†å¦‚ `haiku` è¿™æ ·çš„æ ‡è¯†ï¼ŒCCR å¯èƒ½ä¼šå°†å…¶è§†ä¸ºåå°ä»»åŠ¡ï¼Œä»è€Œé‡‡ç”¨ç›¸åº”çš„è·¯ç”±ç­–ç•¥ ã€‚

3. **ç”¨æˆ·æŒ‡ä»¤ä¸åå¥½**ï¼šCCR å°Šé‡ç”¨æˆ·çš„æ˜¾å¼æŒ‡ä»¤ã€‚å¦‚æœç”¨æˆ·åœ¨è¯·æ±‚ä¸­é€šè¿‡ç‰¹å®šçš„å‘½ä»¤ï¼ˆå¦‚ `/model` å‘½ä»¤ï¼‰å¼ºåˆ¶æŒ‡å®šäº†å¸Œæœ›ä½¿ç”¨çš„æ¨¡å‹ï¼ŒCCR ä¼šä¼˜å…ˆéµå¾ªç”¨æˆ·çš„æ„æ„¿ ã€‚è¿™ç§æœºåˆ¶ä¿è¯äº†ç”¨æˆ·åœ¨ç‰¹å®šåœºæ™¯ä¸‹å¯¹æ¨¡å‹é€‰æ‹©çš„æ§åˆ¶æƒã€‚

4. **ç³»ç»Ÿä¸å·¥å…·å®šä¹‰åˆ†æ**ï¼šCCR è¿˜ä¼šå…³æ³¨è¯·æ±‚ä¸­æ˜¯å¦æ¶‰åŠç‰¹å®šçš„ç³»ç»Ÿæç¤ºæˆ–å·¥å…·å®šä¹‰ã€‚è¿™äº›ä¿¡æ¯å¾€å¾€æš—ç¤ºäº†ä»»åŠ¡çš„å¤æ‚åº¦å’Œå¯¹æ¨¡å‹èƒ½åŠ›çš„è¦æ±‚ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä¸€ä¸ªè¯·æ±‚ä¸­å®šä¹‰äº†å¤æ‚çš„å·¥å…·è°ƒç”¨æµç¨‹ï¼Œé‚£ä¹ˆ CCR å¯èƒ½ä¼šå€¾å‘äºé€‰æ‹©ä¸€ä¸ªåœ¨å·¥å…·ä½¿ç”¨æ–¹é¢è¡¨ç°æ›´ä½³çš„æ¨¡å‹ã€‚

é€šè¿‡å¯¹è¿™äº›ç»´åº¦çš„ç»¼åˆåˆ†æï¼ŒCCR èƒ½å¤Ÿæ„å»ºä¸€ä¸ªå…³äºå½“å‰è¯·æ±‚çš„è¯¦ç»†ç”»åƒï¼Œä»è€Œä¸ºåç»­çš„æ™ºèƒ½è·¯ç”±å†³ç­–æä¾›åšå®çš„åŸºç¡€ã€‚è¿™ç§ç²¾ç»†åŒ–çš„åˆ†æèƒ½åŠ›æ˜¯ CCR å®ç°é«˜æ•ˆã€ç²¾å‡†æ¨¡å‹è°ƒåº¦çš„å‰æã€‚

### 3.2. åŠ¨æ€è·¯ç”±è§„åˆ™ä¸è°ƒåº¦ç®—æ³•

Claude-Code-Router (CCR) çš„åŠ¨æ€è·¯ç”±è§„åˆ™ä¸è°ƒåº¦ç®—æ³•æ˜¯å…¶æ™ºèƒ½å†³ç­–çš„æ ¸å¿ƒï¼Œå®ƒåŸºäºå¯¹è¯·æ±‚çš„å¤šç»´åº¦åˆ†æç»“æœï¼Œå¹¶ç»“åˆé¢„è®¾çš„è§„åˆ™é›†ï¼Œæ¥å†³å®šå°†è¯·æ±‚å¯¼å‘å“ªä¸ªå…·ä½“çš„ AI æ¨¡å‹ã€‚æ ¹æ®ç°æœ‰èµ„æ–™ï¼ŒCCR çš„è°ƒåº¦ç®—æ³•ä¸»è¦éµå¾ªä¸€å¥—ä¼˜å…ˆçº§è§„åˆ™ï¼Œå…·ä½“å¦‚ä¸‹ ï¼š

1. **ç”¨æˆ·å¼ºåˆ¶æŒ‡å®š (User Force-Specified Model)**ï¼šè¿™æ˜¯æœ€é«˜ä¼˜å…ˆçº§çš„è§„åˆ™ã€‚å¦‚æœç”¨æˆ·åœ¨å‘èµ·è¯·æ±‚æ—¶ï¼Œé€šè¿‡ç‰¹å®šçš„å‘½ä»¤ï¼ˆä¾‹å¦‚ `/model` å‘½ä»¤ï¼‰æ˜ç¡®æŒ‡å®šäº†å¸Œæœ›ä½¿ç”¨çš„æ¨¡å‹ï¼ŒCCR ä¼šä¼˜å…ˆéµä»ç”¨æˆ·çš„æŒ‡ä»¤ï¼Œå°†è¯·æ±‚è·¯ç”±åˆ°ç”¨æˆ·æŒ‡å®šçš„æ¨¡å‹ ã€‚è¿™æ¡è§„åˆ™ç¡®ä¿äº†ç”¨æˆ·åœ¨éœ€è¦ç²¾ç¡®æ§åˆ¶æ¨¡å‹é€‰æ‹©æ—¶çš„ä¸»å¯¼æƒã€‚

2. **è¶…é•¿ä¸Šä¸‹æ–‡å¤„ç† (Long Context Handling)**ï¼šå¦‚æœè¯·æ±‚çš„ Token æ•°é‡è¶…è¿‡ä¸€ä¸ªé¢„è®¾çš„é˜ˆå€¼ï¼ˆä¾‹å¦‚ï¼Œèµ„æ–™ä¸­æåŠçš„ 60,000 Tokensï¼‰ï¼ŒCCR ä¼šè‡ªåŠ¨å°†è¯¥è¯·æ±‚è¯†åˆ«ä¸ºè¶…é•¿ä¸Šä¸‹æ–‡ä»»åŠ¡ï¼Œå¹¶å°†å…¶è·¯ç”±åˆ°ä¸“é—¨ä¸ºæ­¤ç±»ä»»åŠ¡ä¼˜åŒ–çš„æ¨¡å‹ï¼Œä¾‹å¦‚ Google çš„ Gemini æ¨¡å‹ ã€‚è¿™ç§è§„åˆ™ç¡®ä¿äº†å¤„ç†å¤§è§„æ¨¡æ–‡æœ¬è¾“å…¥æ—¶çš„æ•ˆç‡å’Œæ•ˆæœã€‚

3. **åå°ä»»åŠ¡è·¯ç”± (Background Task Routing)**ï¼šå¦‚æœè¯·æ±‚ä¸­æ¶‰åŠçš„æ¨¡å‹åç§°åŒ…å«ç‰¹å®šçš„æ ‡è¯†ç¬¦ï¼ˆä¾‹å¦‚ï¼Œèµ„æ–™ä¸­æåŠçš„ `haiku`ï¼‰ï¼ŒCCR ä¼šå°†è¯¥è¯·æ±‚è¯†åˆ«ä¸ºåå°ä»»åŠ¡ï¼Œå¹¶å°†å…¶è·¯ç”±åˆ°é¢„è®¾çš„åå°ä»»åŠ¡å¤„ç†æ¨¡å‹æˆ–è·¯ç”±ç­–ç•¥ ã€‚è¿™é€šå¸¸ç”¨äºå¤„ç†å¯¹å®æ—¶æ€§è¦æ±‚ä¸é«˜ï¼Œæˆ–è€…å¯ä»¥å®¹å¿è¾ƒä½å“åº”ä¼˜å…ˆçº§çš„ä»»åŠ¡ï¼Œå¯èƒ½é€‰æ‹©æˆæœ¬æ›´ä½æˆ–èµ„æºå ç”¨æ›´å°‘çš„æ¨¡å‹ã€‚

4. **æ¨ç†ä»»åŠ¡è·¯ç”± (Reasoning Task Routing)**ï¼šå¦‚æœè¯·æ±‚ä¸­åŒ…å«ç‰¹å®šçš„æ ‡è®°ï¼ˆä¾‹å¦‚ï¼Œèµ„æ–™ä¸­æåŠçš„ `thinking` æ ‡è®°ï¼‰ï¼ŒCCR ä¼šå°†å…¶è¯†åˆ«ä¸ºéœ€è¦è¿›è¡Œå¤æ‚é€»è¾‘æ¨ç†çš„ä»»åŠ¡ï¼Œå¹¶å°†å…¶è·¯ç”±åˆ°é¢„è®¾çš„æ¨ç†ä»»åŠ¡å¤„ç†æ¨¡å‹æˆ–è·¯ç”±ç­–ç•¥ï¼Œä¾‹å¦‚ä¸“é—¨é’ˆå¯¹æ¨ç†èƒ½åŠ›ä¼˜åŒ–çš„æ¨¡å‹ ã€‚

5. **é»˜è®¤è·¯ç”± (Default Routing)**ï¼šå¦‚æœä»¥ä¸Šæ‰€æœ‰ç‰¹å®šè§„åˆ™éƒ½ä¸æ»¡è¶³ï¼Œå³è¯·æ±‚ä¸å±äºç”¨æˆ·å¼ºåˆ¶æŒ‡å®šã€è¶…é•¿ä¸Šä¸‹æ–‡ã€åå°ä»»åŠ¡æˆ–æ¨ç†ä»»åŠ¡ä¸­çš„ä»»ä½•ä¸€ç§ï¼Œé‚£ä¹ˆ CCR ä¼šé‡‡ç”¨é»˜è®¤çš„è·¯ç”±ç­–ç•¥ï¼Œå°†è¯·æ±‚å‘é€åˆ°é¢„è®¾çš„é»˜è®¤æ¨¡å‹è¿›è¡Œå¤„ç† ã€‚

è¿™ç§åŸºäºä¼˜å…ˆçº§å’Œæ¡ä»¶åˆ¤æ–­çš„è°ƒåº¦ç®—æ³•ï¼Œè™½ç„¶å¯èƒ½ä¸åƒä¸€äº›å¤æ‚çš„æœºå™¨å­¦ä¹ é©±åŠ¨çš„è°ƒåº¦å™¨é‚£æ ·å…·å¤‡è‡ªå­¦ä¹ å’Œè‡ªé€‚åº”èƒ½åŠ›ï¼Œä½†å®ƒæä¾›äº†ä¸€ç§æ¸…æ™°ã€å¯æ§ä¸”æ˜“äºé…ç½®çš„è·¯ç”±æœºåˆ¶ã€‚å®ƒå…è®¸ç”¨æˆ·å’Œç®¡ç†å‘˜é€šè¿‡é…ç½®æ–‡ä»¶ï¼ˆå¦‚ `~/.claude-code-router/config.json` ï¼‰æ¥å®šä¹‰ä¸åŒè·¯ç”±ç­–ç•¥ï¼ˆå¦‚ `background`, `think`, `longContext`, `image`ï¼Œ`default` ï¼‰æ‰€å¯¹åº”çš„å…·ä½“æ¨¡å‹å’Œæä¾›å•†ã€‚ä¾‹å¦‚ï¼Œåœ¨é…ç½®æ–‡ä»¶ä¸­ï¼Œå¯ä»¥ä¸º `longContext` ç­–ç•¥æŒ‡å®š `openrouter,google/gemini-2.5-pro-preview`ï¼Œä¸º `think` ç­–ç•¥æŒ‡å®š `deepseek,deepseek-reasoner` ã€‚è¿™ç§é…ç½®åŒ–çš„æ–¹å¼ä½¿å¾—è·¯ç”±ç­–ç•¥å¯ä»¥æ ¹æ®å®é™…éœ€æ±‚çµæ´»è°ƒæ•´ï¼Œå¹³è¡¡æ€§èƒ½ã€æˆæœ¬å’Œä»»åŠ¡ç‰¹æ€§ã€‚

**Router é…ç½®é¡¹åŠè°ƒç”¨é€»è¾‘**
ğŸ“‹ æ‰€æœ‰æ”¯æŒçš„ Router é…ç½®é€‰é¡¹
æ ¹æ®æºç  (types.ts) å’Œ router.ts çš„åˆ†æï¼ŒRouter æ”¯æŒä»¥ä¸‹é…ç½®ï¼š

| é…ç½®é¡¹ | ç±»å‹ | è¯´æ˜ | è§¦å‘æ¡ä»¶ |
|--------|------|------|--------|
| default | string | é»˜è®¤æ¨¡å‹ | å…¶ä»–è§„åˆ™éƒ½ä¸åŒ¹é…æ—¶ |
| think | string | æ€è€ƒ/æ¨ç†æ¨¡å‹ | thinking: true å‚æ•° |
| background | string | åå°ä»»åŠ¡æ¨¡å‹ | Claude Haiku å˜ç§ |
| webSearch | string | ç½‘é¡µæœç´¢æ¨¡å‹ | åŒ…å« web_search å·¥å…·æ—¶ |
| longContext | string | é•¿æ–‡æœ¬æ¨¡å‹ | Token è¶…è¿‡é˜ˆå€¼ |
| longContextThreshold | number | é•¿æ–‡æœ¬é˜ˆå€¼ï¼ˆé»˜è®¤60000ï¼‰ | ç”¨äºåˆ¤æ–­æ˜¯å¦å¯ç”¨ longContext |
| image | string | âœ¨ å›¾åƒå¤„ç†æ¨¡å‹ | åŒ…å«å›¾åƒå†…å®¹æ—¶ |
| custom | any | è‡ªå®šä¹‰æ‰©å±• | ç”¨æˆ·è‡ªå®šä¹‰ |

ğŸ”„ å®Œæ•´çš„è·¯ç”±å†³ç­–æµç¨‹å›¾

```mermaid
flowchart TD
    Start["ğŸ“¥ è¯·æ±‚åˆ°è¾¾"] --> CheckCustom{æ˜¯å¦é…ç½®äº†<br/>CUSTOM_ROUTER_PATH?}
    
    CheckCustom -->|æ˜¯| ExecuteCustom["ğŸš€ æ‰§è¡Œ Custom Router<br/>å¤„ç†è¯·æ±‚"]
    ExecuteCustom --> CustomResult{Custom Router<br/>è¿”å›ç»“æœ?}
    
    CustomResult -->|è¿”å› model å­—ç¬¦ä¸²| UseCustom["âœ… ä½¿ç”¨ Custom<br/>è¿”å›çš„ model"]
    CustomResult -->|è¿”å› null| FallbackBuiltin["â†©ï¸ é™çº§åˆ°<br/>å†…ç½®è·¯ç”±é€»è¾‘"]
    
    CheckCustom -->|å¦| FallbackBuiltin
    
    FallbackBuiltin --> CheckExplicit{æ˜¾å¼æŒ‡å®š<br/>modelå‚æ•°?}
    CheckExplicit -->|æ˜¯| C["âœ“ ä½¿ç”¨æŒ‡å®šçš„ model"]
    CheckExplicit -->|å¦| D{æ£€æŸ¥ Subagent<br/>æ ‡ç­¾?}
    
    D -->|æœ‰| E["âœ“ ä½¿ç”¨ Subagent<br/>æŒ‡å®šçš„ model"]
    D -->|æ— | F{Token æ•°é‡<br/>è¶…è¿‡ threshold?}
    
    F -->|æ˜¯| G["âœ“ ä½¿ç”¨ longContext"]
    F -->|å¦| H{æ˜¯ Claude<br/>Haiku?}
    
    H -->|æ˜¯| I["âœ“ ä½¿ç”¨ background"]
    H -->|å¦| J{åŒ…å«<br/>web_search?}
    
    J -->|æ˜¯| K["âœ“ ä½¿ç”¨ webSearch"]
    J -->|å¦| L{thinking=true?}
    
    L -->|æ˜¯| M["âœ“ ä½¿ç”¨ think"]
    L -->|å¦| N{åŒ…å«<br/>å›¾åƒ?}
    
    N -->|æ˜¯| O["âœ“ ä½¿ç”¨ image"]
    N -->|å¦| P["âœ“ ä½¿ç”¨ default"]
    
    UseCustom --> Q["ğŸ¯ æ›´æ–° req.body.model"]
    C --> Q
    E --> Q
    G --> Q
    I --> Q
    K --> Q
    M --> Q
    O --> Q
    P --> Q
    
    Q --> R["ğŸ“¤ å‘é€åˆ° Provider"]
    
    style Start fill:#e1f5ff
    style ExecuteCustom fill:#ffccbc
    style UseCustom fill:#c8e6c9
    style FallbackBuiltin fill:#fff9c4
    style CheckCustom fill:#ffe0b2
    style CustomResult fill:#ffe0b2
```

æ­¤å¤–ï¼Œä¸€äº›ç¤¾åŒºè´¡çŒ®çš„å¢å¼ºç‰ˆæœ¬ï¼Œå¦‚ `@jasonzhangf/claude-code-router-enhanced`ï¼Œè¿˜å¢åŠ äº†é‡è¯•æœºåˆ¶ ï¼Œè¿™å¯ä»¥è§†ä¸ºå¯¹è°ƒåº¦ç®—æ³•åœ¨å®¹é”™æ€§å’Œé²æ£’æ€§æ–¹é¢çš„è¡¥å……ã€‚æœªæ¥ï¼ŒCCR çš„è°ƒåº¦ç®—æ³•å¯èƒ½ä¼šæœç€æ›´æ™ºèƒ½åŒ–çš„æ–¹å‘å‘å±•ï¼Œä¾‹å¦‚å¼•å…¥åŸºäºæ¨¡å‹å®æ—¶è´Ÿè½½ã€å“åº”é€Ÿåº¦ã€Token ä½™é¢ç­‰å› ç´ çš„åŠ¨æ€åˆ†æµç­–ç•¥ ã€‚

### 3.3. è·¯ç”±é…ç½®ä¸æ¨¡å‹åˆ†å·¥

Claude-Code-Router (CCR) çš„è·¯ç”±é…ç½®ä¸æ¨¡å‹åˆ†å·¥æ˜¯å…¶å®ç°å¤šæ¨¡å‹ååŒå·¥ä½œçš„æ ¸å¿ƒæœºåˆ¶ï¼Œå®ƒå…è®¸ç”¨æˆ·æ ¹æ®ä»»åŠ¡ç±»å‹å’Œæ¨¡å‹èƒ½åŠ›ï¼Œå°†è¯·æ±‚æ™ºèƒ½åœ°è·¯ç”±åˆ°æœ€åˆé€‚çš„æ¨¡å‹ï¼Œä»è€Œä¼˜åŒ–æˆæœ¬ã€æ€§èƒ½å’Œä»»åŠ¡å®Œæˆè´¨é‡ã€‚è¿™ä¸€åˆ‡ä¸»è¦é€šè¿‡ä¸€ä¸ªæ ¸å¿ƒçš„é…ç½®æ–‡ä»¶ `~/.claude-code-router/config.json` æ¥å®ç° ã€‚

åœ¨è¿™ä¸ªé…ç½®æ–‡ä»¶ä¸­ï¼Œç”¨æˆ·å¯ä»¥å®šä¹‰å¤šä¸ª AI æ¨¡å‹æä¾›å•†ï¼ˆProvidersï¼‰ä»¥åŠæ¯ä¸ªæä¾›å•†ä¸‹çš„å…·ä½“æ¨¡å‹ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªå…¸å‹çš„é…ç½®å¯èƒ½åŒ…å« OpenRouterã€DeepSeekã€Ollama (æœ¬åœ°æ¨¡å‹) ç­‰æä¾›å•†ï¼Œå¹¶ä¸ºæ¯ä¸ªæä¾›å•†æŒ‡å®šå…¶ API çš„åŸºç¡€åœ°å€ (`api_base_url`)ã€API å¯†é’¥ (`api_key`)ï¼Œä»¥åŠè¯¥æä¾›å•†æ”¯æŒçš„å¯é€‰æ¨¡å‹åˆ—è¡¨ (`models`) ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥ä¸º OpenRouter é…ç½® `google/gemini-2.5-pro-preview` å’Œ `anthropic/claude-3.5-sonnet` ç­‰æ¨¡å‹ï¼›ä¸º DeepSeek é…ç½® `deepseek-coder` å’Œ `deepseek-reasoner`ï¼›ä¸º Ollama é…ç½®æœ¬åœ°è¿è¡Œçš„ `qwen2.5-coder:latest` æˆ– `llama3:8b` ç­‰æ¨¡å‹ ã€‚

æ¥ä¸‹æ¥ï¼Œåœ¨é…ç½®æ–‡ä»¶çš„ `Router` éƒ¨åˆ†ï¼Œç”¨æˆ·å¯ä»¥å®šä¹‰å…·ä½“çš„è·¯ç”±ç­–ç•¥ï¼Œå°†ä¸åŒçš„ä»»åŠ¡ç±»å‹æ˜ å°„åˆ°ä¹‹å‰å®šä¹‰çš„æä¾›å•†å’Œæ¨¡å‹ç»„åˆä¸Šã€‚CCR é¢„è®¾äº†å‡ ç§å¸¸è§çš„è·¯ç”±ç­–ç•¥ç±»å‹ ï¼š

- **`default`**: è¿™æ˜¯å½“æ²¡æœ‰å…¶ä»–ç‰¹å®šè§„åˆ™åŒ¹é…æ—¶ä½¿ç”¨çš„é»˜è®¤æ¨¡å‹ã€‚
- **`background`**: ç”¨äºå¤„ç†åå°ä»»åŠ¡çš„æ¨¡å‹ï¼Œé€šå¸¸é€‰æ‹©æˆæœ¬è¾ƒä½æˆ–å¯¹å®æ—¶æ€§è¦æ±‚ä¸é«˜çš„æ¨¡å‹ï¼Œä¾‹å¦‚æœ¬åœ°è¿è¡Œçš„ Ollama æ¨¡å‹ `qwen2.5-coder:latest` ã€‚
- **`think`**: ç”¨äºå¤„ç†éœ€è¦æ·±åº¦æ€è€ƒæˆ–è§„åˆ’çš„æ¨ç†ä»»åŠ¡çš„æ¨¡å‹ï¼Œä¾‹å¦‚ DeepSeek çš„ `deepseek-reasoner` æ¨¡å‹ ã€‚
- **`longContext`**: ç”¨äºå¤„ç†è¶…é•¿ä¸Šä¸‹æ–‡ä»»åŠ¡çš„æ¨¡å‹ï¼Œä¾‹å¦‚é€šè¿‡ OpenRouter è®¿é—®çš„ Google Gemini 2.5 Pro Preview æ¨¡å‹ ã€‚
- **`websearch`**: ç”¨äºè°ƒç”¨æ”¯æŒweb searchçš„å¤§æ¨¡å‹ï¼ˆæ¯”å¦‚Gemini Flashï¼‰æ¥å®ç°web searchã€‚

é€šè¿‡è¿™ç§é…ç½®æ–¹å¼ï¼ŒCCR å®ç°äº†æ¸…æ™°çš„æ¨¡å‹åˆ†å·¥ã€‚ä¾‹å¦‚ï¼Œç”¨æˆ·å¯ä»¥å°†è®¡ç®—é‡å°ã€ä¸é‚£ä¹ˆç´§æ€¥çš„åå°ä»»åŠ¡è·¯ç”±åˆ°æˆæœ¬è¾ƒä½çš„æœ¬åœ°æ¨¡å‹ï¼›å°†éœ€è¦æ·±åº¦æ€è€ƒçš„æ¨ç†ä»»åŠ¡å‘é€ç»™æ¨ç†èƒ½åŠ›æ›´å¼ºçš„äº‘ç«¯æ¨¡å‹ï¼›è€Œå°†å¤„ç†è¶…é•¿æ–‡æ¡£çš„ä»»åŠ¡äº¤ç»™æ”¯æŒå¤§ä¸Šä¸‹æ–‡çš„æ¨¡å‹ ã€‚è¿™ç§åˆ†å·¥ä¸ä»…æœ‰åŠ©äºé™ä½æˆæœ¬ï¼ˆä¾‹å¦‚ï¼Œä½¿ç”¨ DeepSeek API å¯å¤§å¹…é™ä½æˆæœ¬ ï¼‰ï¼Œè¿˜èƒ½æå‡ç‰¹å®šä»»åŠ¡çš„æ‰§è¡Œæ•ˆç‡å’Œè´¨é‡ã€‚ç¤¾åŒºä¹Ÿæä¾›äº†ä¸€äº›æ¨¡å‹é€‰æ‹©ç­–ç•¥çš„å»ºè®®ï¼Œä¾‹å¦‚ï¼Œå¯¹äºä»£ç è§£é‡Šï¼Œæ¨èä½¿ç”¨ Claude Sonnetï¼›å¯¹äºé•¿æ–‡æ¡£å¤„ç†ï¼Œæ¨è Gemini Proï¼›å¯¹äºå¿«é€ŸåŸå‹æ„å»ºï¼Œæ¨è DeepSeek ã€‚CCR çš„é…ç½®ç³»ç»Ÿä½¿å¾—è¿™äº›ç­–ç•¥èƒ½å¤Ÿè¢«çµæ´»åœ°å®æ–½å’Œè°ƒæ•´ã€‚

## 4. è¯·æ±‚è½¬æ¢ä¸è½¬å‘ç­–ç•¥

Claude-Code-Router (CCR) çš„è¯·æ±‚è½¬æ¢ä¸è½¬å‘ç­–ç•¥æ˜¯å…¶èƒ½å¤Ÿæ— ç¼é›†æˆå’Œåˆ©ç”¨å¤šç§ä¸åŒ AI æ¨¡å‹çš„å…³é”®æŠ€æœ¯ç¯èŠ‚ã€‚ç”±äºä¸åŒçš„ AI æ¨¡å‹æä¾›å•†ï¼ˆå¦‚ Anthropic, OpenAI, Google, DeepSeek ç­‰ï¼‰é€šå¸¸æ‹¥æœ‰å„è‡ªç‹¬ç‰¹çš„ API æ¥å£è§„èŒƒã€è¯·æ±‚å‚æ•°æ ¼å¼ã€è®¤è¯æ–¹å¼ä»¥åŠå“åº”ç»“æ„ï¼ŒCCR å¿…é¡»å……å½“ä¸€ä¸ªæ™ºèƒ½çš„é€‚é…å™¨å’Œä»£ç†ï¼Œç¡®ä¿æ¥è‡ª `claude-code` å®¢æˆ·ç«¯çš„ã€ç¬¦åˆ Anthropic API æ ¼å¼çš„è¯·æ±‚èƒ½å¤Ÿè¢«æ­£ç¡®åœ°è½¬æ¢å¹¶å‘é€åˆ°ç›®æ ‡æ¨¡å‹ï¼ŒåŒæ—¶ç›®æ ‡æ¨¡å‹çš„å“åº”ä¹Ÿèƒ½è¢«è½¬æ¢å› Anthropic å…¼å®¹çš„æ ¼å¼ï¼Œä»è€Œå¯¹å®¢æˆ·ç«¯é€æ˜ã€‚è¿™ä¸€è¿‡ç¨‹ä¸ä»…æ¶‰åŠåˆ°æ•°æ®æ ¼å¼çš„æ˜ å°„ï¼Œè¿˜å¯èƒ½åŒ…æ‹¬è®¤è¯ä¿¡æ¯çš„è½¬æ¢ã€é”™è¯¯å¤„ç†ä»¥åŠæµå¼ä¼ è¾“çš„æ”¯æŒã€‚CCR çš„è®¾è®¡ç›®æ ‡ä¹‹ä¸€æ˜¯ç®€åŒ–ç”¨æˆ·ä¸å¤šç§æ¨¡å‹äº¤äº’çš„å¤æ‚æ€§ï¼Œè€Œè¯·æ±‚è½¬æ¢ä¸è½¬å‘ç­–ç•¥æ­£æ˜¯å®ç°è¿™ä¸€ç›®æ ‡çš„æ ¸å¿ƒã€‚

### 4.1. API æ ¼å¼è½¬æ¢ä¸é€‚é…

Claude-Code-Router (CCR) çš„æ ¸å¿ƒåŠŸèƒ½ä¹‹ä¸€æ˜¯å®ç°ä¸åŒå¤§å‹è¯­è¨€æ¨¡å‹ (LLM) API æ ¼å¼ä¹‹é—´çš„è½¬æ¢ä¸é€‚é…ï¼Œç¡®ä¿æ¥è‡ª `claude-code` å®¢æˆ·ç«¯çš„ã€ç¬¦åˆ Anthropic API è§„èŒƒçš„è¯·æ±‚èƒ½å¤Ÿè¢«æ­£ç¡®åœ°å‘é€åˆ°å„ç§ç›®æ ‡æ¨¡å‹ï¼Œå¹¶å°†ç›®æ ‡æ¨¡å‹çš„å“åº”è½¬æ¢å› Anthropic å…¼å®¹çš„æ ¼å¼ã€‚è¿™ä¸ªè¿‡ç¨‹æ˜¯ CCR å®ç°å¤šæ¨¡å‹æ”¯æŒçš„å…³é”®ã€‚

å…·ä½“æ¥è¯´ï¼Œå½“ CCR æ ¹æ®å…¶æ™ºèƒ½è·¯ç”±å†³ç­–æœºåˆ¶é€‰å®šäº†ä¸€ä¸ªç›®æ ‡æ¨¡å‹åï¼Œå®ƒéœ€è¦å¤„ç†ä»¥ä¸‹è½¬æ¢æ­¥éª¤ï¼š

1. **è¯·æ±‚ä½“è½¬æ¢ (Request Body Transformation)**ï¼šAnthropic çš„ Claude ç³»åˆ—æ¨¡å‹æœ‰å…¶ç‰¹å®šçš„ API è¯·æ±‚å‚æ•°ï¼Œä¾‹å¦‚ `model`, `messages`, `max_tokens`, `temperature`, `stream` ç­‰ã€‚è€Œå…¶ä»–æ¨¡å‹ï¼Œå¦‚ Google çš„ Gemini æˆ– OpenAI çš„ GPT ç³»åˆ—ï¼Œå…¶ API å‚æ•°åç§°ã€ç»“æ„ã€ç”šè‡³æ”¯æŒçš„å‚æ•°ç±»å‹éƒ½å¯èƒ½å­˜åœ¨å·®å¼‚ ã€‚CCR å†…éƒ¨éœ€è¦åŒ…å«ä¸€ä¸ªè½¬æ¢å±‚ï¼Œèƒ½å¤Ÿå°† Anthropic æ ¼å¼çš„è¯·æ±‚ä½“å‡†ç¡®åœ°æ˜ å°„åˆ°ç›®æ ‡æ¨¡å‹çš„ API æ‰€æœŸæœ›çš„æ ¼å¼ã€‚è¿™å¯èƒ½æ¶‰åŠåˆ°å­—æ®µåçš„é‡æ˜ å°„ã€æ•°æ®ç±»å‹çš„è½¬æ¢ã€é»˜è®¤å€¼çš„å¡«å……ï¼Œä»¥åŠæŸäº› Anthropic ç‰¹æœ‰å‚æ•°åˆ°ç›®æ ‡æ¨¡å‹ç­‰æ•ˆå‚æ•°çš„è½¬æ¢ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ã€‚

2. **å“åº”ä½“è½¬æ¢ (Response Body Transformation)**ï¼šåŒæ ·åœ°ï¼Œç›®æ ‡æ¨¡å‹è¿”å›çš„å“åº”ä¹Ÿå…·æœ‰å…¶ç‰¹å®šçš„æ ¼å¼ã€‚CCR éœ€è¦èƒ½å¤Ÿè§£æè¿™ç§å“åº”ï¼Œæå–å‡ºå…³é”®ä¿¡æ¯ï¼ˆå¦‚ç”Ÿæˆçš„æ–‡æœ¬ã€å®ŒæˆçŠ¶æ€ã€Token ä½¿ç”¨é‡ç­‰ï¼‰ï¼Œå¹¶å°†å…¶é‡æ–°ç»„ç»‡æˆ Anthropic API å®¢æˆ·ç«¯æ‰€æœŸæœ›çš„å“åº”ç»“æ„ ã€‚è¿™ç¡®ä¿äº† `claude-code` å®¢æˆ·ç«¯å¯ä»¥åƒç›´æ¥ä¸ Claude æ¨¡å‹äº¤äº’ä¸€æ ·å¤„ç†æ¥è‡ªä»»ä½•è¢«è·¯ç”±æ¨¡å‹çš„å“åº”ã€‚

3. **æµå¼ä¼ è¾“æ”¯æŒ (Streaming Support)**ï¼šè®¸å¤šç°ä»£ LLM API æ”¯æŒæµå¼ä¼ è¾“ï¼ˆServer-Sent Events, SSEï¼‰ï¼Œå…è®¸å“åº”å†…å®¹åˆ†å—è¿”å›ï¼Œä»è€Œæå‡ç”¨æˆ·ä½“éªŒï¼Œå°¤å…¶æ˜¯åœ¨å¤„ç†è¾ƒé•¿ç”Ÿæˆå†…å®¹æ—¶ã€‚CCR éœ€è¦èƒ½å¤Ÿå¤„ç† Anthropic æ ¼å¼çš„æµå¼è¯·æ±‚ï¼Œå¹¶å°†å…¶è½¬æ¢ä¸ºç›®æ ‡æ¨¡å‹çš„æµå¼è¯·æ±‚ï¼ˆå¦‚æœç›®æ ‡æ¨¡å‹æ”¯æŒï¼‰ï¼ŒåŒæ—¶å°†ç›®æ ‡æ¨¡å‹çš„æµå¼å“åº”è½¬æ¢å› Anthropic çš„ SSE æ ¼å¼å›ä¼ ç»™ `claude-code` ã€‚è¿™ä½¿å¾— `claude-code` èƒ½å¤Ÿä»¥æµå¼æ–¹å¼æ¥æ”¶æ¥è‡ªä¸åŒæ¨¡å‹çš„å“åº”ï¼Œä¿æŒäº¤äº’çš„æµç•…æ€§ã€‚

4. **è®¤è¯ä¸å¤´éƒ¨ä¿¡æ¯é€‚é… (Authentication and Header Adaptation)**ï¼šä¸åŒçš„ API æä¾›å•†é€šå¸¸æœ‰ä¸åŒçš„è®¤è¯æœºåˆ¶ï¼ˆå¦‚ API Key çš„ä½ç½®ã€è®¤è¯å¤´çš„åç§°ï¼‰ã€‚CCR çš„é…ç½®æ–‡ä»¶ä¸­ä¼šä¸ºæ¯ä¸ªæä¾›å•†é…ç½®ç›¸åº”çš„ API Key ï¼ŒCCR éœ€è¦ç¡®ä¿åœ¨è½¬å‘è¯·æ±‚æ—¶ï¼Œä½¿ç”¨æ­£ç¡®çš„è®¤è¯æ–¹å¼å‘ç›®æ ‡ API å‘èµ·è¯·æ±‚ã€‚

ä¸€ä¸ªåä¸º `claude-bridge` çš„å®éªŒæ€§å·¥å…·ï¼Œå…¶å·¥ä½œåŸç†ä¸ CCR ç±»ä¼¼ï¼Œä¹Ÿå¼ºè°ƒäº†è¯·æ±‚è½¬æ¢çš„é‡è¦æ€§ã€‚å®ƒé€šè¿‡ Node.js å®ç°è‡ªå®šä¹‰åŠ è½½å™¨ï¼Œæ‹¦æˆªå‘å¾€ `api.anthropic.com/v1/messages` çš„è¯·æ±‚ï¼Œå°†åŸå§‹ Anthropic è¯·æ±‚æ ¼å¼è½¬æ¢ä¸ºç»Ÿä¸€çš„ä¸­é—´æ ¼å¼ï¼ˆç§°ä¸º *lemmy*ï¼‰ï¼Œç„¶åå†æ ¹æ®é…ç½®å°†è¯·æ±‚è½¬å‘ç»™å¯¹åº”çš„ LLM æä¾›å•† ã€‚è¿™ç§å¼•å…¥ä¸­é—´æ ¼å¼çš„æ€è·¯ï¼Œå¯èƒ½ä¹Ÿæ˜¯ CCR åœ¨å†…éƒ¨å®ç°å¤šæ¨¡å‹é€‚é…æ—¶é‡‡ç”¨çš„ä¸€ç§ç­–ç•¥ï¼Œé€šè¿‡ä¸€ä¸ªç»Ÿä¸€çš„å†…éƒ¨è¡¨ç¤ºæ¥ç®€åŒ–å¯¹ä¸åŒå¤–éƒ¨ API çš„é€‚é…é€»è¾‘ã€‚

æ­¤å¤–ï¼Œä¸€äº›å¼€å‘è€…ä¹Ÿåœ¨è‡´åŠ›äºå¼€å‘é€šç”¨çš„ LLM API æ ¼å¼è½¬æ¢åº“ï¼Œä¾‹å¦‚ `musistudio/llms` é¡¹ç›®ï¼Œæ—¨åœ¨è½¬æ¢ä¸åŒ LLM API çš„æ ¼å¼ ã€‚CCR å¯èƒ½ç›´æ¥æˆ–é—´æ¥åœ°åˆ©ç”¨äº†è¿™ç±»åº“ï¼Œæˆ–è€…å®ç°äº†ç±»ä¼¼çš„è½¬æ¢é€»è¾‘ï¼Œä»¥ç¡®ä¿ Anthropic çš„è¯·æ±‚èƒ½å¤Ÿè¢«å„ç§ä¸åŒçš„æ¨¡å‹ï¼ˆå¦‚ DeepSeek, Gemini, Ollama ç­‰ï¼‰æ­£ç¡®ç†è§£å¹¶å¤„ç†ã€‚

### 4.2. ä¸­é—´ä»¶æ¶æ„ä¸å¼‚æ­¥å¤„ç†

Claude-Code-Router (CCR) åœ¨å¤„ç†è¯·æ±‚è½¬æ¢ä¸è½¬å‘æ—¶ï¼Œé‡‡ç”¨äº†ä¸­é—´ä»¶ (Middleware) æ¶æ„å’Œå¼‚æ­¥å¤„ç†æœºåˆ¶ï¼Œè¿™ä¸¤è€…å…±åŒæ„æˆäº†å…¶é«˜æ•ˆã€çµæ´»å’Œå¯æ‰©å±•çš„æŠ€æœ¯åŸºç¡€ã€‚ä¸­é—´ä»¶æ¶æ„ä½¿å¾— CCR èƒ½å¤Ÿä»¥æ¨¡å—åŒ–å’Œå¯ç»„åˆçš„æ–¹å¼å¤„ç†è¯·æ±‚ç”Ÿå‘½å‘¨æœŸçš„å„ä¸ªé˜¶æ®µï¼Œè€Œå¼‚æ­¥å¤„ç†åˆ™ç¡®ä¿äº†ç³»ç»Ÿåœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹çš„å“åº”èƒ½åŠ›å’Œèµ„æºåˆ©ç”¨ç‡ã€‚

**ä¸­é—´ä»¶æ¶æ„**ï¼š
Express.js æ˜¯ CCR å®ç°å…¶æ ¸å¿ƒæœåŠ¡çš„åº•å±‚æ¡†æ¶ ï¼Œè€Œ Express.js çš„æ ¸å¿ƒç‰¹æ€§ä¹‹ä¸€å°±æ˜¯å…¶å¼ºå¤§çš„ä¸­é—´ä»¶ç³»ç»Ÿã€‚ä¸­é—´ä»¶æœ¬è´¨ä¸Šæ˜¯å‡½æ•°ï¼Œå®ƒä»¬å¯ä»¥è®¿é—®è¯·æ±‚å¯¹è±¡ (`req`)ã€å“åº”å¯¹è±¡ (`res`) ä»¥åŠåº”ç”¨ç¨‹åºçš„è¯·æ±‚-å“åº”å¾ªç¯ä¸­çš„ä¸‹ä¸€ä¸ªä¸­é—´ä»¶å‡½æ•° (`next`)ã€‚CCR åˆ©ç”¨è¿™ä¸€ç‰¹æ€§ï¼Œå°†å¤æ‚çš„è¯·æ±‚å¤„ç†æµç¨‹åˆ†è§£ä¸ºä¸€ç³»åˆ—å°è€Œä¸“æ³¨çš„ä¸­é—´ä»¶ã€‚æ¯ä¸ªä¸­é—´ä»¶è´Ÿè´£ä¸€é¡¹ç‰¹å®šçš„ä»»åŠ¡ï¼Œä¾‹å¦‚ï¼š

- **è¯·æ±‚æ—¥å¿—è®°å½•**ï¼šè®°å½•æ‰€æœ‰ä¼ å…¥è¯·æ±‚çš„è¯¦ç»†ä¿¡æ¯ï¼Œç”¨äºç›‘æ§å’Œè°ƒè¯•ã€‚
- **è¯·æ±‚è§£æ**ï¼šè§£æè¯·æ±‚ä½“ã€æŸ¥è¯¢å‚æ•°ã€å¤´éƒ¨ä¿¡æ¯ç­‰ã€‚
- **è®¤è¯ä¸æˆæƒ**ï¼šéªŒè¯å®¢æˆ·ç«¯èº«ä»½ï¼Œæ£€æŸ¥å…¶æ˜¯å¦æœ‰æƒé™è®¿é—®ç‰¹å®šèµ„æºæˆ–æ¨¡å‹ã€‚
- **æ™ºèƒ½è·¯ç”±å†³ç­–**ï¼šæ ¹æ®è¯·æ±‚å†…å®¹å†³å®šç›®æ ‡æ¨¡å‹ã€‚
- **API æ ¼å¼è½¬æ¢**ï¼šå¦‚å‰æ‰€è¿°ï¼Œå°†è¯·æ±‚ä» OpenAI æ ¼å¼è½¬æ¢ä¸ºç›®æ ‡æ¨¡å‹ API æ ¼å¼ã€‚
- **è¯·æ±‚è½¬å‘**ï¼šå°†è½¬æ¢åçš„è¯·æ±‚å‘é€ç»™ç›®æ ‡æ¨¡å‹ APIã€‚
- **å“åº”è½¬æ¢**ï¼šå°†ç›®æ ‡æ¨¡å‹çš„å“åº”è½¬æ¢å›å®¢æˆ·ç«¯æœŸæœ›çš„æ ¼å¼ã€‚
- **é”™è¯¯å¤„ç†**ï¼šæ•è·å’Œå¤„ç†åœ¨å¤„ç†è¿‡ç¨‹ä¸­å¯èƒ½å‘ç”Ÿçš„é”™è¯¯ã€‚
- **å“åº”å‘é€**ï¼šå°†æœ€ç»ˆçš„å“åº”å‘é€å›å®¢æˆ·ç«¯ã€‚

é€šè¿‡å°†è¿™äº›åŠŸèƒ½æ¨¡å—åŒ–ä¸ºä¸­é—´ä»¶ï¼ŒCCR çš„ä»£ç ç»“æ„æ›´åŠ æ¸…æ™°ï¼Œæ˜“äºç†è§£å’Œç»´æŠ¤ã€‚å¼€å‘è€…å¯ä»¥æ–¹ä¾¿åœ°æ·»åŠ ã€ç§»é™¤æˆ–æ›¿æ¢ä¸­é—´ä»¶æ¥æ‰©å±•æˆ–ä¿®æ”¹ CCR çš„è¡Œä¸ºï¼Œè€Œæ— éœ€è§¦åŠæ ¸å¿ƒé€»è¾‘ã€‚ä¾‹å¦‚ï¼Œå¦‚æœéœ€è¦æ”¯æŒä¸€ç§æ–°çš„ AI æ¨¡å‹ APIï¼Œåªéœ€å¼€å‘ä¸€ä¸ªæ–°çš„ API è½¬æ¢ä¸­é—´ä»¶å¹¶å°†å…¶æ’å…¥åˆ°å¤„ç†é“¾ä¸­å³å¯ã€‚è¿™ç§æ¾è€¦åˆçš„è®¾è®¡ä¹Ÿä½¿å¾—ä¸åŒåŠŸèƒ½çš„ä¸­é—´ä»¶å¯ä»¥ç”±ä¸åŒçš„å¼€å‘è€…å¹¶è¡Œå¼€å‘ã€‚

**å¼‚æ­¥å¤„ç†**ï¼š
AI æ¨¡å‹çš„ API è°ƒç”¨é€šå¸¸æ˜¯ I/O å¯†é›†å‹çš„æ“ä½œï¼Œå³ CCR å‘æ¨¡å‹ API å‘é€è¯·æ±‚åï¼Œéœ€è¦ç­‰å¾…æ¨¡å‹å¤„ç†å®Œæˆå¹¶è¿”å›å“åº”ï¼Œè¿™ä¸ªç­‰å¾…æ—¶é—´å¯èƒ½ä»å‡ ç™¾æ¯«ç§’åˆ°æ•°ç§’ç”šè‡³æ›´é•¿ã€‚å¦‚æœé‡‡ç”¨åŒæ­¥å¤„ç†æ–¹å¼ï¼Œå³ CCR åœ¨å¤„ç†ä¸€ä¸ªè¯·æ±‚æ—¶é˜»å¡ç­‰å¾…æ¨¡å‹å“åº”ï¼Œé‚£ä¹ˆ CCR çš„æœåŠ¡å™¨çº¿ç¨‹æˆ–è¿›ç¨‹å°†è¢«å ç”¨ï¼Œæ— æ³•å¤„ç†å…¶ä»–å¹¶å‘è¯·æ±‚ï¼Œè¿™å°†å¯¼è‡´æä½çš„ååé‡å’Œç³Ÿç³•çš„å“åº”æ€§èƒ½ã€‚

ä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼ŒCCR å¿…ç„¶é‡‡ç”¨å¼‚æ­¥å¤„ç†æœºåˆ¶ã€‚åœ¨ Node.js (Express.js çš„è¿è¡Œç¯å¢ƒ) ä¸­ï¼Œå¼‚æ­¥æ“ä½œé€šå¸¸é€šè¿‡å›è°ƒå‡½æ•°ã€Promise æˆ– async/await è¯­æ³•æ¥å®ç°ã€‚å½“ CCR éœ€è¦å‘ç›®æ ‡æ¨¡å‹ API è½¬å‘è¯·æ±‚æ—¶ï¼Œå®ƒä¼šå‘èµ·ä¸€ä¸ªéé˜»å¡çš„ HTTP è°ƒç”¨ã€‚è¿™æ„å‘³ç€å®ƒä¸ä¼šç­‰å¾…å“åº”ï¼Œè€Œæ˜¯ç«‹å³ç»§ç»­æ‰§è¡Œåç»­ä»£ç æˆ–å¤„ç†å…¶ä»–ä¼ å…¥çš„è¯·æ±‚ã€‚å½“æ¨¡å‹ API çš„å“åº”è¿”å›æ—¶ï¼ŒNode.js çš„äº‹ä»¶å¾ªç¯ä¼šæ¥æ”¶åˆ°é€šçŸ¥ï¼Œå¹¶è§¦å‘ç›¸åº”çš„å›è°ƒå‡½æ•°æˆ–è§£æç›¸å…³çš„ Promiseï¼Œä»è€Œç»§ç»­å¤„ç†è¯¥è¯·æ±‚çš„åç»­æ­¥éª¤ï¼ˆå¦‚å“åº”è½¬æ¢å’Œå‘é€ï¼‰ã€‚

è¿™ç§å¼‚æ­¥éé˜»å¡çš„ I/O æ¨¡å‹ä½¿å¾— CCR èƒ½å¤Ÿä»¥å°‘é‡çš„çº¿ç¨‹é«˜æ•ˆåœ°å¤„ç†å¤§é‡å¹¶å‘è¯·æ±‚ã€‚å•ä¸ª CCR å®ä¾‹å¯ä»¥åŒæ—¶ç®¡ç†å¤šä¸ªåˆ°ä¸åŒ AI æ¨¡å‹ API çš„è¿æ¥ï¼Œå¹¶åœ¨å®ƒä»¬ä¹‹é—´å¤ç”¨èµ„æºã€‚è¿™ä¸ä»…æé«˜äº†ç³»ç»Ÿçš„ååé‡å’Œå“åº”é€Ÿåº¦ï¼Œä¹Ÿé™ä½äº†èµ„æºæ¶ˆè€—ã€‚ä¾‹å¦‚ï¼Œå½“ CCR åœ¨ç­‰å¾…ä¸€ä¸ªè€—æ—¶è¾ƒé•¿çš„æ¨¡å‹å“åº”æ—¶ï¼Œå®ƒå¯ä»¥åŒæ—¶å¤„ç†æ•°åç”šè‡³æ•°ç™¾ä¸ªå…¶ä»–è¯·æ±‚ï¼Œä»è€Œæœ€å¤§é™åº¦åœ°åˆ©ç”¨æœåŠ¡å™¨èµ„æºã€‚

ç»¼ä¸Šæ‰€è¿°ï¼Œä¸­é—´ä»¶æ¶æ„ä¸º CCR æä¾›äº†æ¨¡å—åŒ–å’Œå¯æ‰©å±•æ€§ï¼Œè€Œå¼‚æ­¥å¤„ç†åˆ™ä¿éšœäº†å…¶åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹çš„æ€§èƒ½å’Œæ•ˆç‡ã€‚è¿™ä¸¤è€…å…±åŒæ„æˆäº† CCR ç¨³å¥å¤„ç†è¯·æ±‚è½¬æ¢ä¸è½¬å‘çš„åŸºçŸ³ã€‚

## 5. é”™è¯¯å¤„ç†ä¸é™çº§ç­–ç•¥

åœ¨ä»»ä½•å¤æ‚çš„åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œé”™è¯¯å’Œå¼‚å¸¸éƒ½æ˜¯ä¸å¯é¿å…çš„ã€‚å¯¹äº Claude-Code-Router (CCR) è¿™æ ·ä¸€ä¸ªä½œä¸º AI æœåŠ¡è°ƒç”¨é“¾è·¯ä¸­å…³é”®ä¸€ç¯çš„ç»„ä»¶ï¼Œå…¶é”™è¯¯å¤„ç†ä¸é™çº§ç­–ç•¥çš„å¥å£®æ€§ç›´æ¥å…³ç³»åˆ°æ•´ä¸ªåº”ç”¨ç³»ç»Ÿçš„å¯ç”¨æ€§å’Œç”¨æˆ·ä½“éªŒã€‚CCR çš„è®¾è®¡å¿…é¡»èƒ½å¤Ÿå¦¥å–„å¤„ç†å„ç§å¯èƒ½å‘ç”Ÿçš„é”™è¯¯æƒ…å†µï¼Œä»è½»å¾®çš„ç½‘ç»œæ³¢åŠ¨åˆ°ä¸¥é‡çš„æ¨¡å‹æœåŠ¡æ•…éšœï¼Œå¹¶ç¡®ä¿åœ¨å‡ºç°é—®é¢˜æ—¶èƒ½å¤Ÿæœ€å¤§é™åº¦åœ°ç»´æŒæœåŠ¡åŠŸèƒ½æˆ–ä¼˜é›…åœ°é™çº§ï¼Œè€Œä¸æ˜¯å®Œå…¨å´©æºƒã€‚

### 5.1. é”™è¯¯æ£€æµ‹ä¸è‡ªåŠ¨é™çº§æœºåˆ¶

CCR çš„é”™è¯¯æ£€æµ‹æœºåˆ¶è´¯ç©¿äºå…¶æ ¸å¿ƒå¤„ç†æµç¨‹çš„å„ä¸ªé˜¶æ®µã€‚å®ƒéœ€è¦èƒ½å¤Ÿè¯†åˆ«æ¥è‡ªä¸åŒæºçš„é”™è¯¯ï¼Œå¹¶é‡‡å–ç›¸åº”çš„åº”å¯¹æªæ–½ã€‚

**é”™è¯¯æ¥æºä¸æ£€æµ‹**ï¼š

1. **è·¯ç”±å†³ç­–é”™è¯¯**ï¼šåœ¨æ™ºèƒ½è·¯ç”±é˜¶æ®µï¼Œå¦‚æœåˆ†æè¯·æ±‚æˆ–åº”ç”¨è·¯ç”±è§„åˆ™æ—¶å‘ç”Ÿé”™è¯¯ï¼ˆä¾‹å¦‚ï¼Œæ— æ³•è¯†åˆ«åˆé€‚çš„æ¨¡å‹ï¼Œæˆ–è€…é…ç½®çš„è·¯ç”±è§„åˆ™å­˜åœ¨å†²çªï¼‰ï¼ŒCCR éœ€è¦èƒ½å¤Ÿæ•è·è¿™äº›é€»è¾‘é”™è¯¯ã€‚
2. **Token åˆ†æé”™è¯¯**ï¼šåœ¨åˆ†æè¯·æ±‚çš„ Token æ•°é‡æˆ–å†…å®¹æ—¶ï¼Œå¦‚æœå‘ç”Ÿè§£æé”™è¯¯æˆ–è¶…å‡ºç³»ç»Ÿå¤„ç†èƒ½åŠ›ï¼Œè¿™ä¹Ÿéœ€è¦è¢«æ£€æµ‹åˆ° ã€‚
3. **API è½¬æ¢é”™è¯¯**ï¼šåœ¨å°†è¯·æ±‚ä»ä¸€ç§ API æ ¼å¼è½¬æ¢ä¸ºå¦ä¸€ç§æ ¼å¼æ—¶ï¼Œå¯èƒ½ä¼šå› ä¸ºå­—æ®µä¸åŒ¹é…ã€æ•°æ®ç±»å‹é”™è¯¯æˆ–è½¬æ¢é€»è¾‘ç¼ºé™·è€Œå¯¼è‡´é”™è¯¯ã€‚
4. **æ¨¡å‹ API è°ƒç”¨é”™è¯¯**ï¼šè¿™æ˜¯æœ€å¸¸è§çš„é”™è¯¯æ¥æºã€‚å½“ CCR å‘ç›®æ ‡ AI æ¨¡å‹çš„ API ç«¯ç‚¹è½¬å‘è¯·æ±‚æ—¶ï¼Œå¯èƒ½ä¼šé‡åˆ°å¤šç§é—®é¢˜ï¼Œä¾‹å¦‚ï¼š
    - **ç½‘ç»œé”™è¯¯**ï¼šè¿æ¥è¶…æ—¶ã€DNS è§£æå¤±è´¥ã€è¿æ¥è¢«æ‹’ç»ç­‰ã€‚
    - **è®¤è¯é”™è¯¯**ï¼šAPI Key æ— æ•ˆæˆ–è¿‡æœŸã€‚
    - **é™æµé”™è¯¯**ï¼šAPI è°ƒç”¨é¢‘ç‡è¶…å‡ºé…é¢ã€‚
    - **æ¨¡å‹æœåŠ¡é”™è¯¯**ï¼šæ¨¡å‹æœ¬èº«å¤„ç†è¯·æ±‚æ—¶å‘ç”Ÿå†…éƒ¨é”™è¯¯ï¼Œè¿”å› 5xx ç³»åˆ—çŠ¶æ€ç ã€‚
    - **æ— æ•ˆè¯·æ±‚é”™è¯¯**ï¼šå‘é€ç»™æ¨¡å‹ API çš„è¯·æ±‚å‚æ•°ä¸æ­£ç¡®æˆ–ä¸å®Œæ•´ï¼Œè¿”å› 4xx ç³»åˆ—çŠ¶æ€ç ã€‚
5. **å“åº”å¤„ç†é”™è¯¯**ï¼šåœ¨æ¥æ”¶åˆ°æ¨¡å‹ API çš„å“åº”åï¼Œå¦‚æœå“åº”æ ¼å¼ä¸ç¬¦åˆé¢„æœŸï¼Œæˆ–è€…åœ¨å°†å“åº”è½¬æ¢å›å®¢æˆ·ç«¯æ ¼å¼æ—¶å‘ç”Ÿé”™è¯¯ã€‚

**è‡ªåŠ¨é™çº§æœºåˆ¶**ï¼š
å½“ CCR æ£€æµ‹åˆ°ä¸Šè¿°é”™è¯¯æ—¶ï¼Œå…¶æ ¸å¿ƒçš„è‡ªåŠ¨é™çº§ç­–ç•¥æ˜¯**å›é€€åˆ°é»˜è®¤æ¨¡å‹** ã€‚è¿™æ„å‘³ç€å¦‚æœæ™ºèƒ½è·¯ç”±é€»è¾‘æœ¬èº«å‡ºç°é—®é¢˜ï¼Œæˆ–è€…ç›®æ ‡æ¨¡å‹ API è°ƒç”¨å¤±è´¥ï¼ŒCCR ä¼šå°è¯•å°†è¯·æ±‚å‘é€ç»™é…ç½®æ–‡ä»¶ä¸­å®šä¹‰çš„ `default` è·¯ç”±æ‰€æŒ‡å‘çš„æ¨¡å‹ã€‚è¿™ä¸ªé»˜è®¤æ¨¡å‹é€šå¸¸æ˜¯ä¸€ä¸ªç›¸å¯¹ç¨³å®šã€é€šç”¨æ€§è¾ƒå¼ºçš„æ¨¡å‹ï¼Œä½œä¸ºæ•´ä¸ªç³»ç»Ÿçš„å®‰å…¨ç½‘ã€‚ä¾‹å¦‚ï¼Œå¦‚æœ CCR å°è¯•å°†ä¸€ä¸ªå¤æ‚æ¨ç†ä»»åŠ¡è·¯ç”±åˆ°ä¸“é—¨çš„ `think` æ¨¡å‹æ—¶å¤±è´¥ï¼Œå®ƒä¼šè‡ªåŠ¨å°†è¿™ä¸ªè¯·æ±‚è½¬è€Œå‘é€ç»™ `default` æ¨¡å‹ã€‚è™½ç„¶ `default` æ¨¡å‹åœ¨å¤„ç†ç‰¹å®šç±»å‹ä»»åŠ¡ä¸Šçš„æ€§èƒ½å¯èƒ½ä¸å¦‚ç‰¹åŒ–æ¨¡å‹ï¼Œä½†è¿™ç§é™çº§ç¡®ä¿äº†æœåŠ¡çš„åŸºæœ¬å¯ç”¨æ€§ï¼Œç”¨æˆ·ä»ç„¶èƒ½å¤Ÿå¾—åˆ°å“åº”ã€‚

è¿™ç§è‡ªåŠ¨é™çº§æœºåˆ¶çš„è®¾è®¡è€ƒè™‘åˆ°äº†ä»¥ä¸‹å‡ ä¸ªå…³é”®ç‚¹ï¼š

- **å¿«é€Ÿå¤±è´¥ä¸å›é€€**ï¼šå½“æ£€æµ‹åˆ°ä¸»è¦å¤„ç†è·¯å¾„ä¸Šçš„é”™è¯¯æ—¶ï¼ŒCCR ä¼šå°½å¿«ä¸­æ–­å½“å‰æµç¨‹ï¼Œå¹¶åˆ‡æ¢åˆ°é™çº§è·¯å¾„ã€‚
- **æœåŠ¡è¿ç»­æ€§**ï¼šé€šè¿‡é™çº§åˆ°é»˜è®¤æ¨¡å‹ï¼ŒCCR æœ€å¤§é™åº¦åœ°ä¿è¯äº†æ ¸å¿ƒæœåŠ¡çš„è¿ç»­æ€§ã€‚
- **å¯é…ç½®æ€§**ï¼šè™½ç„¶èµ„æ–™ä¸­æ˜ç¡®æåˆ°é™çº§åˆ°â€œé»˜è®¤æ¨¡å‹â€ï¼Œä½†åœ¨å®é™…å®ç°ä¸­ï¼Œé™çº§ç­–ç•¥æœ¬èº«ä¹Ÿå¯èƒ½æ˜¯å¯é…ç½®çš„ã€‚
- **é”™è¯¯éš”ç¦»**ï¼šCCR çš„æ’ä»¶æœºåˆ¶ä¹Ÿå…·æœ‰ä¸€å®šçš„é”™è¯¯éš”ç¦»èƒ½åŠ›ã€‚èµ„æ–™æåˆ°ï¼Œæ’ä»¶â€œå‡ºé”™ä¹Ÿä¸ä¼šå½±å“ä¸»æµç¨‹ï¼Œå®‰å…¨å¯é â€ ã€‚

æ­¤å¤–ï¼Œè¯¦ç»†çš„æ—¥å¿—è®°å½•ä¹Ÿæ˜¯é”™è¯¯å¤„ç†çš„é‡è¦ç»„æˆéƒ¨åˆ†ã€‚CCR ä¼šè®°å½•ä¸‹å‘ç”Ÿçš„é”™è¯¯ã€é™çº§å†³ç­–ä»¥åŠç›¸å…³çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ ã€‚è¿™äº›æ—¥å¿—å¯¹äºåç»­çš„é—®é¢˜æ’æŸ¥ã€ç³»ç»Ÿç›‘æ§å’Œæ€§èƒ½ä¼˜åŒ–è‡³å…³é‡è¦ã€‚

### 5.2. å…œåº•æ¨¡å‹ä¸é‡è¯•ç­–ç•¥

Claude-Code-Router (CCR) çš„ç¨³å®šæ€§å’Œå¯é æ€§åœ¨ä¸€å®šç¨‹åº¦ä¸Šä¾èµ–äºå…¶å…œåº•æ¨¡å‹æœºåˆ¶å’Œæ½œåœ¨çš„é‡è¯•ç­–ç•¥ã€‚è¿™äº›ç­–ç•¥å…±åŒæ„æˆäº† CCR åœ¨é‡åˆ°éé¢„æœŸæƒ…å†µæ—¶çš„æœ€åä¸€é“é˜²çº¿ï¼Œç¡®ä¿ç”¨æˆ·è¯·æ±‚è‡³å°‘èƒ½å¤Ÿå¾—åˆ°ä¸€ä¸ªå“åº”ï¼Œå³ä½¿ä¸æ˜¯æœ€ä¼˜çš„ã€‚

**å…œåº•æ¨¡å‹æœºåˆ¶**ï¼š
CCR çš„æ ¸å¿ƒè®¾è®¡åŸåˆ™ä¹‹ä¸€æ˜¯åœ¨å…¶æ™ºèƒ½è·¯ç”±å†³ç­–çš„å…³é”®ç¯èŠ‚å‘ç”Ÿé”™è¯¯æ—¶ï¼Œèƒ½å¤Ÿè‡ªåŠ¨é™çº§åˆ°é¢„è®¾çš„é»˜è®¤æ¨¡å‹ ã€‚è¿™ä¸ªâ€œé»˜è®¤æ¨¡å‹â€åœ¨ CCR çš„é…ç½®æ–‡ä»¶ `~/.claude-code-router/config.json` çš„ `Router` éƒ¨åˆ†é€šå¸¸è¢«å®šä¹‰ä¸º `default` è·¯ç”±ç­–ç•¥æ‰€æŒ‡å‘çš„æ¨¡å‹ ã€‚ä¾‹å¦‚ï¼Œé…ç½®æ–‡ä»¶ä¸­å¯èƒ½ä¼šæœ‰å¦‚ä¸‹è®¾ç½®ï¼š

```json
"Router": {
  "default": "openai,deepseek-chat",
  "background": "ollama,qwen2.5-coder:latest",
  "think": "deepseek,deepseek-reasoner",
  "longContext": "openrouter,google/gemini-2.5-pro-preview"
}
```

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå¦‚æœ CCR åœ¨ Token åˆ†ææˆ–è·¯ç”±åŒ¹é…è¿‡ç¨‹ä¸­é‡åˆ°æ— æ³•å¤„ç†çš„é”™è¯¯ï¼Œæˆ–è€…æ²¡æœ‰ä»»ä½•å…¶ä»–ç‰¹å®šè·¯ç”±è§„åˆ™ï¼ˆå¦‚ `background`, `think`, `longContext`ï¼‰è¢«è§¦å‘ï¼Œé‚£ä¹ˆè¯·æ±‚å°†è¢«å‘é€åˆ° `openai,deepseek-chat` è¿™ä¸ªæ¨¡å‹ç»„åˆï¼ˆå…·ä½“æŒ‡å‘å“ªä¸ªï¼Œå¯èƒ½è¿˜å–å†³äºæä¾›å•†å†…éƒ¨çš„è´Ÿè½½å‡è¡¡æˆ–ä¼˜å…ˆçº§ï¼‰ã€‚è¿™ä¸ª `default` æ¨¡å‹å……å½“äº†ç³»ç»Ÿçš„å®‰å…¨ç½‘ï¼Œä¿è¯äº†å³ä½¿æ™ºèƒ½è·¯ç”±åŠŸèƒ½éƒ¨åˆ†å¤±æ•ˆï¼ŒCCR ä¾ç„¶èƒ½å¤Ÿä½œä¸ºä¸€ä¸ªæœ‰æ•ˆçš„ API ç½‘å…³ï¼Œå°†è¯·æ±‚ä»£ç†åˆ°ä¸€ä¸ªå¯ç”¨çš„åç«¯æœåŠ¡ã€‚é€‰æ‹©å“ªä¸ªæ¨¡å‹ä½œä¸ºé»˜è®¤æ¨¡å‹ï¼Œé€šå¸¸éœ€è¦æƒè¡¡å…¶é€šç”¨æ€§ã€å¯ç”¨æ€§ã€æˆæœ¬ä»¥åŠå¤„ç†ä¸€èˆ¬æ€§ä»»åŠ¡çš„èƒ½åŠ›ã€‚

**é‡è¯•ç­–ç•¥**ï¼š
å…³äº CCR æœ¬èº«å†…ç½®çš„é‡è¯•ç­–ç•¥ï¼Œåœ¨åŸºç¡€ç‰ˆæœ¬çš„èµ„æ–™ä¸­æåŠä¸å¤šï¼Œä½†é”™è¯¯å¤„ç†å’Œç³»ç»Ÿé²æ£’æ€§çš„éœ€æ±‚ä½¿å¾—é‡è¯•æˆä¸ºä¸€ä¸ªé‡è¦çš„è€ƒé‡ç‚¹ã€‚ä¸€äº›ç”±ç¤¾åŒºè´¡çŒ®çš„å¢å¼ºç‰ˆæœ¬ï¼Œä¾‹å¦‚ `@jasonzhangf/claude-code-router-enhanced`ï¼Œæ˜ç¡®å¢åŠ äº†é‡è¯•æœºåˆ¶ ã€‚è¿™ç§é‡è¯•æœºåˆ¶é€šå¸¸ç”¨äºå¤„ç†ä¸´æ—¶æ€§çš„æ•…éšœï¼Œä¾‹å¦‚ç½‘ç»œæ³¢åŠ¨ã€ç›®æ ‡æ¨¡å‹ API çš„ç¬æ—¶é«˜è´Ÿè½½æˆ–çŸ­æš‚çš„ä¸å¯ç”¨ã€‚

ä¸€ä¸ªå…¸å‹çš„ HTTP è¯·æ±‚é‡è¯•ç­–ç•¥å¯èƒ½åŒ…æ‹¬ä»¥ä¸‹è¦ç´ ï¼š

- **é‡è¯•æ¡ä»¶**ï¼šå¹¶éæ‰€æœ‰é”™è¯¯éƒ½åº”è¯¥è¢«é‡è¯•ã€‚ä¾‹å¦‚ï¼Œå¯¹äºå› æ— æ•ˆè¯·æ±‚å‚æ•°å¯¼è‡´çš„ 400 Bad Request é”™è¯¯ï¼Œé‡è¯•é€šå¸¸æ²¡æœ‰æ„ä¹‰ã€‚é‡è¯•é€šå¸¸é€‚ç”¨äºæœåŠ¡å™¨é”™è¯¯ï¼ˆ5xx ç³»åˆ—ï¼‰æˆ–ç‰¹å®šçš„å®¢æˆ·ç«¯é”™è¯¯ï¼Œå¦‚è¯·æ±‚è¶…æ—¶æˆ–é€Ÿç‡é™åˆ¶ï¼ˆ429 Too Many Requestsï¼‰ã€‚
- **é‡è¯•æ¬¡æ•°**ï¼šé€šå¸¸ä¼šè®¾ç½®ä¸€ä¸ªæœ€å¤§é‡è¯•æ¬¡æ•°ã€‚
- **é‡è¯•é—´éš”**ï¼šé‡è¯•ä¹‹é—´çš„æ—¶é—´é—´éš”å¯ä»¥æ˜¯å›ºå®šçš„ï¼Œä¹Ÿå¯ä»¥æ˜¯é€’å¢çš„ï¼ˆä¾‹å¦‚ï¼ŒæŒ‡æ•°é€€é¿ç®—æ³•ï¼‰ã€‚
- **å¹‚ç­‰æ€§è€ƒè™‘**ï¼šå¦‚æœè¯·æ±‚ä¸æ˜¯å¹‚ç­‰çš„ï¼Œé‡è¯•éœ€è¦ç‰¹åˆ«å°å¿ƒã€‚

å¯¹äº CCR è€Œè¨€ï¼Œå¦‚æœå…¶è½¬å‘è¯·æ±‚åˆ°ç›®æ ‡æ¨¡å‹ API æ—¶é‡åˆ°å¯é‡è¯•çš„é”™è¯¯ï¼Œä¸€ä¸ªåˆç†çš„é‡è¯•ç­–ç•¥å¯ä»¥å¸®åŠ©æé«˜è¯·æ±‚çš„æœ€ç»ˆæˆåŠŸç‡ã€‚ä¾‹å¦‚ï¼Œå¦‚æœç›®æ ‡æ¨¡å‹è¿”å› `524` é”™è¯¯ï¼ˆé€šå¸¸è¡¨ç¤ºç½‘å…³è¶…æ—¶ï¼‰æˆ– `503` é”™è¯¯ï¼ˆæœåŠ¡ä¸å¯ç”¨ï¼‰ï¼ŒCCR å¯ä»¥é€‰æ‹©åœ¨çŸ­æš‚å»¶è¿Ÿåé‡è¯•è¯¥è¯·æ±‚ ã€‚å¦‚æœå¤šæ¬¡é‡è¯•åä»ç„¶å¤±è´¥ï¼ŒCCR å¯èƒ½ä¼šé€‰æ‹©é™çº§åˆ°å…œåº•æ¨¡å‹ï¼Œæˆ–è€…æœ€ç»ˆå‘ç”¨æˆ·è¿”å›ä¸€ä¸ªé”™è¯¯ä¿¡æ¯ã€‚

æ­¤å¤–ï¼ŒClaude Code æœ¬èº«ï¼ˆä½œä¸º CCR çš„å®¢æˆ·ç«¯æˆ–ä¸Šæ¸¸ï¼‰åœ¨å¤„ç†å…¶å†…éƒ¨æ“ä½œæ—¶ï¼Œä¹Ÿå¯èƒ½æœ‰è‡ªå·±çš„é‡è¯•é€»è¾‘ã€‚ä¾‹å¦‚ï¼Œå½“é‡åˆ° `tool_call_error` æˆ– `request_timeout` æ—¶ï¼Œç”¨æˆ·å¯ä»¥å°è¯•å›é€€åˆ°ä¸Šä¸€æ¡æ¶ˆæ¯è¿›è¡Œé‡è¯•ï¼Œæˆ–è€…é‡å¯ Claude Code ã€‚CCR ä½œä¸ºå…¶ä»£ç†ï¼Œéœ€è¦èƒ½å¤Ÿå¦¥å–„å¤„ç†ä¸Šæ¸¸å¯èƒ½è§¦å‘çš„é‡è¯•æˆ–é”™è¯¯çŠ¶æ€ã€‚

ç»¼ä¸Šæ‰€è¿°ï¼ŒCCR é€šè¿‡æ˜ç¡®çš„å…œåº•æ¨¡å‹æœºåˆ¶å’Œå¯èƒ½é€šè¿‡ç¤¾åŒºæ‰©å±•å®ç°çš„é‡è¯•ç­–ç•¥ï¼Œå¢å¼ºäº†å…¶åœ¨é¢å¯¹é”™è¯¯å’Œä¸´æ—¶æ•…éšœæ—¶çš„éŸ§æ€§ï¼Œè‡´åŠ›äºä¸ºç”¨æˆ·æä¾›ä¸€ä¸ªç›¸å¯¹ç¨³å®šå’Œå¯é çš„å¤šæ¨¡å‹è·¯ç”±æœåŠ¡ã€‚

## 6. æ¶æ„è®¾è®¡ä¸æŠ€æœ¯å®ç°

Claude-Code-Router (CCR) çš„æ¶æ„è®¾è®¡å……åˆ†è€ƒè™‘äº†çµæ´»æ€§ã€å¯æ‰©å±•æ€§å’Œæ˜“ç”¨æ€§ï¼Œä½¿å…¶èƒ½å¤Ÿä½œä¸ºä¸€ä¸ªå¼ºå¤§çš„ AI æ¨¡å‹è°ƒåº¦ä¸­æ¢ã€‚å…¶æ ¸å¿ƒåŸºäº Node.js çš„ Express.js æ¡†æ¶ï¼Œå¹¶é‡‡ç”¨äº†æ¨¡å—åŒ–è®¾è®¡å’Œé…ç½®é©±åŠ¨çš„ç†å¿µï¼Œä½¿å¾—ç”¨æˆ·å¯ä»¥æ ¹æ®è‡ªèº«éœ€æ±‚è½»æ¾å®šåˆ¶å’Œæ‰©å±•å…¶åŠŸèƒ½ã€‚æ’ä»¶æœºåˆ¶çš„å¼•å…¥è¿›ä¸€æ­¥å¢å¼ºäº† CCR çš„çµæ´»æ€§ï¼Œå…è®¸å¼€å‘è€…é€šè¿‡ç¼–å†™ç®€å•çš„ä¸­é—´ä»¶æ¥å¹²é¢„è¯·æ±‚å¤„ç†æµç¨‹ï¼Œå®ç°æ›´å¤æ‚çš„å®šåˆ¶åŒ–éœ€æ±‚ã€‚è¿™ç§æ¶æ„ä¸ä»…ä½¿å¾— CCR èƒ½å¤Ÿé«˜æ•ˆåœ°å¤„ç†è·¯ç”±é€»è¾‘ï¼Œè¿˜ä¸ºå…¶æœªæ¥çš„åŠŸèƒ½è¿­ä»£å’Œç¤¾åŒºè´¡çŒ®å¥ å®šäº†åšå®çš„åŸºç¡€ã€‚

### 6.1. Express.js æ ¸å¿ƒä¸æ¨¡å—åŒ–è®¾è®¡

Claude-Code-Router (CCR) çš„æ ¸å¿ƒæœåŠ¡æ˜¯æ„å»ºåœ¨ **Node.js** å¹³å°ä¹‹ä¸Šçš„ï¼Œå¹¶é€‰æ‹©äº† **Express.js** ä½œä¸ºå…¶ä¸»è¦çš„ Web åº”ç”¨æ¡†æ¶ ã€‚Express.js ä»¥å…¶è½»é‡çº§ã€é«˜æ€§èƒ½å’Œçµæ´»çš„ä¸­é—´ä»¶æ¶æ„è€Œé—»åï¼Œéå¸¸é€‚åˆæ„å»º API æœåŠ¡å’Œå¤„ç† HTTP è¯·æ±‚/å“åº”å¾ªç¯ã€‚CCR åˆ©ç”¨ Express.js æ¥åˆ›å»º HTTP æœåŠ¡å™¨ï¼Œç›‘å¬ç‰¹å®šçš„ç«¯å£ï¼ˆå¦‚ `localhost:3456`ï¼‰ï¼Œå¹¶å®šä¹‰è·¯ç”±ç«¯ç‚¹ï¼ˆå¦‚ `/v1/messages`ï¼‰æ¥æ¥æ”¶æ¥è‡ª Claude Code å®¢æˆ·ç«¯æˆ–å…¶ä»–å…¼å®¹å®¢æˆ·ç«¯çš„è¯·æ±‚ ã€‚

**æ¨¡å—åŒ–è®¾è®¡**æ˜¯ CCR æ¶æ„çš„å¦ä¸€ä¸ªæ˜¾è‘—ç‰¹ç‚¹ã€‚é€šè¿‡å°†ä¸åŒçš„åŠŸèƒ½èŒè´£åˆ’åˆ†åˆ°ç‹¬ç«‹çš„æ¨¡å—æˆ–ä¸­é—´ä»¶ä¸­ï¼ŒCCR çš„ä»£ç ç»“æ„ä¿æŒäº†æ¸…æ™°å’Œå¯ç»´æŠ¤æ€§ã€‚ä¾‹å¦‚ï¼Œè¯·æ±‚æ‹¦æˆªã€Token åˆ†æã€è·¯ç”±å†³ç­–é€»è¾‘ã€API æ ¼å¼è½¬æ¢ã€æ¨¡å‹é€‚é…å™¨ã€é”™è¯¯å¤„ç†ç­‰éƒ½å¯ä»¥ä½œä¸ºç‹¬ç«‹çš„æ¨¡å—æˆ–ä¸€ç³»åˆ—ä¸­é—´ä»¶æ¥å®ç°ã€‚è¿™ç§æ¨¡å—åŒ–çš„æ–¹å¼ä¸ä»…ä½¿å¾—å„ä¸ªåŠŸèƒ½å•å…ƒæ˜“äºç†è§£å’Œæµ‹è¯•ï¼Œä¹Ÿé™ä½äº†æ¨¡å—é—´çš„è€¦åˆåº¦ï¼Œä¾¿äºå›¢é˜Ÿåä½œå¼€å‘å’Œåç»­çš„åŠŸèƒ½è¿­ä»£ã€‚ä¾‹å¦‚ï¼Œå¦‚æœéœ€è¦æ”¯æŒä¸€ä¸ªæ–°çš„ AI æ¨¡å‹ APIï¼Œå¼€å‘è€…åªéœ€è¦å…³æ³¨å®ç°è¯¥æ¨¡å‹ç‰¹å®šçš„è¯·æ±‚è½¬æ¢å’Œå“åº”è½¬æ¢æ¨¡å—ï¼Œè€Œæ— éœ€æ”¹åŠ¨æ ¸å¿ƒçš„è·¯ç”±é€»è¾‘ã€‚Express.js çš„ä¸­é—´ä»¶æœºåˆ¶å¤©ç„¶æ”¯æŒè¿™ç§æ¨¡å—åŒ–çš„ç»„ç»‡æ–¹å¼ï¼Œæ¯ä¸ªä¸­é—´ä»¶å¤„ç†è¯·æ±‚-å“åº”å¾ªç¯ä¸­çš„ä¸€ä¸ªç‰¹å®šé˜¶æ®µï¼Œå¹¶é€šè¿‡ `next()` å‡½æ•°å°†æ§åˆ¶æƒä¼ é€’ç»™ä¸‹ä¸€ä¸ªä¸­é—´ä»¶ã€‚

### 6.2. é…ç½®é©±åŠ¨ä¸æ’ä»¶æœºåˆ¶

Claude-Code-Router (CCR) çš„è®¾è®¡å“²å­¦ä¹‹ä¸€æ˜¯**é…ç½®é©±åŠ¨**ï¼Œè¿™æ„å‘³ç€å¤§éƒ¨åˆ†è·¯ç”±è§„åˆ™å’Œæ¨¡å‹æ˜ å°„éƒ½å¯ä»¥é€šè¿‡é…ç½®æ–‡ä»¶è¿›è¡Œç®¡ç†ï¼Œè€Œæ— éœ€ä¿®æ”¹æ ¸å¿ƒä»£ç  ã€‚ä¾‹å¦‚ï¼Œç”¨æˆ·å¯ä»¥åœ¨é…ç½®æ–‡ä»¶ï¼ˆé€šå¸¸æ˜¯ `~/.claude-code-router/config.json`ï¼‰ä¸­å®šä¹‰ä¸åŒè·¯ç”±ï¼ˆå¦‚ `think`, `longContext`, `default`ï¼‰å¯¹åº”çš„ç›®æ ‡æ¨¡å‹æˆ–æ¨¡å‹åˆ—è¡¨ ã€‚è¿™ç§é…ç½®é©±åŠ¨çš„æ–¹å¼é™ä½äº†ä½¿ç”¨é—¨æ§›ï¼Œä½¿å¾—éå¼€å‘è€…ä¹Ÿèƒ½æ ¹æ®ä¸šåŠ¡éœ€æ±‚è°ƒæ•´è·¯ç”±ç­–ç•¥ã€‚æ›´é‡è¦çš„æ˜¯ï¼ŒCCR å¼•å…¥äº†ä¸€ä¸ªå¼ºå¤§çš„**æ’ä»¶æœºåˆ¶**ï¼Œå…è®¸å¼€å‘è€…é€šè¿‡ç¼–å†™è‡ªå®šä¹‰æ’ä»¶æ¥æ‰©å±•å…¶åŠŸèƒ½ ã€‚è¿™äº›æ’ä»¶éµå¾ª Express.js ä¸­é—´ä»¶çš„é£æ ¼ï¼Œé€šå¸¸æ˜¯ä¸€ä¸ªå¯¼å‡º `function(req, res, next)` çš„æ¨¡å— ã€‚CCR ä¼šè‡ªåŠ¨åŠ è½½æ”¾ç½®åœ¨æŒ‡å®šæ’ä»¶ç›®å½•ï¼ˆé€šå¸¸æ˜¯ `~/.claude-code-router/plugins/`ï¼‰ä¸‹çš„æ’ä»¶ï¼Œå¹¶åœ¨è¯·æ±‚å¤„ç†æµç¨‹çš„ç‰¹å®šé˜¶æ®µè°ƒç”¨å®ƒä»¬ã€‚æ’ä»¶å¯ä»¥ç”¨äºå®ç°å„ç§åŠŸèƒ½ï¼Œä¾‹å¦‚åŠ¨æ€ä¿®æ”¹è¯·æ±‚ä½“ï¼ˆå¦‚è¿‡æ»¤ä¸æ”¯æŒçš„å‚æ•°ã€è°ƒæ•´å·¥å…·å®šä¹‰æ ¼å¼ï¼‰ã€å®ç°æ›´å¤æ‚çš„è·¯ç”±ç­–ç•¥ï¼ˆå¦‚æŒ‰æ—¶é—´æ®µã€Token æ¶ˆè€—ã€ç”¨æˆ· ID åˆ†æµï¼‰ã€æ¥å…¥è‡ªå®šä¹‰çš„æ—¥å¿—ã€ç›‘æ§ã€é™æµç­‰åŠŸèƒ½ ã€‚æ’ä»¶æœºåˆ¶çš„å¦ä¸€ä¸ªå…³é”®ä¼˜åŠ¿åœ¨äºå…¶å¥å£®æ€§ï¼šå³ä½¿æŸä¸ªæ’ä»¶å‘ç”Ÿé”™è¯¯ï¼Œä¹Ÿä¸ä¼šå½±å“ CCR ä¸»æµç¨‹çš„æ­£å¸¸è¿è¡Œï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æ•è·æ’ä»¶é”™è¯¯å¹¶è¿›è¡Œé™çº§å¤„ç†ï¼Œç¡®ä¿æœåŠ¡çš„ç¨³å®šæ€§ ã€‚è¿™ç§è®¾è®¡ä½¿å¾— CCR æˆä¸ºä¸€ä¸ªé«˜åº¦å¯å®šåˆ¶å’Œå¯æ‰©å±•çš„å¹³å°ï¼Œèƒ½å¤Ÿé€‚åº”å„ç§å¤æ‚çš„åº”ç”¨åœºæ™¯ã€‚

### 6.3. æ€§èƒ½ä¼˜åŒ–ä¸èµ„æºç®¡ç†

Claude-Code-Router (CCR) åœ¨æ¶æ„è®¾è®¡å’ŒæŠ€æœ¯å®ç°ä¸Šè€ƒè™‘äº†å¤šæ–¹é¢çš„æ€§èƒ½ä¼˜åŒ–ä¸èµ„æºç®¡ç†ç­–ç•¥ï¼Œä»¥ç¡®ä¿å…¶ä½œä¸ºAIæ¨¡å‹è·¯ç”±ä¸­æ¢çš„é«˜æ•ˆä¸ç¨³å®šã€‚é¦–å…ˆï¼Œ**å¼‚æ­¥éé˜»å¡I/O**æ˜¯å…¶æ ¸å¿ƒæ€§èƒ½ä¿éšœã€‚åŸºäºNode.jsçš„Express.jsæ¡†æ¶ï¼ŒCCRåœ¨å¤„ç†è€—æ—¶çš„AIæ¨¡å‹APIè°ƒç”¨æ—¶ï¼Œèƒ½å¤Ÿé€šè¿‡å¼‚æ­¥æœºåˆ¶é¿å…é˜»å¡ä¸»çº¿ç¨‹ï¼Œä»è€Œé«˜æ•ˆåœ°å¹¶å‘å¤„ç†å¤§é‡ç”¨æˆ·è¯·æ±‚ï¼Œæ˜¾è‘—æå‡ç³»ç»Ÿçš„ååé‡å’Œå“åº”é€Ÿåº¦ ã€‚å…¶æ¬¡ï¼Œ**æ¨¡å—åŒ–è®¾è®¡ä¸ä¸­é—´ä»¶æ¶æ„**ä¸ä»…æå‡äº†ä»£ç çš„å¯ç»´æŠ¤æ€§å’Œå¯æ‰©å±•æ€§ï¼Œä¹Ÿé—´æ¥ä¼˜åŒ–äº†æ€§èƒ½ã€‚é€šè¿‡å°†åŠŸèƒ½åˆ†è§£ä¸ºç‹¬ç«‹çš„ä¸­é—´ä»¶ï¼Œå¯ä»¥é’ˆå¯¹æ€§åœ°å¯¹æ€§èƒ½ç“¶é¢ˆè¿›è¡Œä¼˜åŒ–ï¼Œå¹¶ä¸”å¯ä»¥æ–¹ä¾¿åœ°é›†æˆé«˜æ•ˆçš„ç¬¬ä¸‰æ–¹åº“æˆ–è‡ªå®šä¹‰ä¼˜åŒ–é€»è¾‘ã€‚ä¾‹å¦‚ï¼ŒTokenåˆ†ææ¨¡å—å¯ä»¥ä½¿ç”¨é«˜æ•ˆçš„`tiktoken`åº“è¿›è¡Œå¿«é€Ÿè®¡ç®— ã€‚

åœ¨èµ„æºç®¡ç†æ–¹é¢ï¼ŒCCRé€šè¿‡**æ™ºèƒ½è·¯ç”±å†³ç­–**å®ç°äº†è®¡ç®—èµ„æºçš„ä¼˜åŒ–åˆ†é…ã€‚é€šè¿‡å°†ä¸åŒç±»å‹çš„ä»»åŠ¡ï¼ˆå¦‚åå°ä»»åŠ¡ã€æ¨ç†ä»»åŠ¡ã€é•¿ä¸Šä¸‹æ–‡ä»»åŠ¡ï¼‰è·¯ç”±åˆ°æœ€åˆé€‚çš„ã€æˆæœ¬æ•ˆç›Šæœ€ä¼˜çš„æ¨¡å‹ï¼ŒCCRèƒ½å¤Ÿé¿å…å¯¹é«˜æ€§èƒ½é«˜æˆæœ¬æ¨¡å‹çš„è¿‡åº¦ä¾èµ–ï¼Œä»è€Œåœ¨æ»¡è¶³ä»»åŠ¡éœ€æ±‚çš„å‰æä¸‹ï¼Œæœ‰æ•ˆæ§åˆ¶APIè°ƒç”¨æˆæœ¬ ã€‚æ­¤å¤–ï¼Œ**é”™è¯¯å¤„ç†ä¸è‡ªåŠ¨é™çº§æœºåˆ¶**ä¹Ÿæ˜¯èµ„æºç®¡ç†çš„é‡è¦ä¸€ç¯ã€‚å½“æŸä¸ªæ¨¡å‹APIå‘ç”Ÿæ•…éšœæˆ–ä¸å¯ç”¨æ—¶ï¼ŒCCRèƒ½å¤Ÿå¿«é€Ÿåˆ‡æ¢åˆ°å¤‡ç”¨æˆ–é»˜è®¤æ¨¡å‹ï¼Œé¿å…äº†å› å•ä¸ªä¾èµ–æœåŠ¡é—®é¢˜å¯¼è‡´æ•´ä¸ªç³»ç»Ÿç˜«ç—ªï¼Œä»è€Œä¿éšœäº†æœåŠ¡çš„å¯ç”¨æ€§å’Œèµ„æºçš„æœ‰æ•ˆåˆ©ç”¨ ã€‚CCRçš„**æ’ä»¶æœºåˆ¶**ä¹Ÿå…è®¸å¼€å‘è€…é›†æˆè‡ªå®šä¹‰çš„ç›‘æ§å’Œé™æµæ’ä»¶ï¼Œè¿›ä¸€æ­¥ç»†ç²’åº¦åœ°æ§åˆ¶èµ„æºä½¿ç”¨ï¼Œé˜²æ­¢ç³»ç»Ÿè¿‡è½½ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥å¼€å‘æ’ä»¶æ¥ç›‘æ§å„ä¸ªæ¨¡å‹APIçš„å“åº”æ—¶é—´å’Œé”™è¯¯ç‡ï¼Œå¹¶æ ¹æ®å®æ—¶è´Ÿè½½æƒ…å†µåŠ¨æ€è°ƒæ•´è·¯ç”±ç­–ç•¥æˆ–å®æ–½è¯·æ±‚é™æµã€‚

## 7. ç»“è®ºä¸å±•æœ›

Claude-Code-Router (CCR) ä½œä¸ºä¸€æ¬¾åˆ›æ–°çš„AIæ¨¡å‹æ™ºèƒ½è·¯ç”±å·¥å…·ï¼Œé€šè¿‡å…¶ç²¾å¿ƒçš„æ¶æ„è®¾è®¡å’Œæ ¸å¿ƒç®—æ³•ï¼Œä¸ºå¤šæ¨¡å‹ååŒå·¥ä½œæä¾›äº†å¼ºå¤§çš„æŠ€æœ¯æ”¯æ’‘ã€‚å®ƒä¸ä»…ç®€åŒ–äº†ä¸å¼‚æ„AIæ¨¡å‹APIçš„äº¤äº’å¤æ‚æ€§ï¼Œè¿˜é€šè¿‡æ™ºèƒ½è°ƒåº¦ä¼˜åŒ–äº†æœåŠ¡æ€§èƒ½å’Œæˆæœ¬æ•ˆç›Šã€‚ç„¶è€Œï¼Œéšç€AIæŠ€æœ¯çš„ä¸æ–­å‘å±•ï¼ŒCCRä¹Ÿé¢ä¸´ç€æ–°çš„æœºé‡ä¸æŒ‘æˆ˜ã€‚

### 7.1. CCR çš„æŠ€æœ¯ä¼˜åŠ¿ä¸ä»·å€¼

Claude-Code-Router (CCR) çš„æŠ€æœ¯ä¼˜åŠ¿ä¸æ ¸å¿ƒä»·å€¼ä¸»è¦ä½“ç°åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š

1. **æ™ºèƒ½åŒ–çš„å¤šæ¨¡å‹è°ƒåº¦**ï¼šCCR çš„æ ¸å¿ƒä»·å€¼åœ¨äºå…¶**æ™ºèƒ½è·¯ç”±å†³ç­–æœºåˆ¶**ã€‚å®ƒèƒ½å¤Ÿæ ¹æ®è¯·æ±‚çš„Tokenæ•°é‡ã€å†…å®¹ç‰¹å¾ã€ç”¨æˆ·æŒ‡ä»¤ç­‰å¤šç»´åº¦ä¿¡æ¯ï¼ŒåŠ¨æ€é€‰æ‹©æœ€åˆé€‚çš„AIæ¨¡å‹è¿›è¡Œå¤„ç† ã€‚è¿™ç§ç²¾ç»†åŒ–çš„è°ƒåº¦èƒ½åŠ›ï¼Œä½¿å¾—å¼€å‘è€…å¯ä»¥å……åˆ†å‘æŒ¥ä¸åŒæ¨¡å‹çš„ä¼˜åŠ¿ï¼Œä¾‹å¦‚å°†é•¿ä¸Šä¸‹æ–‡ä»»åŠ¡äº¤ç»™Geminiï¼Œå°†æ¨ç†ä»»åŠ¡äº¤ç»™DeepSeek Reasonerï¼Œå°†åå°ä»»åŠ¡äº¤ç»™æœ¬åœ°Ollamaæ¨¡å‹ï¼Œä»è€Œåœ¨æ•´ä½“ä¸Šæå‡ä»»åŠ¡å¤„ç†æ•ˆç‡å’Œè´¨é‡ã€‚

2. **APIå¼‚æ„æ€§çš„å±è”½ä¸ç»Ÿä¸€**ï¼šCCR é€šè¿‡å†…ç½®çš„**APIæ ¼å¼è½¬æ¢ä¸é€‚é…**èƒ½åŠ›ï¼Œæœ‰æ•ˆåœ°å±è”½äº†ä¸åŒAIæ¨¡å‹æä¾›å•†APIæ¥å£çš„å·®å¼‚æ€§ ã€‚ç”¨æˆ·æˆ–å®¢æˆ·ç«¯å¯ä»¥ä¸»è¦ä¸ä¸€ç§ç›¸å¯¹ç»Ÿä¸€çš„APIæ ¼å¼ï¼ˆå¦‚Anthropicæ ¼å¼æˆ–OpenAIå…¼å®¹æ ¼å¼ï¼‰è¿›è¡Œäº¤äº’ï¼Œè€ŒCCRåˆ™è´Ÿè´£åº•å±‚çš„è¯·æ±‚å’Œå“åº”è½¬æ¢ï¼Œè¿™æå¤§åœ°ç®€åŒ–äº†å¤šæ¨¡å‹åº”ç”¨çš„å¼€å‘é›†æˆå·¥ä½œã€‚

3. **æˆæœ¬ä¼˜åŒ–ä¸èµ„æºæ•ˆç‡**ï¼šé€šè¿‡å°†ä»»åŠ¡æŒ‰éœ€åˆ†é…ç»™ä¸åŒæˆæœ¬å’Œèƒ½åŠ›çš„æ¨¡å‹ï¼ŒCCR èƒ½å¤Ÿæ˜¾è‘—**ä¼˜åŒ–AIæœåŠ¡çš„è°ƒç”¨æˆæœ¬**ã€‚ä¾‹å¦‚ï¼Œå¯¹äºéå…³é”®æ€§æˆ–è®¡ç®—é‡è¾ƒå°çš„ä»»åŠ¡ï¼Œå¯ä»¥è·¯ç”±åˆ°æˆæœ¬è¾ƒä½çš„æ¨¡å‹ï¼ˆå¦‚Haikuæˆ–æœ¬åœ°æ¨¡å‹ï¼‰ï¼Œè€Œå¯¹äºå¤æ‚ä»»åŠ¡åˆ™è°ƒç”¨é«˜æ€§èƒ½æ¨¡å‹ï¼Œä»è€Œåœ¨ä¿è¯æ•ˆæœçš„å‰æä¸‹å®ç°æˆæœ¬æ•ˆç›Šçš„æœ€å¤§åŒ– ã€‚

4. **é«˜åº¦çš„çµæ´»æ€§ä¸å¯æ‰©å±•æ€§**ï¼šCCR çš„**é…ç½®é©±åŠ¨**å’Œ**æ’ä»¶æœºåˆ¶**æ˜¯å…¶çµæ´»æ€§çš„é‡è¦ä½“ç° ã€‚ç”¨æˆ·å¯ä»¥é€šè¿‡é…ç½®æ–‡ä»¶è½»æ¾å®šä¹‰è·¯ç”±è§„åˆ™å’Œæ¨¡å‹æ˜ å°„ï¼Œè€Œå¼€å‘è€…åˆ™å¯ä»¥é€šè¿‡ç¼–å†™æ’ä»¶æ¥æ‰©å±•CCRçš„åŠŸèƒ½ï¼Œå®ç°è‡ªå®šä¹‰çš„è·¯ç”±é€»è¾‘ã€è¯·æ±‚/å“åº”æ”¹å†™ã€ç›‘æ§ã€é™æµç­‰ï¼Œè¿™ä½¿å¾—CCRèƒ½å¤Ÿé€‚åº”å„ç§å¤æ‚å’Œç‰¹å®šçš„åº”ç”¨åœºæ™¯ã€‚

5. **æœåŠ¡é²æ£’æ€§ä¸å¯ç”¨æ€§**ï¼šCCR å†…ç½®äº†**é”™è¯¯å¤„ç†ä¸è‡ªåŠ¨é™çº§ç­–ç•¥**ï¼Œå½“è·¯ç”±å†³ç­–å‡ºé”™æˆ–ç›®æ ‡æ¨¡å‹APIä¸å¯ç”¨æ—¶ï¼Œèƒ½å¤Ÿè‡ªåŠ¨é™çº§åˆ°é¢„è®¾çš„å…œåº•æ¨¡å‹ï¼Œä¿è¯äº†æœåŠ¡çš„è¿ç»­æ€§å’ŒåŸºæœ¬å¯ç”¨æ€§ ã€‚ç»“åˆæ½œåœ¨çš„ç¤¾åŒºè´¡çŒ®çš„é‡è¯•æœºåˆ¶ï¼Œè¿›ä¸€æ­¥å¢å¼ºäº†ç³»ç»Ÿçš„å®¹é”™èƒ½åŠ›ã€‚

6. **æå‡å¼€å‘è€…ä½“éªŒä¸ç”Ÿäº§åŠ›**ï¼šå¯¹äºä½¿ç”¨Claude Codeç­‰å·¥å…·çš„å¼€å‘è€…è€Œè¨€ï¼ŒCCR æä¾›äº†ä¸€ä¸ªæ— ç¼çš„ã€å¢å¼ºçš„AIåŠ©æ‰‹ä½“éªŒã€‚å¼€å‘è€…æ— éœ€æ‰‹åŠ¨åˆ‡æ¢æ¨¡å‹æˆ–å…³å¿ƒåº•å±‚APIçš„å·®å¼‚ï¼ŒCCRä¼šè‡ªåŠ¨ä¸ºå…¶é€‰æ‹©å¹¶è°ƒç”¨æœ€åˆé€‚çš„æ¨¡å‹ï¼Œä»è€Œè®©å¼€å‘è€…æ›´ä¸“æ³¨äºæ ¸å¿ƒçš„ç¼–ç¨‹å’Œåˆ›ä½œä»»åŠ¡ã€‚

### 7.2. æœªæ¥å‘å±•æ–¹å‘ä¸æŒ‘æˆ˜

å°½ç®¡ Claude-Code-Router (CCR) å·²ç»å±•ç°å‡ºå¼ºå¤§çš„åŠŸèƒ½å’Œæ½œåŠ›ï¼Œä½†åœ¨å¿«é€Ÿå‘å±•çš„AIæ—¶ä»£ï¼Œå…¶æœªæ¥ä»é¢ä¸´ä¸€äº›å‘å±•æ–¹å‘å’ŒæŒ‘æˆ˜ï¼š

1. **æ›´æ™ºèƒ½çš„è°ƒåº¦ç®—æ³•**ï¼šç›®å‰çš„è°ƒåº¦ç®—æ³•ä¸»è¦åŸºäºé¢„è®¾è§„åˆ™å’Œä¼˜å…ˆçº§ ã€‚æœªæ¥å¯ä»¥è€ƒè™‘å¼•å…¥æ›´é«˜çº§çš„è°ƒåº¦ç­–ç•¥ï¼Œä¾‹å¦‚åŸºäº**æœºå™¨å­¦ä¹ **çš„è°ƒåº¦å™¨ï¼Œé€šè¿‡åˆ†æå†å²è¯·æ±‚æ•°æ®ã€æ¨¡å‹æ€§èƒ½æŒ‡æ ‡ï¼ˆå¦‚å®æ—¶å»¶è¿Ÿã€ååé‡ã€é”™è¯¯ç‡ï¼‰ã€Tokenæ¶ˆè€—æˆæœ¬ç­‰å› ç´ ï¼ŒåŠ¨æ€å­¦ä¹ å’Œä¼˜åŒ–è·¯ç”±å†³ç­–ï¼Œå®ç°æ›´ç²¾ç»†åŒ–ã€è‡ªé€‚åº”çš„èµ„æºåˆ†é…ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥å€Ÿé‰´Router-R1ç³»ç»Ÿå°†æ¨¡å‹è°ƒåº¦è§†ä¸ºåºåˆ—å†³ç­–é—®é¢˜çš„æ€è·¯ ã€‚

2. **æ›´å¹¿æ³›çš„æ¨¡å‹ä¸æä¾›å•†æ”¯æŒ**ï¼šè™½ç„¶CCRå·²ç»æ”¯æŒå¤šç§ä¸»æµæ¨¡å‹å’Œæä¾›å•†ï¼Œä½†AIæ¨¡å‹ç”Ÿæ€ä»åœ¨ä¸æ–­æ¶Œç°æ–°çš„å‚ä¸è€…å’ŒæŠ€æœ¯ã€‚CCRéœ€è¦æŒç»­æ‰©å±•å…¶æ”¯æŒçš„æ¨¡å‹èŒƒå›´ï¼Œå¹¶ç®€åŒ–æ–°æ¨¡å‹APIçš„é›†æˆæµç¨‹ï¼Œä¾‹å¦‚é€šè¿‡æä¾›æ›´é€šç”¨çš„é€‚é…å™¨æ¨¡æ¿æˆ–å·¥å…·ã€‚

3. **å¢å¼ºçš„ç›‘æ§ã€è¯Šæ–­ä¸ç®¡ç†èƒ½åŠ›**ï¼šéšç€CCRåœ¨ç”Ÿäº§ç¯å¢ƒä¸­çš„éƒ¨ç½²è§„æ¨¡æ‰©å¤§ï¼Œå¯¹å…¶è‡ªèº«çš„ç›‘æ§ã€è¯Šæ–­å’Œç®¡ç†èƒ½åŠ›æå‡ºäº†æ›´é«˜è¦æ±‚ã€‚æœªæ¥å¯ä»¥å¢å¼ºå†…ç½®çš„æ—¥å¿—è®°å½•ã€æŒ‡æ ‡æ”¶é›†å’Œå¯è§†åŒ–åŠŸèƒ½ï¼Œæä¾›æ›´å…¨é¢çš„ç³»ç»Ÿæ´å¯Ÿï¼Œå¸®åŠ©ç®¡ç†å‘˜åŠæ—¶å‘ç°å’Œè§£å†³é—®é¢˜ã€‚é›†æˆæ›´å¼ºå¤§çš„é…ç½®ç®¡ç†å’Œç‰ˆæœ¬æ§åˆ¶æœºåˆ¶ä¹Ÿå°†æ˜¯é‡è¦æ–¹å‘ã€‚

4. **å®‰å…¨æ€§ä¸åˆè§„æ€§è€ƒé‡**ï¼šä½œä¸ºAIæœåŠ¡çš„ä¸­é—´å±‚ï¼ŒCCRéœ€è¦æ›´åŠ å…³æ³¨æ•°æ®å®‰å…¨ã€éšç§ä¿æŠ¤ä»¥åŠåˆè§„æ€§é—®é¢˜ã€‚æœªæ¥å¯èƒ½éœ€è¦å¢å¼ºå¯¹è¯·æ±‚å’Œå“åº”å†…å®¹çš„å®¡è®¡ã€è¿‡æ»¤å’Œè„±æ•èƒ½åŠ›ï¼Œç¡®ä¿ç¬¦åˆç›¸å…³æ³•å¾‹æ³•è§„å’Œè¡Œä¸šæ ‡å‡†ã€‚

5. **ç¤¾åŒºç”Ÿæ€çš„åŸ¹è‚²ä¸å‘å±•**ï¼šCCRçš„æ’ä»¶æœºåˆ¶ä¸ºç¤¾åŒºè´¡çŒ®æ‰“å¼€äº†å¤§é—¨ ã€‚æœªæ¥éœ€è¦ç§¯æåŸ¹è‚²ç¤¾åŒºç”Ÿæ€ï¼Œé¼“åŠ±å¼€å‘è€…è´¡çŒ®æ›´å¤šé«˜è´¨é‡çš„æ’ä»¶ã€é€‚é…å™¨å’Œé…ç½®æ¨¡æ¿ï¼Œå½¢æˆå›´ç»•CCRçš„æ´»è·ƒç¤¾åŒºï¼Œå…±åŒæ¨åŠ¨å…¶åŠŸèƒ½çš„ä¸°å¯Œå’Œå®Œå–„ã€‚

6. **å¤„ç†æ›´å¤æ‚çš„äº¤äº’æ¨¡å¼**ï¼šé™¤äº†ç®€å•çš„è¯·æ±‚-å“åº”æ¨¡å¼ï¼Œæœªæ¥çš„AIåº”ç”¨å¯èƒ½æ¶‰åŠæ›´å¤æ‚çš„äº¤äº’ï¼Œå¦‚å¤šè½®å¯¹è¯ç®¡ç†ã€æµå¼å¤„ç†ä¼˜åŒ–ã€ä»¥åŠä¸å…¶ä»–å·¥å…·å’ŒæœåŠ¡çš„æ·±åº¦é›†æˆã€‚CCRéœ€è¦ä¸æ–­æ¼”è¿›ä»¥æ”¯æŒè¿™äº›æ›´é«˜çº§çš„äº¤äº’æ¨¡å¼ã€‚

7. **æ€§èƒ½ä¸å¯ä¼¸ç¼©æ€§çš„æŒç»­ä¼˜åŒ–**ï¼šéšç€è¯·æ±‚é‡çš„å¢é•¿å’Œæ¨¡å‹å¤æ‚åº¦çš„æå‡ï¼ŒCCRè‡ªèº«ä¹Ÿéœ€è¦åœ¨æ€§èƒ½å’Œå¯ä¼¸ç¼©æ€§æ–¹é¢è¿›è¡ŒæŒç»­ä¼˜åŒ–ï¼Œä¾‹å¦‚é€šè¿‡æ›´é«˜æ•ˆçš„æ•°æ®å¤„ç†ç®¡é“ã€æ›´ä¼˜çš„å¹¶å‘æ§åˆ¶ç­–ç•¥ä»¥åŠæ”¯æŒåˆ†å¸ƒå¼éƒ¨ç½²ç­‰ã€‚

é¢å¯¹è¿™äº›æŒ‘æˆ˜å’Œæœºé‡ï¼ŒCCRä½œä¸ºä¸€ä¸ªå¼€æºé¡¹ç›®ï¼Œå…¶æœªæ¥çš„å‘å±•å°†ä¾èµ–äºæ ¸å¿ƒå›¢é˜Ÿçš„æŒç»­æŠ•å…¥å’Œå¹¿å¤§ç¤¾åŒºç”¨æˆ·çš„ç§¯æå‚ä¸ã€‚é€šè¿‡ä¸æ–­çš„æŠ€æœ¯åˆ›æ–°å’Œç”Ÿæ€å»ºè®¾ï¼ŒCCRæœ‰æœ›æˆä¸ºAIæ—¶ä»£ä¸å¯æˆ–ç¼ºçš„æ™ºèƒ½è·¯ç”±åŸºç¡€è®¾æ–½ã€‚

## 8. Demo

### å®‰è£…Claude-Code-Router

### é…ç½®LLM Provider

```json
cat ~/.claude-code-router/config.json 
{
  "LOG": true,
  "PROXY_URL": "http://127.0.0.1:33210",
  "Providers": [
    {
      "name": "deepseek",
      "api_base_url": "https://api.deepseek.com",
      "api_key": "sk-xxx",
      "models": ["deepseek-r1", "deepseek-chat"]
    },
    {
      "name": "modelscope",
      "api_base_url": "https://api-inference.modelscope.cn/v1/",
      "api_key": "ms-xxx",
      "models": ["Qwen/Qwen3-Coder-480B-A35B-Instruct"]
    },
    {
      "name": "volcengine",
      "api_base_url": "https://ark.cn-beijing.volces.com/api/v3",
      "api_key": "xxx",
      "models": ["kimi-k2-250711","doubao-seed-1-6-thinking-250715","deepseek-r1-250528","deepseek-v3-250324"]
    },
    {
      "name": "openrouter",
      "api_base_url": "https://openrouter.ai/api/v1",
      "api_key": "sk-or-v1-xxx",
      "models": ["moonshotai/kimi-k2","google/gemini-2.5-pro"],
      "transformer": {
        "use": ["openrouter"]
      }
    },
    {
      "name": "gemini",
      "api_base_url": "https://generativelanguage.googleapis.com/v1beta/models/",
      "api_key": "xxx",
      "models": ["gemini-2.5-flash", "gemini-2.5-pro"],
      "transformer": {
        "use": ["gemini"]
      }
    }
  ],
  "Router": {
    "default": "volcengine,deepseek-v3-250324",
    "think": "volcengine,deepseek-r1-250528",
    "background": "modelscope,Qwen/Qwen3-Coder-480B-A35B-Instruct",
    "longContext": "openrouter,google/gemini-2.5-pro",
    "webSearch": "gemini,gemini-2.5-flash",
    "image": "gemini,gemini-2.5-flash-image"
  }
}



```

### å®é™…åº”ç”¨åœºæ™¯

åœºæ™¯1: ç¼–å†™ä»£ç ï¼ˆæ™®é€šè¯·æ±‚ï¼‰
  â†’ æ£€æŸ¥ token â†’ æœªè¶… longContextThreshold
  â†’ ä¸æ˜¯ Haiku â†’ æ—  web_search å·¥å…· â†’ æ—  thinking
  â†’ æ— å›¾åƒ â†’ âœ“ ä½¿ç”¨ default æ¨¡å‹

åœºæ™¯2: ä½¿ç”¨ Claude Thinking Mode
  â†’ æ˜¾å¼è®¾ç½® thinking: true
  â†’ âœ“ è·¯ç”±åˆ° think æ¨¡å‹ï¼ˆdeepseek-reasonerï¼‰

åœºæ™¯3: å¤„ç†å¤§å‹é¡¹ç›®æ–‡ä»¶ï¼ˆè¶…è¿‡60000 tokenï¼‰
  â†’ Token è®¡æ•° > 60000
  â†’ âœ“ è·¯ç”±åˆ° longContext æ¨¡å‹ï¼ˆgemini-2.5-proï¼‰

åœºæ™¯4: ç½‘é¡µæœç´¢ä»»åŠ¡
  â†’ è¯·æ±‚åŒ…å« web_search å·¥å…·
  â†’ âœ“ è·¯ç”±åˆ° webSearch æ¨¡å‹ï¼ˆä¼˜å…ˆäº thinkingï¼‰

åœºæ™¯5: å¤„ç†æœ¬åœ°å°ä»»åŠ¡
  â†’ è¯·æ±‚ claude-3.5-haiku
  â†’ âœ“ è·¯ç”±åˆ° background æ¨¡å‹ï¼ˆèŠ‚çœæˆæœ¬ï¼‰

### å¯åŠ¨Claude-Code-Router

```bash
ccr start
```

å½“~/.claude-code-router/config.jsonå˜åŒ–æ—¶ï¼Œéœ€è¦é‡å¯,å¦‚æœconfig.jsonæ ¼å¼ä¸å¯¹ï¼Œrestartä¼šå¤±è´¥ï¼Œä½†æ˜¯ä¸ä¼šåœ¨ç•Œé¢ä¸Šæ˜¾ç¤ºã€‚
```bash
ccr restart
```

### å¯åŠ¨Claude-Code

```bash
ccr code
```


## é«˜çº§ç‰¹æ€§ï¼šå¦‚ä½•åŠ å…¥è‡ªå·±çš„è·¯ç”±

### Custom Router å·¥ä½œåŸç†  

æºç ä¸­çš„æ ¸å¿ƒé€»è¾‘ï¼ˆrouter.ts ç¬¬ 204-211 è¡Œï¼‰ï¼š
```ts
let model;
if (config.CUSTOM_ROUTER_PATH) {
  try {
    const customRouter = require(config.CUSTOM_ROUTER_PATH);
    req.tokenCount = tokenCount; // ä¼ é€’ token è®¡æ•°
    model = await customRouter(req, config, {
      event,
    });
  } catch (e: any) {
    req.log.error(`failed to load custom router: ${e.message}`);
  }
}
if (!model) {
  // å¦‚æœ custom router è¿”å› nullï¼Œä½¿ç”¨é»˜è®¤è·¯ç”±
  model = await getUseModel(req, tokenCount, config, lastMessageUsage);
}
```

å…³é”®ç‚¹ï¼š

âœ… Custom router å¯ä»¥å®Œå…¨æ¥ç®¡è·¯ç”±é€»è¾‘
âœ… è¿”å› null å¯ä»¥é™çº§åˆ°å†…ç½®è·¯ç”±
âœ… å¯ä»¥è®¿é—® token è®¡æ•° (req.tokenCount)
âœ… æœ‰ é”™è¯¯å¤„ç†æœºåˆ¶ï¼Œå¼‚å¸¸ä¼šè¢«æ•è·å¹¶è®°å½•

ğŸ› ï¸ å¦‚ä½•ç¼–å†™ Custom Router
åŸºç¡€æ¨¡æ¿
```js
// ~/.claude-code-router/custom-router.js

/**
 * Custom Router å‡½æ•°
 * @param {Object} req - è¯·æ±‚å¯¹è±¡ï¼ŒåŒ…å«ï¼š
 *   - req.body.messages: æ¶ˆæ¯åˆ—è¡¨
 *   - req.body.model: æ˜¾å¼æŒ‡å®šçš„ modelï¼ˆå¯èƒ½ï¼‰
 *   - req.body.thinking: æ˜¯å¦å¯ç”¨ thinking æ¨¡å¼
 *   - req.body.tools: å·¥å…·åˆ—è¡¨
 *   - req.body.system: ç³»ç»Ÿæç¤º
 *   - req.tokenCount: è®¡ç®—å‡ºçš„ token æ•°
 *   - req.sessionId: ä¼šè¯ ID
 *
 * @param {Object} config - é…ç½®å¯¹è±¡ï¼ŒåŒ…å«ï¼š
 *   - config.Router: è·¯ç”±é…ç½®
 *   - config.Providers: æä¾›å•†åˆ—è¡¨
 *   - config çš„æ‰€æœ‰å…¶ä»–é…ç½®
 *
 * @returns {Promise<string|null>} 
 *   - è¿”å› "provider,model" æ ¼å¼çš„å­—ç¬¦ä¸²æ¥ä½¿ç”¨æŒ‡å®šæ¨¡å‹
 *   - è¿”å› null æ¥é™çº§åˆ°å†…ç½®è·¯ç”±
 */
module.exports = async function router(req, config) {
  // æ‚¨çš„è‡ªå®šä¹‰é€»è¾‘
  return null; // ä½¿ç”¨å†…ç½®è·¯ç”±
};
```

å®ç”¨ç¤ºä¾‹

```js
// ~/.claude-code-router/custom-router.js

module.exports = async function router(req, config) {
  const userMessage = req.body.messages
    .find(m => m.role === 'user')
    ?.content;

  // ç¤ºä¾‹ 1: æ ¹æ®å…³é”®å­—è·¯ç”±
  if (typeof userMessage === 'string') {
    if (userMessage.includes('åˆ†æä»£ç ')) {
      // ä»£ç åˆ†æç”¨å¼ºå¤§æ¨¡å‹
      return 'deepseek,deepseek-reasoner';
    }
    
    if (userMessage.includes('å†™ä¸ªè„šæœ¬')) {
      // è„šæœ¬ç”Ÿæˆç”¨ Claude
      return 'openrouter,anthropic/claude-3.5-sonnet';
    }

    if (userMessage.includes('æœ¬åœ°')) {
      // æœ¬åœ°ä»»åŠ¡ç”¨æœ¬åœ°æ¨¡å‹
      return 'ollama,qwen2.5-coder:latest';
    }
  }

  // ç¤ºä¾‹ 2: æ ¹æ® token æ•°é‡è·¯ç”±
  if (req.tokenCount > 100000) {
    // è¶…å¤§ token ç”¨ Gemini
    return 'openrouter,google/gemini-2.5-pro-preview';
  }

  // ç¤ºä¾‹ 3: æ ¹æ®æ—¶é—´è·¯ç”±ï¼ˆå·¥ä½œæ—¶é—´ç”¨æœ¬åœ°ï¼Œéå·¥ä½œæ—¶é—´ç”¨äº‘ç«¯ï¼‰
  const hour = new Date().getHours();
  if (hour >= 9 && hour <= 17) {
    // å·¥ä½œæ—¶é—´ç”¨æœ¬åœ°æ¨¡å‹èŠ‚çœæˆæœ¬
    return 'ollama,qwen2.5-coder:latest';
  } else {
    // éå·¥ä½œæ—¶é—´ç”¨äº‘ç«¯å¼ºåŠ›æ¨¡å‹
    return 'deepseek,deepseek-chat';
  }

  // ç¤ºä¾‹ 4: æ ¹æ®å·¥å…·æ£€æµ‹è·¯ç”±
  if (req.body.tools?.some(t => t.name === 'image_analysis')) {
    // å›¾åƒåˆ†æç”¨æ”¯æŒè§†è§‰çš„æ¨¡å‹
    return 'openrouter,google/gemini-2.5-pro-preview';
  }

  // ç¤ºä¾‹ 5: æ ¹æ® thinking æ¨¡å¼è·¯ç”±
  if (req.body.thinking) {
    // æ€è€ƒæ¨¡å¼ç”¨æ¨ç†æ¨¡å‹
    return 'deepseek,deepseek-reasoner';
  }

  // éƒ½ä¸åŒ¹é…å°±é™çº§åˆ°å†…ç½®è·¯ç”±
  return null;
};
```

é«˜çº§ç¤ºä¾‹ - é…åˆé¡¹ç›®ç‰¹å®šé…ç½®

```js
// ~/.claude-code-router/custom-router.js

const fs = require('fs').promises;
const path = require('path');

module.exports = async function router(req, config) {
  // å°è¯•è¯»å–é¡¹ç›®ç‰¹å®šçš„è·¯ç”±è§„åˆ™
  if (req.sessionId) {
    try {
      const projectConfigPath = path.join(
        process.env.HOME || process.env.USERPROFILE,
        '.claude',
        'projects',
        req.sessionId.split('/')[0],
        'routing-rules.json'
      );
      
      const rulesContent = await fs.readFile(projectConfigPath, 'utf-8');
      const rules = JSON.parse(rulesContent);
      
      // åº”ç”¨é¡¹ç›®ç‰¹å®šçš„è§„åˆ™
      for (const rule of rules) {
        if (matchesCondition(req.body.messages, rule.condition)) {
          return rule.model;
        }
      }
    } catch (e) {
      // æ–‡ä»¶ä¸å­˜åœ¨æˆ–è§£æå¤±è´¥ï¼Œç»§ç»­
    }
  }

  // åŸºç¡€è·¯ç”±é€»è¾‘
  const userMessage = req.body.messages
    .find(m => m.role === 'user')
    ?.content;

  if (typeof userMessage === 'string') {
    // Token æ¶ˆè€—è®¡ç®—
    if (req.tokenCount > 80000) {
      return 'openrouter,google/gemini-2.5-pro-preview';
    }

    // åŸºäºå†…å®¹çš„è·¯ç”±
    if (userMessage.match(/debug|fix|error|bug/i)) {
      return 'deepseek,deepseek-reasoner';
    }
  }

  return null; // é™çº§åˆ°å†…ç½®è·¯ç”±
};

function matchesCondition(messages, condition) {
  const userMessage = messages
    .find(m => m.role === 'user')
    ?.content;
  
  if (typeof userMessage === 'string') {
    return userMessage.includes(condition);
  }
  return false;
}
```

âš™ï¸ å¦‚ä½•é…ç½® Custom Router  

æ–¹å¼ 1: åœ¨ ~/.claude-code-router/config.json ä¸­é…ç½®

å…³é”®åœ¨**CUSTOM_ROUTER_PATH**ï¼Œå…¶ä»–ä¸å˜ã€‚
```json
{
  "CUSTOM_ROUTER_PATH": "/Users/username/.claude-code-router/custom-router.js",
  "Providers": [
    {
      "name": "deepseek",
      "api_base_url": "https://api.deepseek.com/chat/completions",
      "api_key": "$DEEPSEEK_API_KEY",
      "models": ["deepseek-chat", "deepseek-reasoner"]
    },
    {
      "name": "openrouter",
      "api_base_url": "https://openrouter.ai/api/v1/chat/completions",
      "api_key": "$OPENROUTER_API_KEY",
      "models": ["anthropic/claude-3.5-sonnet", "google/gemini-2.5-pro-preview"]
    }
  ],
  "Router": {
    "default": "deepseek,deepseek-chat"
  }
}
```

æ–¹å¼ 2: ä½¿ç”¨ UI é…ç½®

# å¯åŠ¨ UI
ccr ui

# åœ¨ Web ç•Œé¢ä¸­æ‰¾åˆ° "Advanced Settings" æˆ–é…ç½®å­—æ®µ
# å¡«å…¥ CUSTOM_ROUTER_PATH çš„å®Œæ•´è·¯å¾„

æ–¹å¼ 3: ç¯å¢ƒå˜é‡

```bash
export CUSTOM_ROUTER_PATH="/Users/username/.claude-code-router/custom-router.js"
ccr restart
```

ğŸš€ æœ€ä½³å®è·µ
å§‹ç»ˆè€ƒè™‘é™çº§ - åœ¨ä¸ç¡®å®šæ—¶è¿”å› null è®©ç³»ç»Ÿä½¿ç”¨å†…ç½®è·¯ç”±
è®°å½•æ—¥å¿— - ä½¿ç”¨ req.log.info() æˆ– console.log() æ¥è°ƒè¯•
é”™è¯¯å¤„ç† - ä½¿ç”¨ try-catch æ•è·å¼‚å¸¸
æ€§èƒ½è€ƒè™‘ - é¿å…å¤æ‚çš„å¼‚æ­¥æ“ä½œï¼Œå› ä¸ºæ¯æ¬¡è¯·æ±‚éƒ½ä¼šæ‰§è¡Œ
è·¯å¾„ä¸€è‡´æ€§ - ä½¿ç”¨ç»å¯¹è·¯å¾„ï¼Œæ”¯æŒç¯å¢ƒå˜é‡æ‰©å±•

```ts
module.exports = async function router(req, config) {
  try {
    console.log('Custom router: å¤„ç†è¯·æ±‚', {
      model: req.body.model,
      tokenCount: req.tokenCount,
      hasThinking: req.body.thinking
    });

    // æ‚¨çš„é€»è¾‘...

    return null; // æˆ–è¿”å› "provider,model"
  } catch (error) {
    console.error('Custom router å‡ºé”™:', error);
    return null; // å¼‚å¸¸æ—¶é™çº§
  }
};
```

module.exports = async function router(req, config) {
  try {
    console.log('Custom router: å¤„ç†è¯·æ±‚', {
      model: req.body.model,
      tokenCount: req.tokenCount,
      hasThinking: req.body.thinking
    });

    // ä½ çš„é€»è¾‘...

    return null; // æˆ–è¿”å› "provider,model"
  } catch (error) {
    console.error('Custom router å‡ºé”™:', error);
    return null; // å¼‚å¸¸æ—¶é™çº§
  }
};