{{/*
思维导图Shortcode

支持多种思维导图格式：
1. Markmap (基于Markdown)
2. 图片形式
3. 第三方服务嵌入

使用方法:
{{< mindmap >}}
# 中心主题
## 分支1
### 子分支1.1
### 子分支1.2
## 分支2
{{< /mindmap >}}

{{< mindmap src="/images/mindmap.png" alt="思维导图" >}}

{{< mindmap url="https://www.processon.com/embed/123456" >}}
*/}}

{{ if .Get "src" }}
  {{/* 图片形式的思维导图 */}}
  <div class="mindmap-image-wrapper" style="text-align: center; margin: 2rem 0;">
    <img
      src="{{ .Get `src` }}"
      alt="{{ .Get `alt` | default `思维导图` }}"
      style="max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);"
      loading="lazy"
    />
    {{ if .Get "caption" }}
      <p class="mindmap-caption" style="margin-top: 0.5rem; font-size: 0.9rem; color: #666;">
        {{ .Get "caption" }}
      </p>
    {{ end }}
  </div>

{{ else if .Get "url" }}
  {{/* 第三方服务嵌入 */}}
  <div class="mindmap-embed-wrapper" style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; max-width: 100%; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); margin: 2rem 0;">
    <iframe
      src="{{ .Get `url` }}"
      style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; border-radius: 8px;"
      allowfullscreen="true"
      sandbox="allow-top-navigation allow-same-origin allow-forms allow-scripts allow-popups">
    </iframe>
  </div>

{{ else }}
  {{/* Markmap格式的思维导图 */}}
  <div class="mindmap-container" style="margin: 2rem 0; padding: 1.5rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.1);">
    <div class="mindmap-header" style="text-align: center; margin-bottom: 1rem;">
      <h3 style="color: white; margin: 0; font-size: 1.2rem; font-weight: 600;">🧠 思维导图</h3>
    </div>
    <div class="mindmap-content" id="mindmap-{{ .Ordinal }}" style="background: rgba(255,255,255,0.95); border-radius: 8px; padding: 1rem; min-height: 300px; position: relative;">
      <div class="mindmap-loading" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #666; font-size: 1.1rem;">
        🌀 正在渲染思维导图...
      </div>
    </div>
  </div>

  {{/* 存储原始Markdown内容 */}}
  <script>
    window.mindmapData = window.mindmapData || {};
    window.mindmapData[{{ .Ordinal }}] = {{ .Inner | jsonify }};
  </script>

{{ end }}

<style>
/* 思维导图样式 */
.mindmap-container {
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.mindmap-container:hover {
  transform: translateY(-2px);
  box-shadow: 0 12px 40px rgba(0,0,0,0.15);
}

/* Markmap SVG样式 */
.mindmap-content svg {
  width: 100%;
  height: auto;
  max-height: 600px;
}

/* 节点样式 */
.mindmap-content circle {
  fill: #667eea;
  stroke: white;
  stroke-width: 2px;
  transition: all 0.3s ease;
}

.mindmap-content circle:hover {
  fill: #764ba2;
  r: 8;
}

/* 文本样式 */
.mindmap-content text {
  fill: white;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  font-size: 12px;
  font-weight: 500;
  text-anchor: middle;
  dominant-baseline: central;
}

/* 路径样式 */
.mindmap-content path {
  stroke: rgba(255,255,255,0.6);
  stroke-width: 2px;
  fill: none;
}

/* 暗色模式 */
@media (prefers-color-scheme: dark) {
  .mindmap-container {
    background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
  }

  .mindmap-content {
    background: rgba(45,55,72,0.9);
  }

  .mindmap-loading {
    color: #a0aec0;
  }
}

/* 响应式设计 */
@media (max-width: 768px) {
  .mindmap-container {
    margin: 1rem 0;
    padding: 1rem;
  }

  .mindmap-content {
    min-height: 250px;
    padding: 0.75rem;
  }

  .mindmap-content text {
    font-size: 10px;
  }
}

/* 打印样式 */
@media print {
  .mindmap-container {
    break-inside: avoid;
    box-shadow: none;
    border: 1px solid #ccc;
  }

  .mindmap-content {
    background: white !important;
    -webkit-print-color-adjust: exact;
  }
}
</style>

{{/* 只有在有内容时才加载Markmap库 */}}
{{ if and (not (.Get "src")) (not (.Get "url")) }}
<script src="https://cdn.jsdelivr.net/npm/markmap-lib@0.14.3/dist/browser/index.js"></script>
<script src="https://cdn.jsdelivr.net/npm/markmap-view@0.14.3/dist/index.js"></script>
<script>
// 渲染思维导图
document.addEventListener('DOMContentLoaded', function() {
  // 确保markmap已加载
  if (typeof window.markmap !== 'undefined') {
    renderAllMindmaps();
  } else {
    // 如果markmap未加载，等待一段时间后重试
    setTimeout(function() {
      if (typeof window.markmap !== 'undefined') {
        renderAllMindmaps();
      } else {
        console.warn('Markmap库加载失败，请检查网络连接');
        hideLoadingIndicators();
      }
    }, 3000);
  }
});

function renderAllMindmaps() {
  const mindmapContainers = document.querySelectorAll('.mindmap-content');

  mindmapContainers.forEach(function(container, index) {
    const mindmapId = index + 1;
    const markdownContent = window.mindmapData && window.mindmapData[mindmapId];

    if (markdownContent) {
      try {
        // 解析Markdown为思维导图
        const { root, features } = window.markmap.transform(markdownContent);

        // 创建SVG容器
        container.innerHTML = '<svg id="mindmap-svg-' + mindmapId + '" style="width: 100%; height: 400px;"></svg>';

        // 渲染思维导图
        const svgElement = document.getElementById('mindmap-svg-' + mindmapId);
        window.markmap.Markmap.create(svgElement, null, root);

        // 隐藏加载指示器
        const loading = container.querySelector('.mindmap-loading');
        if (loading) {
          loading.style.display = 'none';
        }

      } catch (error) {
        console.error('渲染思维导图失败:', error);
        container.innerHTML = '<div style="color: #e53e3e; text-align: center; padding: 2rem;">❌ 思维导图渲染失败<br><small>' + error.message + '</small></div>';
      }
    }
  });
}

function hideLoadingIndicators() {
  const loadings = document.querySelectorAll('.mindmap-loading');
  loadings.forEach(function(loading) {
    loading.style.display = 'none';
  });
}
</script>
{{ end }}
