{{/*
æ€ç»´å¯¼å›¾Shortcode

æ”¯æŒå¤šç§æ€ç»´å¯¼å›¾æ ¼å¼ï¼š
1. Markmap (åŸºäºMarkdown)
2. å›¾ç‰‡å½¢å¼
3. ç¬¬ä¸‰æ–¹æœåŠ¡åµŒå…¥

ä½¿ç”¨æ–¹æ³•:
{{< mindmap >}}
# ä¸­å¿ƒä¸»é¢˜
## åˆ†æ”¯1
### å­åˆ†æ”¯1.1
### å­åˆ†æ”¯1.2
## åˆ†æ”¯2
{{< /mindmap >}}

{{< mindmap src="/images/mindmap.png" alt="æ€ç»´å¯¼å›¾" >}}

{{< mindmap url="https://www.processon.com/embed/123456" >}}
*/}}

{{ if .Get "src" }}
  {{/* å›¾ç‰‡å½¢å¼çš„æ€ç»´å¯¼å›¾ */}}
  <div class="mindmap-image-wrapper" style="text-align: center; margin: 2rem 0;">
    <img
      src="{{ .Get `src` }}"
      alt="{{ .Get `alt` | default `æ€ç»´å¯¼å›¾` }}"
      style="max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);"
      loading="lazy"
    />
    {{ if .Get "caption" }}
      <p class="mindmap-caption" style="margin-top: 0.5rem; font-size: 0.9rem; color: #666;">
        {{ .Get "caption" }}
      </p>
    {{ end }}
  </div>

{{ else if .Get "url" }}
  {{/* ç¬¬ä¸‰æ–¹æœåŠ¡åµŒå…¥ */}}
  <div class="mindmap-embed-wrapper" style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; max-width: 100%; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); margin: 2rem 0;">
    <iframe
      src="{{ .Get `url` }}"
      style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; border-radius: 8px;"
      allowfullscreen="true"
      sandbox="allow-top-navigation allow-same-origin allow-forms allow-scripts allow-popups">
    </iframe>
  </div>

{{ else }}
  {{/* Markmapæ ¼å¼çš„æ€ç»´å¯¼å›¾ */}}
  <div class="mindmap-container" style="margin: 2rem 0; padding: 1.5rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.1);">
    <div class="mindmap-header" style="text-align: center; margin-bottom: 1rem;">
      <h3 style="color: white; margin: 0; font-size: 1.2rem; font-weight: 600;">ğŸ§  æ€ç»´å¯¼å›¾</h3>
    </div>
    <div class="mindmap-content" id="mindmap-{{ .Ordinal }}" style="background: rgba(255,255,255,0.95); border-radius: 8px; padding: 1rem; min-height: 300px; position: relative;">
      <div class="mindmap-loading" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #666; font-size: 1.1rem;">
        ğŸŒ€ æ­£åœ¨æ¸²æŸ“æ€ç»´å¯¼å›¾...
      </div>
    </div>
  </div>

  {{/* å­˜å‚¨åŸå§‹Markdownå†…å®¹ */}}
  <script>
    window.mindmapData = window.mindmapData || {};
    window.mindmapData[{{ .Ordinal }}] = {{ .Inner | jsonify }};
  </script>

{{ end }}

<style>
/* æ€ç»´å¯¼å›¾æ ·å¼ */
.mindmap-container {
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.mindmap-container:hover {
  transform: translateY(-2px);
  box-shadow: 0 12px 40px rgba(0,0,0,0.15);
}

/* Markmap SVGæ ·å¼ */
.mindmap-content svg {
  width: 100%;
  height: auto;
  max-height: 600px;
}

/* èŠ‚ç‚¹æ ·å¼ */
.mindmap-content circle {
  fill: #667eea;
  stroke: white;
  stroke-width: 2px;
  transition: all 0.3s ease;
}

.mindmap-content circle:hover {
  fill: #764ba2;
  r: 8;
}

/* æ–‡æœ¬æ ·å¼ */
.mindmap-content text {
  fill: white;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  font-size: 12px;
  font-weight: 500;
  text-anchor: middle;
  dominant-baseline: central;
}

/* è·¯å¾„æ ·å¼ */
.mindmap-content path {
  stroke: rgba(255,255,255,0.6);
  stroke-width: 2px;
  fill: none;
}

/* æš—è‰²æ¨¡å¼ */
@media (prefers-color-scheme: dark) {
  .mindmap-container {
    background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
  }

  .mindmap-content {
    background: rgba(45,55,72,0.9);
  }

  .mindmap-loading {
    color: #a0aec0;
  }
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
  .mindmap-container {
    margin: 1rem 0;
    padding: 1rem;
  }

  .mindmap-content {
    min-height: 250px;
    padding: 0.75rem;
  }

  .mindmap-content text {
    font-size: 10px;
  }
}

/* æ‰“å°æ ·å¼ */
@media print {
  .mindmap-container {
    break-inside: avoid;
    box-shadow: none;
    border: 1px solid #ccc;
  }

  .mindmap-content {
    background: white !important;
    -webkit-print-color-adjust: exact;
  }
}
</style>

{{/* åªæœ‰åœ¨æœ‰å†…å®¹æ—¶æ‰åŠ è½½Markmapåº“ */}}
{{ if and (not (.Get "src")) (not (.Get "url")) }}
<script src="https://cdn.jsdelivr.net/npm/markmap-lib@0.14.3/dist/browser/index.js"></script>
<script src="https://cdn.jsdelivr.net/npm/markmap-view@0.14.3/dist/index.js"></script>
<script>
// æ¸²æŸ“æ€ç»´å¯¼å›¾
document.addEventListener('DOMContentLoaded', function() {
  // ç¡®ä¿markmapå·²åŠ è½½
  if (typeof window.markmap !== 'undefined') {
    renderAllMindmaps();
  } else {
    // å¦‚æœmarkmapæœªåŠ è½½ï¼Œç­‰å¾…ä¸€æ®µæ—¶é—´åé‡è¯•
    setTimeout(function() {
      if (typeof window.markmap !== 'undefined') {
        renderAllMindmaps();
      } else {
        console.warn('Markmapåº“åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
        hideLoadingIndicators();
      }
    }, 3000);
  }
});

function renderAllMindmaps() {
  const mindmapContainers = document.querySelectorAll('.mindmap-content');

  mindmapContainers.forEach(function(container, index) {
    const mindmapId = index + 1;
    const markdownContent = window.mindmapData && window.mindmapData[mindmapId];

    if (markdownContent) {
      try {
        // è§£æMarkdownä¸ºæ€ç»´å¯¼å›¾
        const { root, features } = window.markmap.transform(markdownContent);

        // åˆ›å»ºSVGå®¹å™¨
        container.innerHTML = '<svg id="mindmap-svg-' + mindmapId + '" style="width: 100%; height: 400px;"></svg>';

        // æ¸²æŸ“æ€ç»´å¯¼å›¾
        const svgElement = document.getElementById('mindmap-svg-' + mindmapId);
        window.markmap.Markmap.create(svgElement, null, root);

        // éšè—åŠ è½½æŒ‡ç¤ºå™¨
        const loading = container.querySelector('.mindmap-loading');
        if (loading) {
          loading.style.display = 'none';
        }

      } catch (error) {
        console.error('æ¸²æŸ“æ€ç»´å¯¼å›¾å¤±è´¥:', error);
        container.innerHTML = '<div style="color: #e53e3e; text-align: center; padding: 2rem;">âŒ æ€ç»´å¯¼å›¾æ¸²æŸ“å¤±è´¥<br><small>' + error.message + '</small></div>';
      }
    }
  });
}

function hideLoadingIndicators() {
  const loadings = document.querySelectorAll('.mindmap-loading');
  loadings.forEach(function(loading) {
    loading.style.display = 'none';
  });
}
</script>
{{ end }}
