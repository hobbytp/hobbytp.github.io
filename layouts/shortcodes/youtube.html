{{/*
YouTubeè§†é¢‘Shortcode

ä½¿ç”¨æ–¹æ³•:
{{< youtube dQw4w9WgXcQ >}}
{{< youtube id="dQw4w9WgXcQ" >}}
{{< youtube id="dQw4w9WgXcQ" title="è§†é¢‘æ ‡é¢˜" >}}
{{< youtube id="dQw4w9WgXcQ" autoplay="true" >}}
{{< youtube "https://www.youtube.com/watch?v=dQw4w9WgXcQ" >}}
*/}}

{{ $id := .Get 0 }}
{{ if .Get "id" }}
  {{ $id = .Get "id" }}
{{ end }}

{{/* å¤„ç†YouTube URL */}}
{{ if strings.HasPrefix $id "https://" }}
  {{/* ä»URLä¸­æå–è§†é¢‘ID */}}
  {{ $url := urls.Parse $id }}
  {{ if $url.Query.Get "v" }}
    {{ $id = $url.Query.Get "v" }}
  {{ else if strings.Contains $id "/embed/" }}
    {{ $id = index (strings.Split (strings.TrimPrefix $id "https://www.youtube.com/embed/") "?") 0 }}
  {{ else if strings.Contains $id "/watch?v=" }}
    {{ $id = index (strings.Split (strings.TrimPrefix $id "https://www.youtube.com/watch?v=") "&") 0 }}
  {{ end }}
{{ end }}

{{ if $id }}
  {{/* YouTube iframeåµŒå…¥ä»£ç  */}}
  <div class="youtube-video-wrapper" style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; max-width: 100%; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
    <iframe
      src="https://www.youtube.com/embed/{{ $id }}?rel=0&modestbranding=1{{ if .Get `autoplay` }}&autoplay=1{{ end }}"
      style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; border-radius: 8px;"
      allowfullscreen="true"
      sandbox="allow-top-navigation allow-same-origin allow-forms allow-scripts allow-popups">
    </iframe>
  </div>

  {{/* å¯é€‰çš„è§†é¢‘ä¿¡æ¯æ˜¾ç¤º */}}
  {{ if .Get "title" }}
    <p class="youtube-video-title" style="margin-top: 0.5rem; font-size: 0.9rem; color: #666; text-align: center;">
      ğŸ“º {{ .Get "title" }}
    </p>
  {{ end }}

  {{/* é“¾æ¥åˆ°åŸå§‹è§†é¢‘ */}}
  <p class="youtube-video-link" style="margin-top: 0.25rem; font-size: 0.8rem; color: #999; text-align: center;">
    <a href="https://www.youtube.com/watch?v={{ $id }}" target="_blank" rel="noopener noreferrer" style="color: #ff0000; text-decoration: none;">
      ğŸ”— åœ¨YouTubeè§‚çœ‹å®Œæ•´è§†é¢‘
    </a>
  </p>

{{ else }}
  {{ errorf "youtube shortcode: ç¼ºå°‘è§†é¢‘IDå‚æ•°æˆ–æ— æ•ˆçš„YouTube URL" }}
{{ end }}

<style>
/* å“åº”å¼è§†é¢‘å®¹å™¨ */
@media (max-width: 768px) {
  .youtube-video-wrapper {
    padding-bottom: 75%; /* ç§»åŠ¨ç«¯æ›´å®½çš„çºµæ¨ªæ¯” */
  }
}

/* æš—è‰²æ¨¡å¼æ”¯æŒ */
@media (prefers-color-scheme: dark) {
  .youtube-video-title {
    color: #ccc !important;
  }

  .youtube-video-link {
    color: #aaa !important;
  }

  .youtube-video-link a {
    color: #ff6b6b !important;
  }
}

/* æ‰“å°æ ·å¼ */
@media print {
  .youtube-video-wrapper {
    display: none;
  }

  .youtube-video-title,
  .youtube-video-link {
    display: block;
    background: #f0f0f0;
    padding: 1rem;
    border-radius: 4px;
    font-size: 12pt;
  }
}

/* éšç§å¢å¼ºæ¨¡å¼ - å»¶è¿ŸåŠ è½½ */
.youtube-video-wrapper iframe {
  opacity: 0;
  transition: opacity 0.3s ease;
}

.youtube-video-wrapper iframe.loaded {
  opacity: 1;
}

/* åŠ è½½å ä½ç¬¦ */
.youtube-video-wrapper::before {
  content: "ğŸ¬ åŠ è½½YouTubeè§†é¢‘...";
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  color: #666;
  font-size: 1.1rem;
  z-index: 1;
  pointer-events: none;
}
</style>

<script>
// éšç§å¢å¼ºï¼šå»¶è¿ŸåŠ è½½YouTube iframe
document.addEventListener('DOMContentLoaded', function() {
  const youtubeFrames = document.querySelectorAll('.youtube-video-wrapper iframe');

  // ä½¿ç”¨Intersection Observerå»¶è¿ŸåŠ è½½
  const observer = new IntersectionObserver(function(entries) {
    entries.forEach(function(entry) {
      if (entry.isIntersecting) {
        const iframe = entry.target;
        // iframeå·²ç»è®¾ç½®äº†srcï¼Œè¿™é‡Œåªéœ€è¦æ·»åŠ loadedç±»
        iframe.classList.add('loaded');
        observer.unobserve(iframe);
      }
    });
  }, {
    threshold: 0.1,
    rootMargin: '50px'
  });

  youtubeFrames.forEach(function(iframe) {
    observer.observe(iframe);
  });
});
</script>
