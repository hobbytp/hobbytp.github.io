{{/*
YouTube视频Shortcode

使用方法:
{{< youtube dQw4w9WgXcQ >}}
{{< youtube id="dQw4w9WgXcQ" >}}
{{< youtube id="dQw4w9WgXcQ" title="视频标题" >}}
{{< youtube id="dQw4w9WgXcQ" autoplay="true" >}}
{{< youtube "https://www.youtube.com/watch?v=dQw4w9WgXcQ" >}}
*/}}

{{ $id := .Get 0 }}
{{ if .Get "id" }}
  {{ $id = .Get "id" }}
{{ end }}

{{/* 处理YouTube URL */}}
{{ if strings.HasPrefix $id "https://" }}
  {{/* 从URL中提取视频ID */}}
  {{ $url := urls.Parse $id }}
  {{ if $url.Query.Get "v" }}
    {{ $id = $url.Query.Get "v" }}
  {{ else if strings.Contains $id "/embed/" }}
    {{ $id = index (strings.Split (strings.TrimPrefix $id "https://www.youtube.com/embed/") "?") 0 }}
  {{ else if strings.Contains $id "/watch?v=" }}
    {{ $id = index (strings.Split (strings.TrimPrefix $id "https://www.youtube.com/watch?v=") "&") 0 }}
  {{ end }}
{{ end }}

{{ if $id }}
  {{/* YouTube iframe嵌入代码 */}}
  <div class="youtube-video-wrapper" style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; max-width: 100%; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
    <iframe
      src="https://www.youtube.com/embed/{{ $id }}?rel=0&modestbranding=1{{ if .Get `autoplay` }}&autoplay=1{{ end }}"
      style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; border-radius: 8px;"
      allowfullscreen="true"
      sandbox="allow-top-navigation allow-same-origin allow-forms allow-scripts allow-popups">
    </iframe>
  </div>

  {{/* 可选的视频信息显示 */}}
  {{ if .Get "title" }}
    <p class="youtube-video-title" style="margin-top: 0.5rem; font-size: 0.9rem; color: #666; text-align: center;">
      📺 {{ .Get "title" }}
    </p>
  {{ end }}

  {{/* 链接到原始视频 */}}
  <p class="youtube-video-link" style="margin-top: 0.25rem; font-size: 0.8rem; color: #999; text-align: center;">
    <a href="https://www.youtube.com/watch?v={{ $id }}" target="_blank" rel="noopener noreferrer" style="color: #ff0000; text-decoration: none;">
      🔗 在YouTube观看完整视频
    </a>
  </p>

{{ else }}
  {{ errorf "youtube shortcode: 缺少视频ID参数或无效的YouTube URL" }}
{{ end }}

<style>
/* 响应式视频容器 */
@media (max-width: 768px) {
  .youtube-video-wrapper {
    padding-bottom: 75%; /* 移动端更宽的纵横比 */
  }
}

/* 暗色模式支持 */
@media (prefers-color-scheme: dark) {
  .youtube-video-title {
    color: #ccc !important;
  }

  .youtube-video-link {
    color: #aaa !important;
  }

  .youtube-video-link a {
    color: #ff6b6b !important;
  }
}

/* 打印样式 */
@media print {
  .youtube-video-wrapper {
    display: none;
  }

  .youtube-video-title,
  .youtube-video-link {
    display: block;
    background: #f0f0f0;
    padding: 1rem;
    border-radius: 4px;
    font-size: 12pt;
  }
}

/* 隐私增强模式 - 延迟加载 */
.youtube-video-wrapper iframe {
  opacity: 0;
  transition: opacity 0.3s ease;
}

.youtube-video-wrapper iframe.loaded {
  opacity: 1;
}

/* 加载占位符 */
.youtube-video-wrapper::before {
  content: "🎬 加载YouTube视频...";
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  color: #666;
  font-size: 1.1rem;
  z-index: 1;
  pointer-events: none;
}
</style>

<script>
// 隐私增强：延迟加载YouTube iframe
document.addEventListener('DOMContentLoaded', function() {
  const youtubeFrames = document.querySelectorAll('.youtube-video-wrapper iframe');

  // 使用Intersection Observer延迟加载
  const observer = new IntersectionObserver(function(entries) {
    entries.forEach(function(entry) {
      if (entry.isIntersecting) {
        const iframe = entry.target;
        // iframe已经设置了src，这里只需要添加loaded类
        iframe.classList.add('loaded');
        observer.unobserve(iframe);
      }
    });
  }, {
    threshold: 0.1,
    rootMargin: '50px'
  });

  youtubeFrames.forEach(function(iframe) {
    observer.observe(iframe);
  });
});
</script>
