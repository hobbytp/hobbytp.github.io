{{- $type := .Get "type" | default "overview" -}}
{{- $dataFile := .Get "data" | default "content-analysis-data.json" -}}
{{- $limit := .Get "limit" | default 5 -}}

<!-- å†…å®¹åˆ†æçŸ­ä»£ç  -->
<div class="content-analysis-widget" data-type="{{ $type }}" data-data-file="{{ $dataFile }}" data-limit="{{ $limit }}">
  <div class="analysis-loading">
    <div class="animate-pulse flex space-x-4">
      <div class="rounded-full bg-gray-300 h-10 w-10"></div>
      <div class="flex-1 space-y-2 py-1">
        <div class="h-4 bg-gray-300 rounded w-3/4"></div>
        <div class="h-4 bg-gray-300 rounded w-1/2"></div>
      </div>
    </div>
    <p class="text-sm text-gray-500 mt-2">æ­£åœ¨åŠ è½½åˆ†ææ•°æ®...</p>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const widgets = document.querySelectorAll('.content-analysis-widget');

  widgets.forEach(async function(widget) {
    const type = widget.dataset.type;
    const dataFile = widget.dataset.dataFile;
    const limit = parseInt(widget.dataset.limit);

    try {
      // åŠ è½½åˆ†ææ•°æ®
      const response = await fetch('/' + dataFile);
      if (!response.ok) {
        throw new Error('æ— æ³•åŠ è½½åˆ†ææ•°æ®');
      }

      const data = await response.json();

      // æ ¹æ®ç±»å‹æ¸²æŸ“ä¸åŒå†…å®¹
      let content = '';

      switch(type) {
        case 'overview':
          content = renderOverview(data);
          break;
        case 'stats':
          content = renderStats(data);
          break;
        case 'trends':
          content = renderTrends(data);
          break;
        case 'keywords':
          content = renderKeywords(data, limit);
          break;
        case 'categories':
          content = renderCategories(data, limit);
          break;
        default:
          content = '<p>æœªçŸ¥çš„åˆ†æç±»å‹: ' + type + '</p>';
      }

      widget.innerHTML = content;

    } catch (error) {
      widget.innerHTML = '<div class="text-red-500"><p>åŠ è½½åˆ†ææ•°æ®å¤±è´¥: ' + error.message + '</p><p class="text-sm">è¯·ç¡®ä¿å·²è¿è¡Œ <code>make generate-json-data</code></p></div>';
    }
  });

  function renderOverview(data) {
    const summary = data.summary;
    return `
      <div class="bg-white rounded-lg shadow-md p-6">
        <h3 class="text-lg font-semibold mb-4">ğŸ“Š å†…å®¹æ¦‚è§ˆ</h3>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
          <div class="text-center">
            <div class="text-2xl font-bold text-blue-600">${summary.total_files}</div>
            <div class="text-sm text-gray-600">æ€»æ–‡ç« æ•°</div>
          </div>
          <div class="text-center">
            <div class="text-2xl font-bold text-green-600">${summary.total_words.toLocaleString()}</div>
            <div class="text-sm text-gray-600">æ€»å­—æ•°</div>
          </div>
          <div class="text-center">
            <div class="text-2xl font-bold text-purple-600">${summary.avg_quality_score}/100</div>
            <div class="text-sm text-gray-600">å¹³å‡è´¨é‡</div>
          </div>
          <div class="text-center">
            <div class="text-2xl font-bold text-orange-600">${summary.health_score || 'N/A'}</div>
            <div class="text-sm text-gray-600">å¥åº·åº¦</div>
          </div>
        </div>
      </div>
    `;
  }

  function renderStats(data) {
    const summary = data.summary;
    return `
      <div class="bg-white rounded-lg shadow-md p-6">
        <h3 class="text-lg font-semibold mb-4">ğŸ“ˆ è¯¦ç»†ç»Ÿè®¡</h3>
        <div class="space-y-2">
          <div class="flex justify-between">
            <span>æˆåŠŸåˆ†ææ–‡ä»¶:</span>
            <span class="font-semibold">${summary.analyzed_files}</span>
          </div>
          <div class="flex justify-between">
            <span>å¹³å‡å¯è¯»æ€§:</span>
            <span class="font-semibold">${summary.avg_readability}</span>
          </div>
          <div class="flex justify-between">
            <span>AIå¢å¼º:</span>
            <span class="font-semibold">${data.ai_enhanced ? 'âœ…' : 'âŒ'}</span>
          </div>
          <div class="flex justify-between">
            <span>ç”Ÿæˆæ—¶é—´:</span>
            <span class="font-semibold text-sm">${new Date(data.generated_at).toLocaleString()}</span>
          </div>
        </div>
      </div>
    `;
  }

  function renderTrends(data) {
    if (!data.trends || !data.trends.monthly_creation) {
      return '<div class="bg-white rounded-lg shadow-md p-6"><p class="text-gray-500">æš‚æ— è¶‹åŠ¿æ•°æ®</p></div>';
    }

    const trends = data.trends;
    const recentMonths = Object.entries(trends.monthly_creation).slice(-3);

    return `
      <div class="bg-white rounded-lg shadow-md p-6">
        <h3 class="text-lg font-semibold mb-4">ğŸ“ˆ åˆ›ä½œè¶‹åŠ¿</h3>
        <div class="space-y-2">
          ${recentMonths.map(([month, count]) => `
            <div class="flex justify-between items-center">
              <span>${month}:</span>
              <div class="flex items-center space-x-2">
                <div class="w-16 bg-gray-200 rounded-full h-2">
                  <div class="bg-blue-600 h-2 rounded-full" style="width: ${Math.min(count * 10, 100)}%"></div>
                </div>
                <span class="font-semibold w-8 text-right">${count}</span>
              </div>
            </div>
          `).join('')}
        </div>
      </div>
    `;
  }

  function renderKeywords(data, limit) {
    if (!data.top_keywords || data.top_keywords.length === 0) {
      return '<div class="bg-white rounded-lg shadow-md p-6"><p class="text-gray-500">æš‚æ— å…³é”®è¯æ•°æ®</p></div>';
    }

    const keywords = data.top_keywords.slice(0, limit);

    return `
      <div class="bg-white rounded-lg shadow-md p-6">
        <h3 class="text-lg font-semibold mb-4">ğŸ”¥ çƒ­é—¨å…³é”®è¯</h3>
        <div class="flex flex-wrap gap-2">
          ${keywords.map(([keyword, count]) => `
            <span class="inline-block bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-sm">
              ${keyword} (${count})
            </span>
          `).join('')}
        </div>
      </div>
    `;
  }

  function renderCategories(data, limit) {
    if (!data.distribution || !data.distribution.by_category) {
      return '<div class="bg-white rounded-lg shadow-md p-6"><p class="text-gray-500">æš‚æ— åˆ†ç±»æ•°æ®</p></div>';
    }

    const categories = Object.entries(data.distribution.by_category)
      .sort(([,a], [,b]) => b - a)
      .slice(0, limit);

    return `
      <div class="bg-white rounded-lg shadow-md p-6">
        <h3 class="text-lg font-semibold mb-4">ğŸ“‚ å†…å®¹åˆ†ç±»</h3>
        <div class="space-y-2">
          ${categories.map(([category, count]) => `
            <div class="flex justify-between items-center">
              <span>${category}:</span>
              <span class="font-semibold">${count} ç¯‡</span>
            </div>
          `).join('')}
        </div>
      </div>
    `;
  }
});
</script>
