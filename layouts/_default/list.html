{{ define "main" }}

{{- if (and site.Params.profileMode.enabled .IsHome) }}
{{- partial "index_profile.html" . }}
{{- else }}

<div class="container mx-auto px-8 py-8">
    <header class="mb-8">
        <h1 class="text-4xl font-bold mb-4 text-gray-800">
            {{- if eq .Kind "term" -}}
                {{- $translatedTitle := i18n (lower .Title) -}}
                {{- if ne $translatedTitle (lower .Title) -}}
                    {{- $translatedTitle -}}
                {{- else -}}
                    {{- .Title -}}
                {{- end -}}
            {{- else -}}
                {{- .Title -}}
            {{- end -}}
        </h1>
        {{ with .Content }}
        <div class="prose prose-lg max-w-none mb-8 text-gray-600">
            {{ . }}
        </div>
        {{ end }}
    </header>

    <!-- æœç´¢å’Œç­›é€‰æ  -->
    <div class="mb-8 flex flex-col sm:flex-row gap-4">
        <div class="flex-1">
            <input type="text" id="search-input" placeholder="æœç´¢æ–‡ç« ..." 
                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
        <div class="flex gap-2">
            <select id="sort-select" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                <option value="date-desc">æœ€æ–°ä¼˜å…ˆ</option>
                <option value="date-asc">æœ€æ—§ä¼˜å…ˆ</option>
                <option value="title-asc">æ ‡é¢˜A-Z</option>
                <option value="title-desc">æ ‡é¢˜Z-A</option>
            </select>
        </div>
    </div>

    <!-- æ–‡ç« å¡ç‰‡ç½‘æ ¼ -->
    <div id="articles-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {{ $pages := cond .IsSection .RegularPagesRecursive .Pages }}
        {{ range $pages.ByDate.Reverse }}
        <article class="blog-card bg-white rounded-xl shadow-md overflow-hidden hover:shadow-xl transition-all duration-300 transform hover:-translate-y-2 cursor-pointer" 
                 data-url="{{ .RelPermalink }}"
                 data-title="{{ .Title | lower }}"
                 data-date="{{ .Date.Format "2006-01-02" }}"
                 data-tags="{{ if .Params.tags }}{{ delimit .Params.tags " " | lower }}{{ end }}">
            <!-- æ–‡ç« å°é¢å›¾ç‰‡ -->
            {{ if .Params.featured_image }}
            <div class="h-48 bg-gradient-to-br from-blue-700 to-blue-900 relative overflow-hidden">
                <img src="{{ .Params.featured_image }}" alt="{{ .Title }}" 
                     class="w-full h-full object-cover transition-transform duration-300 hover:scale-105">
                <div class="absolute inset-0 bg-black bg-opacity-20"></div>
            </div>
            {{ else }}
            <div class="h-48 bg-gradient-to-br from-blue-700 to-blue-900 flex items-center justify-center">
                <svg class="w-16 h-16 text-white opacity-90" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
            </div>
            {{ end }}

            <div class="p-6">
                <!-- æ–‡ç« æ ‡é¢˜ -->
                <h2 class="text-xl font-semibold mb-3 text-gray-800 line-clamp-2">
                    {{ .Title }}
                </h2>

                <!-- æ–‡ç« æè¿° -->
                {{ with .Description }}
                <p class="text-gray-600 mb-4 line-clamp-3">{{ . }}</p>
                {{ else }}
                <p class="text-gray-600 mb-4 line-clamp-3">{{ .Summary | truncate 120 }}</p>
                {{ end }}

                <!-- å…ƒä¿¡æ¯ -->
                <div class="flex items-center justify-between text-sm text-gray-500 mb-4">
                    <div class="flex items-center">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        <time>{{ .Date.Format "2006-01-02" }}</time>
                    </div>
                    {{ if .Params.tags }}
                    <div class="flex items-center">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                        </svg>
                        <span>{{ len .Params.tags }} æ ‡ç­¾</span>
                    </div>
                    {{ end }}
                </div>

                <!-- æ ‡ç­¾ -->
                {{ with .Params.tags }}
                <div class="flex flex-wrap gap-2 mb-4">
                    {{ range first 3 . }}
                    <span class="px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded-full">
                        #{{ . }}
                    </span>
                    {{ end }}
                    {{ if gt (len .) 3 }}
                    <span class="px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded-full">
                        +{{ sub (len .) 3 }}
                    </span>
                    {{ end }}
                </div>
                {{ end }}

                <!-- é˜…è¯»æŒ‰é’® -->
                <div class="flex items-center justify-between">
                    <span class="text-sm text-gray-500">
                        {{ if .ReadingTime }}
                        {{ .ReadingTime }} åˆ†é’Ÿé˜…è¯»
                        {{ else }}
                        å¿«é€Ÿé˜…è¯»
                        {{ end }}
                    </span>
                    <div class="flex items-center text-blue-600 hover:text-blue-800 transition-colors">
                        <span class="text-sm font-medium mr-1">é˜…è¯»å…¨æ–‡</span>
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </div>
                </div>
            </div>
        </article>
        {{ end }}
    </div>

    <!-- æ— ç»“æœæç¤º -->
    <div id="no-results" class="hidden text-center py-12">
        <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
        </svg>
        <h3 class="text-lg font-medium text-gray-600 mb-2">æ²¡æœ‰æ‰¾åˆ°ç›¸å…³æ–‡ç« </h3>
        <p class="text-gray-500">å°è¯•è°ƒæ•´æœç´¢æ¡ä»¶æˆ–æµè§ˆå…¶ä»–åˆ†ç±»</p>
    </div>
</div>

<script>
// æ™ºèƒ½æœç´¢åŠŸèƒ½
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('search-input');
    const sortSelect = document.getElementById('sort-select');
    const articlesGrid = document.getElementById('articles-grid');
    const noResults = document.getElementById('no-results');
    const articles = Array.from(document.querySelectorAll('.blog-card'));
    
    let isGlobalSearch = false;
    let globalSearchResults = [];
    let fuse = null;

    // åˆå§‹åŒ–å…¨ç«™æœç´¢
    async function initGlobalSearch() {
        if (fuse) return;
        
        try {
            // åŠ¨æ€åŠ è½½Fuse.js
            if (typeof Fuse === 'undefined') {
                await loadFuseJS();
            }
            
            const res = await fetch('/index.json');
            if (!res.ok) throw new Error('Failed to fetch search index');
            const data = await res.json();
            
            fuse = new Fuse(data, {
                keys: ['title', 'content', 'description', 'tags', 'categories'],
                threshold: 0.3,
                minMatchCharLength: 2,
                useExtendedSearch: true
            });
        } catch (error) {
            console.error('Failed to initialize global search:', error);
        }
    }

    // åŠ è½½Fuse.js
    function loadFuseJS() {
        return new Promise((resolve, reject) => {
            if (typeof Fuse !== 'undefined') {
                resolve();
                return;
            }
            
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/fuse.js@6.6.2';
            script.onload = resolve;
            script.onerror = reject;
            document.head.appendChild(script);
        });
    }

    // æœ¬åœ°æœç´¢
    function localSearch(searchTerm, sortBy) {
        let filtered = articles.filter(article => {
            const title = article.dataset.title;
            const tags = article.dataset.tags;
            return title.toLowerCase().includes(searchTerm) || tags.toLowerCase().includes(searchTerm);
        });

        // æ’åº
        filtered.sort((a, b) => {
            switch(sortBy) {
                case 'date-desc':
                    return new Date(b.dataset.date) - new Date(a.dataset.date);
                case 'date-asc':
                    return new Date(a.dataset.date) - new Date(b.dataset.date);
                case 'title-asc':
                    return a.dataset.title.localeCompare(b.dataset.title);
                case 'title-desc':
                    return b.dataset.title.localeCompare(a.dataset.title);
                default:
                    return 0;
            }
        });

        return filtered;
    }

    // å…¨ç«™æœç´¢
    function globalSearch(searchTerm) {
        if (!fuse) return [];
        
        const results = fuse.search(searchTerm);
        return results.map(({ item }) => ({
            title: item.title,
            permalink: item.permalink,
            description: item.description,
            date: item.date,
            categories: item.categories
        }));
    }

    // åˆ›å»ºæœç´¢ç»“æœå¡ç‰‡
    function createSearchResultCard(item, isGlobal = false) {
        const card = document.createElement('div');
        card.className = 'blog-card bg-white rounded-lg shadow-md hover:shadow-lg transition-shadow duration-300 p-6';
        card.dataset.url = item.permalink;
        
        const date = item.date ? new Date(item.date).toLocaleDateString() : '';
        const categories = item.categories ? item.categories.join(', ') : '';
        
        card.innerHTML = `
            <div class="flex items-start space-x-4">
                <div class="flex-1">
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">
                        <a href="${item.permalink}" class="hover:text-blue-600 transition-colors">
                            ${item.title}
                        </a>
                    </h3>
                    ${item.description ? `<p class="text-gray-600 text-sm mb-3">${item.description}</p>` : ''}
                    <div class="flex items-center text-xs text-gray-500 space-x-4">
                        ${date ? `<span>ğŸ“… ${date}</span>` : ''}
                        ${categories ? `<span>ğŸ·ï¸ ${categories}</span>` : ''}
                        ${isGlobal ? '<span class="text-blue-600">ğŸŒ å…¨ç«™æœç´¢</span>' : ''}
                    </div>
                </div>
            </div>
        `;
        
        return card;
    }

    // æ˜¾ç¤ºæœç´¢ç»“æœ
    function displayResults(results, searchTerm, sortBy) {
        articlesGrid.innerHTML = '';
        
        if (results.length === 0) {
            noResults.classList.remove('hidden');
            noResults.innerHTML = `
                <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                <h3 class="text-lg font-medium text-gray-600 mb-2">æ²¡æœ‰æ‰¾åˆ°ç›¸å…³æ–‡ç« </h3>
                <p class="text-gray-500 mb-4">å°è¯•è°ƒæ•´æœç´¢æ¡ä»¶æˆ–æµè§ˆå…¶ä»–åˆ†ç±»</p>
                ${!isGlobalSearch ? `
                    <button id="expand-search-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                        ğŸ” æœç´¢å…¨ç«™å†…å®¹
                    </button>
                ` : `
                    <button id="back-to-local-btn" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors">
                        â† è¿”å›å½“å‰åˆ†ç±»
                    </button>
                `}
            `;
        } else {
            noResults.classList.add('hidden');
            
            // æ˜¾ç¤ºç»“æœ
            results.forEach(item => {
                const card = createSearchResultCard(item, isGlobalSearch);
                articlesGrid.appendChild(card);
            });
            
            // å¦‚æœæœ¬åœ°æœç´¢ç»“æœå°‘äº3ä¸ªä¸”ä¸æ˜¯å…¨ç«™æœç´¢ï¼Œæ˜¾ç¤ºæ‰©å±•æŒ‰é’®
            if (!isGlobalSearch && results.length < 3 && searchTerm.length > 1) {
                const expandBtn = document.createElement('div');
                expandBtn.className = 'text-center mt-6';
                expandBtn.innerHTML = `
                    <button id="expand-search-btn" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors shadow-md">
                        ğŸ” æŸ¥çœ‹æ›´å¤šç»“æœ (${globalSearchResults.length} ä¸ª)
                    </button>
                `;
                articlesGrid.appendChild(expandBtn);
            }
        }
    }

    // æ‰§è¡Œæœç´¢
    async function performSearch() {
        const searchTerm = searchInput.value.toLowerCase().trim();
        const sortBy = sortSelect.value;
        
        if (!searchTerm) {
            // æ¸…ç©ºæœç´¢ï¼Œæ˜¾ç¤ºæ‰€æœ‰æ–‡ç« 
            isGlobalSearch = false;
            articlesGrid.innerHTML = '';
            articles.forEach(article => {
                articlesGrid.appendChild(article);
            });
            noResults.classList.add('hidden');
            return;
        }

        if (isGlobalSearch) {
            // å…¨ç«™æœç´¢
            await initGlobalSearch();
            const results = globalSearch(searchTerm);
            displayResults(results, searchTerm, sortBy);
        } else {
            // æœ¬åœ°æœç´¢
            const localResults = localSearch(searchTerm, sortBy);
            
            // åŒæ—¶å‡†å¤‡å…¨ç«™æœç´¢ç»“æœ
            await initGlobalSearch();
            globalSearchResults = globalSearch(searchTerm);
            
            displayResults(localResults, searchTerm, sortBy);
        }
    }

    // äº‹ä»¶ç›‘å¬
    searchInput.addEventListener('input', performSearch);
    sortSelect.addEventListener('change', performSearch);
    
    // æ‰©å±•æœç´¢æŒ‰é’®äº‹ä»¶
    document.addEventListener('click', async function(e) {
        if (e.target.id === 'expand-search-btn') {
            isGlobalSearch = true;
            await performSearch();
        } else if (e.target.id === 'back-to-local-btn') {
            isGlobalSearch = false;
            await performSearch();
        }
    });
});
</script>

<style>
.line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
}
</style>

{{- end }}{{/* end profileMode */}}

{{ end }}
