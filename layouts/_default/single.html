{{ define "main" }}

{{- /* Article page with sidebar and sticky TOC layout */ -}}
{{- $tocEnabled := .Param "showToc" | default .Site.Params.ShowToc -}}
{{- $tocContent := .TableOfContents -}}
{{- $hasToc := and $tocEnabled (gt (len (findRE "<li" $tocContent)) 0) -}}
<div class="main-container">
  {{- partial "sidebar.html" . }}
  
  <div class="main-content-with-sidebar">
    <div class="post-layout">
      <article class="post-single">
        <header class="post-header">
          <h1 class="post-title">
            {{ .Title }}
          </h1>
          {{- if not .Params.hideMeta }}
          <div class="post-meta">
            {{- $displayDate := .Date -}}
            {{- if .Params.date -}}
              {{- $displayDate = .Params.date -}}
            {{- end -}}
            {{- if eq (printf "%T" $displayDate) "string" -}}
              {{- $displayDate = $displayDate | time -}}
            {{- end -}}
            <time datetime="{{ $displayDate.Format "2006-01-02T15:04:05Z07:00" }}">{{ $displayDate.Format (or .Site.Params.DateFormat "2006-01-02") }}</time>
            {{- if .Lastmod.After .Date }}
            <span class="post-lastmod">
              &nbsp;·&nbsp;{{ i18n "last_mod" | default "最后更新" }}: {{ .Lastmod.Format (or .Site.Params.DateFormat "2006-01-02") }}
            </span>
            {{- end }}
            {{- with .Params.author }}&nbsp;·&nbsp;{{ . }}{{ end -}}
            {{- if .Params.categories }}&nbsp;·&nbsp;{{ range .Params.categories }}<a href="{{ "/categories/" | relLangURL }}{{ . | urlize }}/">{{ . }}</a>{{ end }}{{ end -}}
            {{- if .Site.Params.ShowReadingTime }}&nbsp;·&nbsp;{{ or .Params.readingTime .ReadingTime }} 分钟{{ end -}}
            {{- if .Site.Params.ShowWordCount }}&nbsp;·&nbsp;{{ or .Params.wordCount .WordCount }} 字{{ end -}}
          </div>
          {{- end }}
        </header>
        
        <div class="post-content">{{ .Content }}</div>
        
        {{- if .Params.tags }}
        <footer class="post-footer">
          <ul class="post-tags">
            {{- range .Params.tags }}
            <li><a href="{{ "/tags/" | relLangURL }}{{ . | urlize }}/">{{ . }}</a></li>
            {{- end }}
          </ul>
        </footer>
        {{- end }}
      </article>

      {{- if $hasToc }}
      <aside class="toc-sidebar" aria-label="{{ i18n "toc" | default "目录" }}">
        <div class="toc-container">
          <div class="toc-title">{{ i18n "toc" | default "目录" }}</div>
          <nav class="toc-nav">
            {{- $tocContent | safeHTML -}}
          </nav>
        </div>
      </aside>
      {{- end }}
    </div>

    {{- if .Site.Params.ShowPostNavLinks }}
    {{- if or .PrevInSection .NextInSection }}
    <nav class="post-nav">
      {{- with .PrevInSection }}
      <a href="{{ .Permalink }}" class="post-nav-prev">
        <span class="nav-prev">{{- i18n "prev_post" | default "« 上一篇" }}</span>
        <br>
        <span>{{ .Title }}</span>
      </a>
      {{- end }}
      {{- with .NextInSection }}
      <a href="{{ .Permalink }}" class="post-nav-next">
        <span class="nav-next">{{- i18n "next_post" | default "下一篇 »" }}</span>
        <br>
        <span>{{ .Title }}</span>
      </a>
      {{- end }}
    </nav>
    {{- end }}
    {{- end }}
  </div>
</div>

{{- if $hasToc }}
<script>
document.addEventListener('DOMContentLoaded', function () {
  const tocLinks = Array.from(document.querySelectorAll('.toc-sidebar a[href^="#"]'));
  if (!tocLinks.length) return;

  const decodeHash = (hash) => decodeURIComponent(hash.replace(/^#/, ''));
  const headingTargets = tocLinks
    .map((link) => {
      const id = decodeHash(link.getAttribute('href'));
      const el = document.getElementById(id);
      return el ? { id, el } : null;
    })
    .filter(Boolean);

  if (!headingTargets.length) return;

  const linkMap = new Map();
  tocLinks.forEach((link) => {
    const id = decodeHash(link.getAttribute('href'));
    linkMap.set(id, link);
  });

  let activeId = null;
  const setActive = (id) => {
    if (!id || id === activeId) return;
    activeId = id;
    tocLinks.forEach((link) => {
      link.classList.remove('is-active');
      if (link.parentElement) {
        link.parentElement.classList.remove('is-active');
      }
    });
    const activeLink = linkMap.get(id);
    if (activeLink) {
      activeLink.classList.add('is-active');
      if (activeLink.parentElement) {
        activeLink.parentElement.classList.add('is-active');
      }
    }
  };

  const headerOffset = 140;
  const updateActive = () => {
    const scrollPosition = window.scrollY + headerOffset;
    let current = headingTargets[0].id;
    for (const { id, el } of headingTargets) {
      if (el.offsetTop <= scrollPosition) {
        current = id;
      } else {
        break;
      }
    }
    setActive(current);
  };

  let ticking = false;
  window.addEventListener('scroll', () => {
    if (!ticking) {
      window.requestAnimationFrame(() => {
        updateActive();
        ticking = false;
      });
      ticking = true;
    }
  }, { passive: true });

  window.addEventListener('resize', updateActive);
  updateActive();

  tocLinks.forEach((link) => {
    link.addEventListener('click', (event) => {
      const id = decodeHash(link.getAttribute('href'));
      const target = document.getElementById(id);
      if (!target) return;
      event.preventDefault();
      window.scrollTo({
        top: target.offsetTop - (headerOffset - 20),
        behavior: 'smooth'
      });
      setActive(id);
      history.replaceState(null, '', '#' + id);
    });
  });
});
</script>
{{- end }}

{{- /* Comments disabled - see config.toml [params.comments] */}}

{{ end }}
