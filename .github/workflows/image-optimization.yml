name: Optimize Images

on:
  push:
    branches:
      - main
    paths:
      - "static/images/**"
      - "!static/images/optimized/**"
      - "!static/images/backup/**"
  workflow_dispatch:
    inputs:
      force_optimize:
        description: 'Force optimize all images'
        required: false
        default: false
        type: boolean
  # Only run on main branch, not on feature branches or PRs

permissions:
  contents: write

defaults:
  run:
    shell: bash

jobs:
  optimize-images:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.MY_GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-image-optimization-${{ hashFiles('tools/image-optimization/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-image-optimization-

      - name: Install dependencies
        run: |
          # Install jq for JSON parsing
          sudo apt-get update && sudo apt-get install -y jq

          # Install Python dependencies
          python -m pip install --upgrade pip
          pip install -r tools/image-optimization/requirements.txt

      - name: Run image optimization
        run: |
          echo "å¼€å§‹å›¾ç‰‡ä¼˜åŒ–..."
          python tools/image-optimization/image_optimizer.py \
            --input-dir static/images \
            --output-dir static/images/optimized \
            --quality 85 \
            --sizes 320 640 960 1280 1920 \
            --no-backup

      - name: Check for changes
        id: verify-changed-files
        run: |
          if [ -n "$(git status --porcelain static/images/optimized/)" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "æ£€æµ‹åˆ°å›¾ç‰‡ä¼˜åŒ–å˜åŒ–"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "æ²¡æœ‰å›¾ç‰‡éœ€è¦ä¼˜åŒ–"
          fi

      - name: Commit optimized images
        if: steps.verify-changed-files.outputs.changed == 'true'
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

          git add static/images/optimized/
          git commit -m "ğŸ”§ ä¼˜åŒ–å›¾ç‰‡: è‡ªåŠ¨ç”ŸæˆWebPæ ¼å¼å’Œå“åº”å¼å°ºå¯¸" -m "ç”Ÿæˆå¤šå°ºå¯¸å›¾ç‰‡ (320px, 640px, 960px, 1280px, 1920px)" -m "è½¬æ¢ä¸ºWebPæ ¼å¼ä»¥å‡å°‘æ–‡ä»¶å¤§å°" -m "åº”ç”¨æ™ºèƒ½å‹ç¼© (è´¨é‡: 85%)" -m "æ­¤æäº¤ç”±GitHub Actionsè‡ªåŠ¨ç”Ÿæˆ [skip ci]"

          echo "å›¾ç‰‡ä¼˜åŒ–å®Œæˆå¹¶æäº¤"

      - name: Push changes
        if: steps.verify-changed-files.outputs.changed == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.MY_GITHUB_TOKEN }}
        run: |
          git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git

          echo "Pushing optimized images to main branch"
          git push origin main
          echo "âœ… å›¾ç‰‡ä¼˜åŒ–å®Œæˆå¹¶æ¨é€åˆ°mainåˆ†æ”¯"
